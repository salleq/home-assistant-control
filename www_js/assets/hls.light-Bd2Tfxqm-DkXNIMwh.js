function yr(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}var Tr={exports:{}};(function(a,t){(function(e){var r=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,s=/^(?=([^\/?#]*))\1([^]*)$/,i=/(?:\/|^)\.(?=\/)/g,n=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,o={buildAbsoluteURL:function(l,h,d){if(d=d||{},l=l.trim(),h=h.trim(),!h){if(!d.alwaysNormalize)return l;var c=o.parseURL(l);if(!c)throw new Error("Error trying to parse base URL.");return c.path=o.normalizePath(c.path),o.buildURLFromParts(c)}var u=o.parseURL(h);if(!u)throw new Error("Error trying to parse relative URL.");if(u.scheme)return d.alwaysNormalize?(u.path=o.normalizePath(u.path),o.buildURLFromParts(u)):h;var f=o.parseURL(l);if(!f)throw new Error("Error trying to parse base URL.");if(!f.netLoc&&f.path&&f.path[0]!=="/"){var g=s.exec(f.path);f.netLoc=g[1],f.path=g[2]}f.netLoc&&!f.path&&(f.path="/");var m={scheme:f.scheme,netLoc:u.netLoc,path:null,params:u.params,query:u.query,fragment:u.fragment};if(!u.netLoc&&(m.netLoc=f.netLoc,u.path[0]!=="/"))if(!u.path)m.path=f.path,u.params||(m.params=f.params,u.query||(m.query=f.query));else{var p=f.path,y=p.substring(0,p.lastIndexOf("/")+1)+u.path;m.path=o.normalizePath(y)}return m.path===null&&(m.path=d.alwaysNormalize?o.normalizePath(u.path):u.path),o.buildURLFromParts(m)},parseURL:function(l){var h=r.exec(l);return h?{scheme:h[1]||"",netLoc:h[2]||"",path:h[3]||"",params:h[4]||"",query:h[5]||"",fragment:h[6]||""}:null},normalizePath:function(l){for(l=l.split("").reverse().join("").replace(i,"");l.length!==(l=l.replace(n,"")).length;);return l.split("").reverse().join("")},buildURLFromParts:function(l){return l.scheme+l.netLoc+l.path+l.params+l.query+l.fragment}};a.exports=o})()})(Tr);var Re=Tr.exports;function Pe(a,t){var e=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);t&&(r=r.filter(function(s){return Object.getOwnPropertyDescriptor(a,s).enumerable})),e.push.apply(e,r)}return e}function at(a){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?Pe(Object(e),!0).forEach(function(r){ls(a,r,e[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(e)):Pe(Object(e)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(e,r))})}return a}function as(a,t){if(typeof a!="object"||!a)return a;var e=a[Symbol.toPrimitive];if(e!==void 0){var r=e.call(a,t||"default");if(typeof r!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(a)}function os(a){var t=as(a,"string");return typeof t=="symbol"?t:String(t)}function ls(a,t,e){return t=os(t),t in a?Object.defineProperty(a,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):a[t]=e,a}function it(){return it=Object.assign?Object.assign.bind():function(a){for(var t=1;t<arguments.length;t++){var e=arguments[t];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(a[r]=e[r])}return a},it.apply(this,arguments)}const M=Number.isFinite||function(a){return typeof a=="number"&&isFinite(a)},hs=Number.isSafeInteger||function(a){return typeof a=="number"&&Math.abs(a)<=ds},ds=Number.MAX_SAFE_INTEGER||9007199254740991;let v=function(a){return a.MEDIA_ATTACHING="hlsMediaAttaching",a.MEDIA_ATTACHED="hlsMediaAttached",a.MEDIA_DETACHING="hlsMediaDetaching",a.MEDIA_DETACHED="hlsMediaDetached",a.BUFFER_RESET="hlsBufferReset",a.BUFFER_CODECS="hlsBufferCodecs",a.BUFFER_CREATED="hlsBufferCreated",a.BUFFER_APPENDING="hlsBufferAppending",a.BUFFER_APPENDED="hlsBufferAppended",a.BUFFER_EOS="hlsBufferEos",a.BUFFER_FLUSHING="hlsBufferFlushing",a.BUFFER_FLUSHED="hlsBufferFlushed",a.MANIFEST_LOADING="hlsManifestLoading",a.MANIFEST_LOADED="hlsManifestLoaded",a.MANIFEST_PARSED="hlsManifestParsed",a.LEVEL_SWITCHING="hlsLevelSwitching",a.LEVEL_SWITCHED="hlsLevelSwitched",a.LEVEL_LOADING="hlsLevelLoading",a.LEVEL_LOADED="hlsLevelLoaded",a.LEVEL_UPDATED="hlsLevelUpdated",a.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",a.LEVELS_UPDATED="hlsLevelsUpdated",a.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",a.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",a.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",a.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",a.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",a.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",a.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",a.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",a.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",a.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",a.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",a.CUES_PARSED="hlsCuesParsed",a.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",a.INIT_PTS_FOUND="hlsInitPtsFound",a.FRAG_LOADING="hlsFragLoading",a.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",a.FRAG_LOADED="hlsFragLoaded",a.FRAG_DECRYPTED="hlsFragDecrypted",a.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",a.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",a.FRAG_PARSING_METADATA="hlsFragParsingMetadata",a.FRAG_PARSED="hlsFragParsed",a.FRAG_BUFFERED="hlsFragBuffered",a.FRAG_CHANGED="hlsFragChanged",a.FPS_DROP="hlsFpsDrop",a.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",a.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",a.ERROR="hlsError",a.DESTROYING="hlsDestroying",a.KEY_LOADING="hlsKeyLoading",a.KEY_LOADED="hlsKeyLoaded",a.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",a.BACK_BUFFER_REACHED="hlsBackBufferReached",a.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",a}({}),G=function(a){return a.NETWORK_ERROR="networkError",a.MEDIA_ERROR="mediaError",a.KEY_SYSTEM_ERROR="keySystemError",a.MUX_ERROR="muxError",a.OTHER_ERROR="otherError",a}({}),b=function(a){return a.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",a.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",a.KEY_SYSTEM_NO_SESSION="keySystemNoSession",a.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",a.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",a.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",a.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",a.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",a.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",a.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",a.MANIFEST_LOAD_ERROR="manifestLoadError",a.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",a.MANIFEST_PARSING_ERROR="manifestParsingError",a.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",a.LEVEL_EMPTY_ERROR="levelEmptyError",a.LEVEL_LOAD_ERROR="levelLoadError",a.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",a.LEVEL_PARSING_ERROR="levelParsingError",a.LEVEL_SWITCH_ERROR="levelSwitchError",a.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",a.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",a.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",a.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",a.FRAG_LOAD_ERROR="fragLoadError",a.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",a.FRAG_DECRYPT_ERROR="fragDecryptError",a.FRAG_PARSING_ERROR="fragParsingError",a.FRAG_GAP="fragGap",a.REMUX_ALLOC_ERROR="remuxAllocError",a.KEY_LOAD_ERROR="keyLoadError",a.KEY_LOAD_TIMEOUT="keyLoadTimeOut",a.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",a.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",a.BUFFER_APPEND_ERROR="bufferAppendError",a.BUFFER_APPENDING_ERROR="bufferAppendingError",a.BUFFER_STALLED_ERROR="bufferStalledError",a.BUFFER_FULL_ERROR="bufferFullError",a.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",a.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",a.INTERNAL_EXCEPTION="internalException",a.INTERNAL_ABORTED="aborted",a.UNKNOWN="unknown",a}({});const Lt=function(){},ve={trace:Lt,debug:Lt,log:Lt,warn:Lt,info:Lt,error:Lt};let wt=ve;function cs(a){const t=self.console[a];return t?t.bind(self.console,`[${a}] >`):Lt}function us(a,...t){t.forEach(function(e){wt[e]=a[e]?a[e].bind(a):cs(e)})}function fs(a,t){if(typeof console=="object"&&a===!0||typeof a=="object"){us(a,"debug","log","info","warn","error");try{wt.log(`Debug logs enabled for "${t}" in hls.js version 1.5.11`)}catch{wt=ve}}else wt=ve}const S=wt,gs=/^(\d+)x(\d+)$/,_e=/(.+?)=(".*?"|.*?)(?:,|$)/g;class Q{constructor(t){typeof t=="string"&&(t=Q.parseAttrList(t)),it(this,t)}get clientAttrs(){return Object.keys(this).filter(t=>t.substring(0,2)==="X-")}decimalInteger(t){const e=parseInt(this[t],10);return e>Number.MAX_SAFE_INTEGER?1/0:e}hexadecimalInteger(t){if(this[t]){let e=(this[t]||"0x").slice(2);e=(e.length&1?"0":"")+e;const r=new Uint8Array(e.length/2);for(let s=0;s<e.length/2;s++)r[s]=parseInt(e.slice(s*2,s*2+2),16);return r}else return null}hexadecimalIntegerAsNumber(t){const e=parseInt(this[t],16);return e>Number.MAX_SAFE_INTEGER?1/0:e}decimalFloatingPoint(t){return parseFloat(this[t])}optionalFloat(t,e){const r=this[t];return r?parseFloat(r):e}enumeratedString(t){return this[t]}bool(t){return this[t]==="YES"}decimalResolution(t){const e=gs.exec(this[t]);if(e!==null)return{width:parseInt(e[1],10),height:parseInt(e[2],10)}}static parseAttrList(t){let e;const r={},s='"';for(_e.lastIndex=0;(e=_e.exec(t))!==null;){let i=e[2];i.indexOf(s)===0&&i.lastIndexOf(s)===i.length-1&&(i=i.slice(1,-1));const n=e[1].trim();r[n]=i}return r}}function ms(a){return a!=="ID"&&a!=="CLASS"&&a!=="START-DATE"&&a!=="DURATION"&&a!=="END-DATE"&&a!=="END-ON-NEXT"}function ps(a){return a==="SCTE35-OUT"||a==="SCTE35-IN"}class Er{constructor(t,e){if(this.attr=void 0,this._startDate=void 0,this._endDate=void 0,this._badValueForSameId=void 0,e){const r=e.attr;for(const s in r)if(Object.prototype.hasOwnProperty.call(t,s)&&t[s]!==r[s]){S.warn(`DATERANGE tag attribute: "${s}" does not match for tags with ID: "${t.ID}"`),this._badValueForSameId=s;break}t=it(new Q({}),r,t)}if(this.attr=t,this._startDate=new Date(t["START-DATE"]),"END-DATE"in this.attr){const r=new Date(this.attr["END-DATE"]);M(r.getTime())&&(this._endDate=r)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get startDate(){return this._startDate}get endDate(){if(this._endDate)return this._endDate;const t=this.duration;return t!==null?new Date(this._startDate.getTime()+t*1e3):null}get duration(){if("DURATION"in this.attr){const t=this.attr.decimalFloatingPoint("DURATION");if(M(t))return t}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isValid(){return!!this.id&&!this._badValueForSameId&&M(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)}}class Jt{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var z={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"};class Lr{constructor(t){this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams={[z.AUDIO]:null,[z.VIDEO]:null,[z.AUDIOVIDEO]:null},this.baseurl=t}setByteRange(t,e){const r=t.split("@",2);let s;r.length===1?s=(e==null?void 0:e.byteRangeEndOffset)||0:s=parseInt(r[1]),this._byteRange=[s,parseInt(r[0])+s]}get byteRange(){return this._byteRange?this._byteRange:[]}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=Re.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(t){this._url=t}}class ee extends Lr{constructor(t,e){super(e),this._decryptdata=null,this.rawProgramDateTime=null,this.programDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.stats=new Jt,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=t}get decryptdata(){const{levelkeys:t}=this;if(!t&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){const e=this.levelkeys.identity;if(e)this._decryptdata=e.getDecryptData(this.sn);else{const r=Object.keys(this.levelkeys);if(r.length===1)return this._decryptdata=this.levelkeys[r[0]].getDecryptData(this.sn)}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(this.programDateTime===null||!M(this.programDateTime))return null;const t=M(this.duration)?this.duration:0;return this.programDateTime+t*1e3}get encrypted(){var t;if((t=this._decryptdata)!=null&&t.encrypted)return!0;if(this.levelkeys){const e=Object.keys(this.levelkeys),r=e.length;if(r>1||r===1&&this.levelkeys[e[0]].encrypted)return!0}return!1}setKeyFormat(t){if(this.levelkeys){const e=this.levelkeys[t];e&&!this._decryptdata&&(this._decryptdata=e.getDecryptData(this.sn))}}abortRequests(){var t,e;(t=this.loader)==null||t.abort(),(e=this.keyLoader)==null||e.abort()}setElementaryStreamInfo(t,e,r,s,i,n=!1){const{elementaryStreams:o}=this,l=o[t];if(!l){o[t]={startPTS:e,endPTS:r,startDTS:s,endDTS:i,partial:n};return}l.startPTS=Math.min(l.startPTS,e),l.endPTS=Math.max(l.endPTS,r),l.startDTS=Math.min(l.startDTS,s),l.endDTS=Math.max(l.endDTS,i)}clearElementaryStreamInfo(){const{elementaryStreams:t}=this;t[z.AUDIO]=null,t[z.VIDEO]=null,t[z.AUDIOVIDEO]=null}}class vs extends Lr{constructor(t,e,r,s,i){super(r),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.stats=new Jt,this.duration=t.decimalFloatingPoint("DURATION"),this.gap=t.bool("GAP"),this.independent=t.bool("INDEPENDENT"),this.relurl=t.enumeratedString("URI"),this.fragment=e,this.index=s;const n=t.enumeratedString("BYTERANGE");n&&this.setByteRange(n,i),i&&(this.fragOffset=i.fragOffset+i.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams:t}=this;return!!(t.audio||t.video||t.audiovideo)}}const ys=10;class Ts{constructor(t){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=t}reloaded(t){if(!t){this.advanced=!0,this.updated=!0;return}const e=this.lastPartSn-t.lastPartSn,r=this.lastPartIndex-t.lastPartIndex;this.updated=this.endSN!==t.endSN||!!r||!!e||!this.live,this.advanced=this.endSN>t.endSN||e>0||e===0&&r>0,this.updated||this.advanced?this.misses=Math.floor(t.misses*.6):this.misses=t.misses+1,this.availabilityDelay=t.availabilityDelay}get hasProgramDateTime(){return this.fragments.length?M(this.fragments[this.fragments.length-1].programDateTime):!1}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||ys}get drift(){const t=this.driftEndTime-this.driftStartTime;return t>0?(this.driftEnd-this.driftStart)*1e3/t:1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var t;return(t=this.partList)!=null&&t.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var t;return(t=this.fragments)!=null&&t.length?this.fragments[this.fragments.length-1].end:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var t;return(t=this.partList)!=null&&t.length?this.partList[this.partList.length-1].index:-1}get lastPartSn(){var t;return(t=this.partList)!=null&&t.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}var Pt={},Es=yr(Pt);function St(a,t,e){return Uint8Array.prototype.slice?a.slice(t,e):new Uint8Array(Array.prototype.slice.call(a,t,e))}const be=(a,t)=>t+10<=a.length&&a[t]===73&&a[t+1]===68&&a[t+2]===51&&a[t+3]<255&&a[t+4]<255&&a[t+6]<128&&a[t+7]<128&&a[t+8]<128&&a[t+9]<128,Sr=(a,t)=>t+10<=a.length&&a[t]===51&&a[t+1]===68&&a[t+2]===73&&a[t+3]<255&&a[t+4]<255&&a[t+6]<128&&a[t+7]<128&&a[t+8]<128&&a[t+9]<128,Ht=(a,t)=>{const e=t;let r=0;for(;be(a,t);){r+=10;const s=Zt(a,t+6);r+=s,Sr(a,t+10)&&(r+=10),t+=r}if(r>0)return a.subarray(e,e+r)},Zt=(a,t)=>{let e=0;return e=(a[t]&127)<<21,e|=(a[t+1]&127)<<14,e|=(a[t+2]&127)<<7,e|=a[t+3]&127,e},Ls=(a,t)=>be(a,t)&&Zt(a,t+6)+10<=a.length-t,Ar=a=>{const t=br(a);for(let e=0;e<t.length;e++){const r=t[e];if(Rr(r))return Is(r)}},Rr=a=>a&&a.key==="PRIV"&&a.info==="com.apple.streaming.transportStreamTimestamp",Ss=a=>{const t=String.fromCharCode(a[0],a[1],a[2],a[3]),e=Zt(a,4),r=10;return{type:t,size:e,data:a.subarray(r,r+e)}},br=a=>{let t=0;const e=[];for(;be(a,t);){const r=Zt(a,t+6);t+=10;const s=t+r;for(;t+8<s;){const i=Ss(a.subarray(t)),n=As(i);n&&e.push(n),t+=i.size+10}Sr(a,t)&&(t+=10)}return e},As=a=>a.type==="PRIV"?Rs(a):a.type[0]==="W"?Ds(a):bs(a),Rs=a=>{if(a.size<2)return;const t=Et(a.data,!0),e=new Uint8Array(a.data.subarray(t.length+1));return{key:a.type,info:t,data:e.buffer}},bs=a=>{if(a.size<2)return;if(a.type==="TXXX"){let e=1;const r=Et(a.data.subarray(e),!0);e+=r.length+1;const s=Et(a.data.subarray(e));return{key:a.type,info:r,data:s}}const t=Et(a.data.subarray(1));return{key:a.type,data:t}},Ds=a=>{if(a.type==="WXXX"){if(a.size<2)return;let e=1;const r=Et(a.data.subarray(e),!0);e+=r.length+1;const s=Et(a.data.subarray(e));return{key:a.type,info:r,data:s}}const t=Et(a.data);return{key:a.type,data:t}},Is=a=>{if(a.data.byteLength===8){const t=new Uint8Array(a.data),e=t[3]&1;let r=(t[4]<<23)+(t[5]<<15)+(t[6]<<7)+t[7];return r/=45,e&&(r+=4772185884e-2),Math.round(r)}},Et=(a,t=!1)=>{const e=ks();if(e){const h=e.decode(a);if(t){const d=h.indexOf("\0");return d!==-1?h.substring(0,d):h}return h.replace(/\0/g,"")}const r=a.length;let s,i,n,o="",l=0;for(;l<r;){if(s=a[l++],s===0&&t)return o;if(!(s===0||s===3))switch(s>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:o+=String.fromCharCode(s);break;case 12:case 13:i=a[l++],o+=String.fromCharCode((s&31)<<6|i&63);break;case 14:i=a[l++],n=a[l++],o+=String.fromCharCode((s&15)<<12|(i&63)<<6|(n&63)<<0);break}}return o};let re;function ks(){if(!navigator.userAgent.includes("PlayStation 4"))return!re&&typeof self.TextDecoder<"u"&&(re=new self.TextDecoder("utf-8")),re}const Fe={hexDump:function(a){let t="";for(let e=0;e<a.length;e++){let r=a[e].toString(16);r.length<2&&(r="0"+r),t+=r}return t}},Vt=Math.pow(2,32)-1,xs=[].push,Dr={video:1,audio:2,id3:3,text:4};function tt(a){return String.fromCharCode.apply(null,a)}function Ir(a,t){const e=a[t]<<8|a[t+1];return e<0?65536+e:e}function B(a,t){const e=kr(a,t);return e<0?4294967296+e:e}function Oe(a,t){let e=B(a,t);return e*=Math.pow(2,32),e+=B(a,t+4),e}function kr(a,t){return a[t]<<24|a[t+1]<<16|a[t+2]<<8|a[t+3]}function se(a,t,e){a[t]=e>>24,a[t+1]=e>>16&255,a[t+2]=e>>8&255,a[t+3]=e&255}function Cs(a){const t=a.byteLength;for(let e=0;e<t;){const r=B(a,e);if(r>8&&a[e+4]===109&&a[e+5]===111&&a[e+6]===111&&a[e+7]===102)return!0;e=r>1?e+r:t}return!1}function $(a,t){const e=[];if(!t.length)return e;const r=a.byteLength;for(let s=0;s<r;){const i=B(a,s),n=tt(a.subarray(s+4,s+8)),o=i>1?s+i:r;if(n===t[0])if(t.length===1)e.push(a.subarray(s+8,o));else{const l=$(a.subarray(s+8,o),t.slice(1));l.length&&xs.apply(e,l)}s=o}return e}function ws(a){const t=[],e=a[0];let r=8;const s=B(a,r);r+=4;let i=0,n=0;e===0?(i=B(a,r),n=B(a,r+4),r+=8):(i=Oe(a,r),n=Oe(a,r+8),r+=16),r+=2;let o=a.length+n;const l=Ir(a,r);r+=2;for(let h=0;h<l;h++){let d=r;const c=B(a,d);d+=4;const u=c&2147483647;if((c&2147483648)>>>31===1)return S.warn("SIDX has hierarchical references (not supported)"),null;const f=B(a,d);d+=4,t.push({referenceSize:u,subsegmentDuration:f,info:{duration:f/s,start:o,end:o+u-1}}),o+=u,d+=4,r=d}return{earliestPresentationTime:i,timescale:s,version:e,referencesCount:l,references:t}}function xr(a){const t=[],e=$(a,["moov","trak"]);for(let r=0;r<e.length;r++){const s=e[r],i=$(s,["tkhd"])[0];if(i){let n=i[0];const o=B(i,n===0?12:20),l=$(s,["mdia","mdhd"])[0];if(l){n=l[0];const h=B(l,n===0?12:20),d=$(s,["mdia","hdlr"])[0];if(d){const c=tt(d.subarray(8,12)),u={soun:z.AUDIO,vide:z.VIDEO}[c];if(u){const f=$(s,["mdia","minf","stbl","stsd"])[0],g=Ps(f);t[o]={timescale:h,type:u},t[u]=at({timescale:h,id:o},g)}}}}}return $(a,["moov","mvex","trex"]).forEach(r=>{const s=B(r,4),i=t[s];i&&(i.default={duration:B(r,12),flags:B(r,20)})}),t}function Ps(a){const t=a.subarray(8),e=t.subarray(86),r=tt(t.subarray(4,8));let s=r;const i=r==="enca"||r==="encv";if(i){const n=$(t,[r])[0].subarray(r==="enca"?28:78);$(n,["sinf"]).forEach(o=>{const l=$(o,["schm"])[0];if(l){const h=tt(l.subarray(4,8));if(h==="cbcs"||h==="cenc"){const d=$(o,["frma"])[0];d&&(s=tt(d))}}})}switch(s){case"avc1":case"avc2":case"avc3":case"avc4":{const n=$(e,["avcC"])[0];s+="."+_t(n[1])+_t(n[2])+_t(n[3]);break}case"mp4a":{const n=$(t,[r])[0],o=$(n.subarray(28),["esds"])[0];if(o&&o.length>12){let l=4;if(o[l++]!==3)break;l=ie(o,l),l+=2;const h=o[l++];if(h&128&&(l+=2),h&64&&(l+=o[l++]),o[l++]!==4)break;l=ie(o,l);const d=o[l++];if(d===64)s+="."+_t(d);else break;if(l+=12,o[l++]!==5)break;l=ie(o,l);const c=o[l++];let u=(c&248)>>3;u===31&&(u+=1+((c&7)<<3)+((o[l]&224)>>5)),s+="."+u}break}case"hvc1":case"hev1":{const n=$(e,["hvcC"])[0],o=n[1],l=["","A","B","C"][o>>6],h=o&31,d=B(n,2),c=(o&32)>>5?"H":"L",u=n[12],f=n.subarray(6,12);s+="."+l+h,s+="."+d.toString(16).toUpperCase(),s+="."+c+u;let g="";for(let m=f.length;m--;){const p=f[m];(p||g)&&(g="."+p.toString(16).toUpperCase()+g)}s+=g;break}case"dvh1":case"dvhe":{const n=$(e,["dvcC"])[0],o=n[2]>>1&127,l=n[2]<<5&32|n[3]>>3&31;s+="."+ut(o)+"."+ut(l);break}case"vp09":{const n=$(e,["vpcC"])[0],o=n[4],l=n[5],h=n[6]>>4&15;s+="."+ut(o)+"."+ut(l)+"."+ut(h);break}case"av01":{const n=$(e,["av1C"])[0],o=n[1]>>>5,l=n[1]&31,h=n[2]>>>7?"H":"M",d=(n[2]&64)>>6,c=(n[2]&32)>>5,u=o===2&&d?c?12:10:d?10:8,f=(n[2]&16)>>4,g=(n[2]&8)>>3,m=(n[2]&4)>>2,p=n[2]&3;s+="."+o+"."+ut(l)+h+"."+ut(u)+"."+f+"."+g+m+p+"."+ut(1)+"."+ut(1)+"."+ut(1)+".0";break}}return{codec:s,encrypted:i}}function ie(a,t){const e=t+5;for(;a[t++]&128&&t<e;);return t}function _t(a){return("0"+a.toString(16).toUpperCase()).slice(-2)}function ut(a){return(a<10?"0":"")+a}function _s(a,t){if(!a||!t)return a;const e=t.keyId;return e&&t.isCommonEncryption&&$(a,["moov","trak"]).forEach(r=>{const s=$(r,["mdia","minf","stbl","stsd"])[0].subarray(8);let i=$(s,["enca"]);const n=i.length>0;n||(i=$(s,["encv"])),i.forEach(o=>{const l=n?o.subarray(28):o.subarray(78);$(l,["sinf"]).forEach(h=>{const d=Fs(h);if(d){const c=d.subarray(8,24);c.some(u=>u!==0)||(S.log(`[eme] Patching keyId in 'enc${n?"a":"v"}>sinf>>tenc' box: ${Fe.hexDump(c)} -> ${Fe.hexDump(e)}`),d.set(e,8))}})})}),a}function Fs(a){const t=$(a,["schm"])[0];if(t){const e=tt(t.subarray(4,8));if(e==="cbcs"||e==="cenc")return $(a,["schi","tenc"])[0]}return S.error("[eme] missing 'schm' box"),null}function Os(a,t){return $(t,["moof","traf"]).reduce((e,r)=>{const s=$(r,["tfdt"])[0],i=s[0],n=$(r,["tfhd"]).reduce((o,l)=>{const h=B(l,4),d=a[h];if(d){let c=B(s,4);if(i===1){if(c===Vt)return S.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"),o;c*=Vt+1,c+=B(s,8)}const u=d.timescale||9e4,f=c/u;if(M(f)&&(o===null||f<o))return f}return o},null);return n!==null&&M(n)&&(e===null||n<e)?n:e},null)}function Ms(a,t){let e=0,r=0,s=0;const i=$(a,["moof","traf"]);for(let n=0;n<i.length;n++){const o=i[n],l=$(o,["tfhd"])[0],h=B(l,4),d=t[h];if(!d)continue;const c=d.default,u=B(l,0)|(c==null?void 0:c.flags);let f=c==null?void 0:c.duration;u&8&&(u&2?f=B(l,12):f=B(l,8));const g=d.timescale||9e4,m=$(o,["trun"]);for(let p=0;p<m.length;p++){if(e=Ns(m[p]),!e&&f){const y=B(m[p],4);e=f*y}d.type===z.VIDEO?r+=e/g:d.type===z.AUDIO&&(s+=e/g)}}if(r===0&&s===0){let n=1/0,o=0,l=0;const h=$(a,["sidx"]);for(let d=0;d<h.length;d++){const c=ws(h[d]);if(c!=null&&c.references){n=Math.min(n,c.earliestPresentationTime/c.timescale);const u=c.references.reduce((f,g)=>f+g.info.duration||0,0);o=Math.max(o,u+c.earliestPresentationTime/c.timescale),l=o-n}}if(l&&M(l))return l}return r||s}function Ns(a){const t=B(a,0);let e=8;t&1&&(e+=4),t&4&&(e+=4);let r=0;const s=B(a,4);for(let i=0;i<s;i++){if(t&256){const n=B(a,e);r+=n,e+=4}t&512&&(e+=4),t&1024&&(e+=4),t&2048&&(e+=4)}return r}function Bs(a,t,e){$(t,["moof","traf"]).forEach(r=>{$(r,["tfhd"]).forEach(s=>{const i=B(s,4),n=a[i];if(!n)return;const o=n.timescale||9e4;$(r,["tfdt"]).forEach(l=>{const h=l[0],d=e*o;if(d){let c=B(l,4);if(h===0)c-=d,c=Math.max(c,0),se(l,4,c);else{c*=Math.pow(2,32),c+=B(l,8),c-=d,c=Math.max(c,0);const u=Math.floor(c/(Vt+1)),f=Math.floor(c%(Vt+1));se(l,4,u),se(l,8,f)}}})})})}function Us(a){const t={valid:null,remainder:null},e=$(a,["moof"]);if(e.length<2)return t.remainder=a,t;const r=e[e.length-1];return t.valid=St(a,0,r.byteOffset-8),t.remainder=St(a,r.byteOffset-8),t}function dt(a,t){const e=new Uint8Array(a.length+t.length);return e.set(a),e.set(t,a.length),e}function Me(a,t){const e=[],r=t.samples,s=t.timescale,i=t.id;let n=!1;return $(r,["moof"]).map(o=>{const l=o.byteOffset-8;$(o,["traf"]).map(h=>{const d=$(h,["tfdt"]).map(c=>{const u=c[0];let f=B(c,4);return u===1&&(f*=Math.pow(2,32),f+=B(c,8)),f/s})[0];return d!==void 0&&(a=d),$(h,["tfhd"]).map(c=>{const u=B(c,4),f=B(c,0)&16777215,g=(f&1)!==0,m=(f&2)!==0,p=(f&8)!==0;let y=0;const T=(f&16)!==0;let A=0;const R=(f&32)!==0;let L=8;u===i&&(g&&(L+=8),m&&(L+=4),p&&(y=B(c,L),L+=4),T&&(A=B(c,L),L+=4),R&&(L+=4),t.type==="video"&&(n=$s(t.codec)),$(h,["trun"]).map(D=>{const I=D[0],C=B(D,0)&16777215,w=(C&1)!==0;let O=0;const x=(C&4)!==0,W=(C&256)!==0;let _=0;const H=(C&512)!==0;let N=0;const V=(C&1024)!==0,k=(C&2048)!==0;let F=0;const q=B(D,4);let U=8;w&&(O=B(D,U),U+=4),x&&(U+=4);let K=O+l;for(let J=0;J<q;J++){if(W?(_=B(D,U),U+=4):_=y,H?(N=B(D,U),U+=4):N=A,V&&(U+=4),k&&(I===0?F=B(D,U):F=kr(D,U),U+=4),t.type===z.VIDEO){let rt=0;for(;rt<N;){const nt=B(r,K);if(K+=4,Gs(n,r[K])){const ct=r.subarray(K,K+nt);Cr(ct,n?2:1,a+F/s,e)}K+=nt,rt+=nt+4}}a+=_/s}}))})})}),e}function $s(a){if(!a)return!1;const t=a.indexOf("."),e=t<0?a:a.substring(0,t);return e==="hvc1"||e==="hev1"||e==="dvh1"||e==="dvhe"}function Gs(a,t){if(a){const e=t>>1&63;return e===39||e===40}else return(t&31)===6}function Cr(a,t,e,r){const s=wr(a);let i=0;i+=t;let n=0,o=0,l=0;for(;i<s.length;){n=0;do{if(i>=s.length)break;l=s[i++],n+=l}while(l===255);o=0;do{if(i>=s.length)break;l=s[i++],o+=l}while(l===255);const h=s.length-i;let d=i;if(o<h)i+=o;else if(o>h){S.error(`Malformed SEI payload. ${o} is too small, only ${h} bytes left to parse.`);break}if(n===4){if(s[d++]===181){const c=Ir(s,d);if(d+=2,c===49){const u=B(s,d);if(d+=4,u===1195456820){const f=s[d++];if(f===3){const g=s[d++],m=31&g,p=64&g,y=p?2+m*3:0,T=new Uint8Array(y);if(p){T[0]=g;for(let A=1;A<y;A++)T[A]=s[d++]}r.push({type:f,payloadType:n,pts:e,bytes:T})}}}}}else if(n===5&&o>16){const c=[];for(let g=0;g<16;g++){const m=s[d++].toString(16);c.push(m.length==1?"0"+m:m),(g===3||g===5||g===7||g===9)&&c.push("-")}const u=o-16,f=new Uint8Array(u);for(let g=0;g<u;g++)f[g]=s[d++];r.push({payloadType:n,pts:e,uuid:c.join(""),userData:Et(f),userDataBytes:f})}}}function wr(a){const t=a.byteLength,e=[];let r=1;for(;r<t-2;)a[r]===0&&a[r+1]===0&&a[r+2]===3?(e.push(r+2),r+=2):r++;if(e.length===0)return a;const s=t-e.length,i=new Uint8Array(s);let n=0;for(r=0;r<s;n++,r++)n===e[0]&&(n++,e.shift()),i[r]=a[n];return i}function Hs(a){const t=a[0];let e="",r="",s=0,i=0,n=0,o=0,l=0,h=0;if(t===0){for(;tt(a.subarray(h,h+1))!=="\0";)e+=tt(a.subarray(h,h+1)),h+=1;for(e+=tt(a.subarray(h,h+1)),h+=1;tt(a.subarray(h,h+1))!=="\0";)r+=tt(a.subarray(h,h+1)),h+=1;r+=tt(a.subarray(h,h+1)),h+=1,s=B(a,12),i=B(a,16),o=B(a,20),l=B(a,24),h=28}else if(t===1){h+=4,s=B(a,h),h+=4;const c=B(a,h);h+=4;const u=B(a,h);for(h+=4,n=2**32*c+u,hs(n)||(n=Number.MAX_SAFE_INTEGER,S.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),o=B(a,h),h+=4,l=B(a,h),h+=4;tt(a.subarray(h,h+1))!=="\0";)e+=tt(a.subarray(h,h+1)),h+=1;for(e+=tt(a.subarray(h,h+1)),h+=1;tt(a.subarray(h,h+1))!=="\0";)r+=tt(a.subarray(h,h+1)),h+=1;r+=tt(a.subarray(h,h+1)),h+=1}const d=a.subarray(h,a.byteLength);return{schemeIdUri:e,value:r,timeScale:s,presentationTime:n,presentationTimeDelta:i,eventDuration:o,id:l,payload:d}}class De{static clearKeyUriToKeyIdMap(){}constructor(t,e,r,s=[1],i=null){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=t,this.uri=e,this.keyFormat=r,this.keyFormatVersions=s,this.iv=i,this.encrypted=t?t!=="NONE":!1,this.isCommonEncryption=this.encrypted&&t!=="AES-128"}isSupported(){if(this.method){if(this.method==="AES-128"||this.method==="NONE")return!0;if(this.keyFormat==="identity")return this.method==="SAMPLE-AES"}return!1}getDecryptData(t){if(!this.encrypted||!this.uri)return null;if(this.method==="AES-128"&&this.uri&&!this.iv){typeof t!="number"&&(this.method==="AES-128"&&!this.iv&&S.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),t=0);const e=Vs(t);return new De(this.method,this.uri,"identity",this.keyFormatVersions,e)}return this}}function Vs(a){const t=new Uint8Array(16);for(let e=12;e<16;e++)t[e]=a>>8*(15-e)&255;return t}function At(a=!0){return typeof self>"u"?void 0:(a||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}function Ks(a){return typeof self<"u"&&a===self.ManagedMediaSource}const Kt={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function Ws(a,t){const e=Kt[t];return!!e&&!!e[a.slice(0,4)]}function ne(a,t,e=!0){return!a.split(",").some(r=>!Pr(r,t,e))}function Pr(a,t,e=!0){var r;const s=At(e);return(r=s==null?void 0:s.isTypeSupported(ye(a,t)))!=null?r:!1}function ye(a,t){return`${t}/mp4;codecs="${a}"`}function Ne(a){if(a){const t=a.substring(0,4);return Kt.video[t]}return 2}function Wt(a){return a.split(",").reduce((t,e)=>{const r=Kt.video[e];return r?(r*2+t)/(t?3:2):(Kt.audio[e]+t)/(t?2:1)},0)}const ae={};function Ys(a,t=!0){if(ae[a])return ae[a];const e={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"]}[a];for(let r=0;r<e.length;r++)if(Pr(e[r],"audio",t))return ae[a]=e[r],e[r];return a}const js=/flac|opus/i;function Yt(a,t=!0){return a.replace(js,e=>Ys(e.toLowerCase(),t))}function Be(a,t){return a&&a!=="mp4a"?a:t&&t.split(",")[0]}function qs(a){const t=a.split(".");if(t.length>2){let e=t.shift()+".";return e+=parseInt(t.shift()).toString(16),e+=("000"+parseInt(t.shift()).toString(16)).slice(-4),e}return a}const Ue=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,$e=/#EXT-X-MEDIA:(.*)/g,zs=/^#EXT(?:INF|-X-TARGETDURATION):/m,Ge=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[^\r\n]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),Xs=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class gt{static findGroup(t,e){for(let r=0;r<t.length;r++){const s=t[r];if(s.id===e)return s}}static resolve(t,e){return Re.buildAbsoluteURL(e,t,{alwaysNormalize:!0})}static isMediaPlaylist(t){return zs.test(t)}static parseMasterPlaylist(t,e){const r={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:!1},s=[];Ue.lastIndex=0;let i;for(;(i=Ue.exec(t))!=null;)if(i[1]){var n;const l=new Q(i[1]),h=i[2],d={attrs:l,bitrate:l.decimalInteger("BANDWIDTH")||l.decimalInteger("AVERAGE-BANDWIDTH"),name:l.NAME,url:gt.resolve(h,e)},c=l.decimalResolution("RESOLUTION");c&&(d.width=c.width,d.height=c.height),Qs(l.CODECS,d),(n=d.unknownCodecs)!=null&&n.length||s.push(d),r.levels.push(d)}else if(i[3]){const l=i[3],h=i[4];switch(l){case"SESSION-DATA":{const d=new Q(h),c=d["DATA-ID"];c&&(r.sessionData===null&&(r.sessionData={}),r.sessionData[c]=d);break}case"SESSION-KEY":{const d=He(h,e);d.encrypted&&d.isSupported()?(r.sessionKeys===null&&(r.sessionKeys=[]),r.sessionKeys.push(d)):S.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${h}"`);break}case"DEFINE":break;case"CONTENT-STEERING":{const d=new Q(h);r.contentSteering={uri:gt.resolve(d["SERVER-URI"],e),pathwayId:d["PATHWAY-ID"]||"."};break}case"START":{r.startTimeOffset=Ve(h);break}}}const o=s.length>0&&s.length<r.levels.length;return r.levels=o?s:r.levels,r.levels.length===0&&(r.playlistParsingError=new Error("no levels found in manifest")),r}static parseMasterPlaylistMedia(t,e,r){let s;const i={},n=r.levels,o={AUDIO:n.map(h=>({id:h.attrs.AUDIO,audioCodec:h.audioCodec})),SUBTITLES:n.map(h=>({id:h.attrs.SUBTITLES,textCodec:h.textCodec})),"CLOSED-CAPTIONS":[]};let l=0;for($e.lastIndex=0;(s=$e.exec(t))!==null;){const h=new Q(s[1]),d=h.TYPE;if(d){const c=o[d],u=i[d]||[];i[d]=u;const f=h.LANGUAGE,g=h["ASSOC-LANGUAGE"],m=h.CHANNELS,p=h.CHARACTERISTICS,y=h["INSTREAM-ID"],T={attrs:h,bitrate:0,id:l++,groupId:h["GROUP-ID"]||"",name:h.NAME||f||"",type:d,default:h.bool("DEFAULT"),autoselect:h.bool("AUTOSELECT"),forced:h.bool("FORCED"),lang:f,url:h.URI?gt.resolve(h.URI,e):""};if(g&&(T.assocLang=g),m&&(T.channels=m),p&&(T.characteristics=p),y&&(T.instreamId=y),c!=null&&c.length){const A=gt.findGroup(c,T.groupId)||c[0];Ke(T,A,"audioCodec"),Ke(T,A,"textCodec")}u.push(T)}}return i}static parseLevelPlaylist(t,e,r,s,i,n){const o=new Ts(e),l=o.fragments;let h=null,d=0,c=0,u=0,f=0,g=null,m=new ee(s,e),p,y,T,A=-1,R=!1,L=null;for(Ge.lastIndex=0,o.m3u8=t,o.hasVariableRefs=!1;(p=Ge.exec(t))!==null;){R&&(R=!1,m=new ee(s,e),m.start=u,m.sn=d,m.cc=f,m.level=r,h&&(m.initSegment=h,m.rawProgramDateTime=h.rawProgramDateTime,h.rawProgramDateTime=null,L&&(m.setByteRange(L),L=null)));const w=p[1];if(w){m.duration=parseFloat(w);const O=(" "+p[2]).slice(1);m.title=O||null,m.tagList.push(O?["INF",w,O]:["INF",w])}else if(p[3]){if(M(m.duration)){m.start=u,T&&je(m,T,o),m.sn=d,m.level=r,m.cc=f,l.push(m);const O=(" "+p[3]).slice(1);m.relurl=O,We(m,g),g=m,u+=m.duration,d++,c=0,R=!0}}else if(p[4]){const O=(" "+p[4]).slice(1);g?m.setByteRange(O,g):m.setByteRange(O)}else if(p[5])m.rawProgramDateTime=(" "+p[5]).slice(1),m.tagList.push(["PROGRAM-DATE-TIME",m.rawProgramDateTime]),A===-1&&(A=l.length);else{if(p=p[0].match(Xs),!p){S.warn("No matches on slow regex match for level playlist!");continue}for(y=1;y<p.length&&!(typeof p[y]<"u");y++);const O=(" "+p[y]).slice(1),x=(" "+p[y+1]).slice(1),W=p[y+2]?(" "+p[y+2]).slice(1):"";switch(O){case"PLAYLIST-TYPE":o.type=x.toUpperCase();break;case"MEDIA-SEQUENCE":d=o.startSN=parseInt(x);break;case"SKIP":{const _=new Q(x),H=_.decimalInteger("SKIPPED-SEGMENTS");if(M(H)){o.skippedSegments=H;for(let V=H;V--;)l.unshift(null);d+=H}const N=_.enumeratedString("RECENTLY-REMOVED-DATERANGES");N&&(o.recentlyRemovedDateranges=N.split("	"));break}case"TARGETDURATION":o.targetduration=Math.max(parseInt(x),1);break;case"VERSION":o.version=parseInt(x);break;case"INDEPENDENT-SEGMENTS":case"EXTM3U":break;case"ENDLIST":o.live=!1;break;case"#":(x||W)&&m.tagList.push(W?[x,W]:[x]);break;case"DISCONTINUITY":f++,m.tagList.push(["DIS"]);break;case"GAP":m.gap=!0,m.tagList.push([O]);break;case"BITRATE":m.tagList.push([O,x]);break;case"DATERANGE":{const _=new Q(x),H=new Er(_,o.dateRanges[_.ID]);H.isValid||o.skippedSegments?o.dateRanges[H.id]=H:S.warn(`Ignoring invalid DATERANGE tag: "${x}"`),m.tagList.push(["EXT-X-DATERANGE",x]);break}case"DEFINE":break;case"DISCONTINUITY-SEQUENCE":f=parseInt(x);break;case"KEY":{const _=He(x,e);if(_.isSupported()){if(_.method==="NONE"){T=void 0;break}T||(T={}),T[_.keyFormat]&&(T=it({},T)),T[_.keyFormat]=_}else S.warn(`[Keys] Ignoring invalid EXT-X-KEY tag: "${x}"`);break}case"START":o.startTimeOffset=Ve(x);break;case"MAP":{const _=new Q(x);if(m.duration){const H=new ee(s,e);Ye(H,_,r,T),h=H,m.initSegment=h,h.rawProgramDateTime&&!m.rawProgramDateTime&&(m.rawProgramDateTime=h.rawProgramDateTime)}else{const H=m.byteRangeEndOffset;if(H){const N=m.byteRangeStartOffset;L=`${H-N}@${N}`}else L=null;Ye(m,_,r,T),h=m,R=!0}break}case"SERVER-CONTROL":{const _=new Q(x);o.canBlockReload=_.bool("CAN-BLOCK-RELOAD"),o.canSkipUntil=_.optionalFloat("CAN-SKIP-UNTIL",0),o.canSkipDateRanges=o.canSkipUntil>0&&_.bool("CAN-SKIP-DATERANGES"),o.partHoldBack=_.optionalFloat("PART-HOLD-BACK",0),o.holdBack=_.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{const _=new Q(x);o.partTarget=_.decimalFloatingPoint("PART-TARGET");break}case"PART":{let _=o.partList;_||(_=o.partList=[]);const H=c>0?_[_.length-1]:void 0,N=c++,V=new Q(x),k=new vs(V,m,e,N,H);_.push(k),m.duration+=k.duration;break}case"PRELOAD-HINT":{const _=new Q(x);o.preloadHint=_;break}case"RENDITION-REPORT":{const _=new Q(x);o.renditionReports=o.renditionReports||[],o.renditionReports.push(_);break}default:S.warn(`line parsed but not handled: ${p}`);break}}}g&&!g.relurl?(l.pop(),u-=g.duration,o.partList&&(o.fragmentHint=g)):o.partList&&(We(m,g),m.cc=f,o.fragmentHint=m,T&&je(m,T,o));const D=l.length,I=l[0],C=l[D-1];if(u+=o.skippedSegments*o.targetduration,u>0&&D&&C){o.averagetargetduration=u/D;const w=C.sn;o.endSN=w!=="initSegment"?w:0,o.live||(C.endList=!0),I&&(o.startCC=I.cc)}else o.endSN=0,o.startCC=0;return o.fragmentHint&&(u+=o.fragmentHint.duration),o.totalduration=u,o.endCC=f,A>0&&Js(l,A),o}}function He(a,t,e){var r,s;const i=new Q(a),n=(r=i.METHOD)!=null?r:"",o=i.URI,l=i.hexadecimalInteger("IV"),h=i.KEYFORMATVERSIONS,d=(s=i.KEYFORMAT)!=null?s:"identity";o&&i.IV&&!l&&S.error(`Invalid IV: ${i.IV}`);const c=o?gt.resolve(o,t):"",u=(h||"1").split("/").map(Number).filter(Number.isFinite);return new De(n,c,d,u,l)}function Ve(a){const t=new Q(a).decimalFloatingPoint("TIME-OFFSET");return M(t)?t:null}function Qs(a,t){let e=(a||"").split(/[ ,]+/).filter(r=>r);["video","audio","text"].forEach(r=>{const s=e.filter(i=>Ws(i,r));s.length&&(t[`${r}Codec`]=s.join(","),e=e.filter(i=>s.indexOf(i)===-1))}),t.unknownCodecs=e}function Ke(a,t,e){const r=t[e];r&&(a[e]=r)}function Js(a,t){let e=a[t];for(let r=t;r--;){const s=a[r];if(!s)return;s.programDateTime=e.programDateTime-s.duration*1e3,e=s}}function We(a,t){a.rawProgramDateTime?a.programDateTime=Date.parse(a.rawProgramDateTime):t!=null&&t.programDateTime&&(a.programDateTime=t.endProgramDateTime),M(a.programDateTime)||(a.programDateTime=null,a.rawProgramDateTime=null)}function Ye(a,t,e,r){a.relurl=t.URI,t.BYTERANGE&&a.setByteRange(t.BYTERANGE),a.level=e,a.sn="initSegment",r&&(a.levelkeys=r),a.initSegment=null}function je(a,t,e){a.levelkeys=t;const{encryptedFragments:r}=e;(!r.length||r[r.length-1].levelkeys!==t)&&Object.keys(t).some(s=>t[s].isCommonEncryption)&&r.push(a)}var Y={MANIFEST:"manifest",LEVEL:"level",AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},j={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};function qe(a){const{type:t}=a;switch(t){case Y.AUDIO_TRACK:return j.AUDIO;case Y.SUBTITLE_TRACK:return j.SUBTITLE;default:return j.MAIN}}function oe(a,t){let e=a.url;return(e===void 0||e.indexOf("data:")===0)&&(e=t.url),e}class Zs{constructor(t){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.hls=t,this.registerListeners()}startLoad(t){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){const{hls:t}=this;t.on(v.MANIFEST_LOADING,this.onManifestLoading,this),t.on(v.LEVEL_LOADING,this.onLevelLoading,this),t.on(v.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),t.on(v.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}unregisterListeners(){const{hls:t}=this;t.off(v.MANIFEST_LOADING,this.onManifestLoading,this),t.off(v.LEVEL_LOADING,this.onLevelLoading,this),t.off(v.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),t.off(v.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}createInternalLoader(t){const e=this.hls.config,r=e.pLoader,s=e.loader,i=r||s,n=new i(e);return this.loaders[t.type]=n,n}getInternalLoader(t){return this.loaders[t.type]}resetInternalLoader(t){this.loaders[t]&&delete this.loaders[t]}destroyInternalLoaders(){for(const t in this.loaders){const e=this.loaders[t];e&&e.destroy(),this.resetInternalLoader(t)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(t,e){const{url:r}=e;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:Y.MANIFEST,url:r,deliveryDirectives:null})}onLevelLoading(t,e){const{id:r,level:s,pathwayId:i,url:n,deliveryDirectives:o}=e;this.load({id:r,level:s,pathwayId:i,responseType:"text",type:Y.LEVEL,url:n,deliveryDirectives:o})}onAudioTrackLoading(t,e){const{id:r,groupId:s,url:i,deliveryDirectives:n}=e;this.load({id:r,groupId:s,level:null,responseType:"text",type:Y.AUDIO_TRACK,url:i,deliveryDirectives:n})}onSubtitleTrackLoading(t,e){const{id:r,groupId:s,url:i,deliveryDirectives:n}=e;this.load({id:r,groupId:s,level:null,responseType:"text",type:Y.SUBTITLE_TRACK,url:i,deliveryDirectives:n})}load(t){var e;const r=this.hls.config;let s=this.getInternalLoader(t);if(s){const h=s.context;if(h&&h.url===t.url&&h.level===t.level){S.trace("[playlist-loader]: playlist request ongoing");return}S.log(`[playlist-loader]: aborting previous loader for type: ${t.type}`),s.abort()}let i;if(t.type===Y.MANIFEST?i=r.manifestLoadPolicy.default:i=it({},r.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),s=this.createInternalLoader(t),M((e=t.deliveryDirectives)==null?void 0:e.part)){let h;if(t.type===Y.LEVEL&&t.level!==null?h=this.hls.levels[t.level].details:t.type===Y.AUDIO_TRACK&&t.id!==null?h=this.hls.audioTracks[t.id].details:t.type===Y.SUBTITLE_TRACK&&t.id!==null&&(h=this.hls.subtitleTracks[t.id].details),h){const d=h.partTarget,c=h.targetduration;if(d&&c){const u=Math.max(d*3,c*.8)*1e3;i=it({},i,{maxTimeToFirstByteMs:Math.min(u,i.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(u,i.maxTimeToFirstByteMs)})}}}const n=i.errorRetry||i.timeoutRetry||{},o={loadPolicy:i,timeout:i.maxLoadTimeMs,maxRetry:n.maxNumRetry||0,retryDelay:n.retryDelayMs||0,maxRetryDelay:n.maxRetryDelayMs||0},l={onSuccess:(h,d,c,u)=>{const f=this.getInternalLoader(c);this.resetInternalLoader(c.type);const g=h.data;if(g.indexOf("#EXTM3U")!==0){this.handleManifestParsingError(h,c,new Error("no EXTM3U delimiter"),u||null,d);return}d.parsing.start=performance.now(),gt.isMediaPlaylist(g)?this.handleTrackOrLevelPlaylist(h,d,c,u||null,f):this.handleMasterPlaylist(h,d,c,u)},onError:(h,d,c,u)=>{this.handleNetworkError(d,c,!1,h,u)},onTimeout:(h,d,c)=>{this.handleNetworkError(d,c,!0,void 0,h)}};s.load(t,o,l)}handleMasterPlaylist(t,e,r,s){const i=this.hls,n=t.data,o=oe(t,r),l=gt.parseMasterPlaylist(n,o);if(l.playlistParsingError){this.handleManifestParsingError(t,r,l.playlistParsingError,s,e);return}const{contentSteering:h,levels:d,sessionData:c,sessionKeys:u,startTimeOffset:f,variableList:g}=l;this.variableList=g;const{AUDIO:m=[],SUBTITLES:p,"CLOSED-CAPTIONS":y}=gt.parseMasterPlaylistMedia(n,o,l);m.length&&!m.some(T=>!T.url)&&d[0].audioCodec&&!d[0].attrs.AUDIO&&(S.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),m.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new Q({}),bitrate:0,url:""})),i.trigger(v.MANIFEST_LOADED,{levels:d,audioTracks:m,subtitles:p,captions:y,contentSteering:h,url:o,stats:e,networkDetails:s,sessionData:c,sessionKeys:u,startTimeOffset:f,variableList:g})}handleTrackOrLevelPlaylist(t,e,r,s,i){const n=this.hls,{id:o,level:l,type:h}=r,d=oe(t,r),c=0,u=M(l)?l:M(o)?o:0,f=qe(r),g=gt.parseLevelPlaylist(t.data,d,u,f,c,this.variableList);if(h===Y.MANIFEST){const m={attrs:new Q({}),bitrate:0,details:g,name:"",url:d};n.trigger(v.MANIFEST_LOADED,{levels:[m],audioTracks:[],url:d,stats:e,networkDetails:s,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}e.parsing.end=performance.now(),r.levelDetails=g,this.handlePlaylistLoaded(g,t,e,r,s,i)}handleManifestParsingError(t,e,r,s,i){this.hls.trigger(v.ERROR,{type:G.NETWORK_ERROR,details:b.MANIFEST_PARSING_ERROR,fatal:e.type===Y.MANIFEST,url:t.url,err:r,error:r,reason:r.message,response:t,context:e,networkDetails:s,stats:i})}handleNetworkError(t,e,r=!1,s,i){let n=`A network ${r?"timeout":"error"+(s?" (status "+s.code+")":"")} occurred while loading ${t.type}`;t.type===Y.LEVEL?n+=`: ${t.level} id: ${t.id}`:(t.type===Y.AUDIO_TRACK||t.type===Y.SUBTITLE_TRACK)&&(n+=` id: ${t.id} group-id: "${t.groupId}"`);const o=new Error(n);S.warn(`[playlist-loader]: ${n}`);let l=b.UNKNOWN,h=!1;const d=this.getInternalLoader(t);switch(t.type){case Y.MANIFEST:l=r?b.MANIFEST_LOAD_TIMEOUT:b.MANIFEST_LOAD_ERROR,h=!0;break;case Y.LEVEL:l=r?b.LEVEL_LOAD_TIMEOUT:b.LEVEL_LOAD_ERROR,h=!1;break;case Y.AUDIO_TRACK:l=r?b.AUDIO_TRACK_LOAD_TIMEOUT:b.AUDIO_TRACK_LOAD_ERROR,h=!1;break;case Y.SUBTITLE_TRACK:l=r?b.SUBTITLE_TRACK_LOAD_TIMEOUT:b.SUBTITLE_LOAD_ERROR,h=!1;break}d&&this.resetInternalLoader(t.type);const c={type:G.NETWORK_ERROR,details:l,fatal:h,url:t.url,loader:d,context:t,error:o,networkDetails:e,stats:i};if(s){const u=(e==null?void 0:e.url)||t.url;c.response=at({url:u,data:void 0},s)}this.hls.trigger(v.ERROR,c)}handlePlaylistLoaded(t,e,r,s,i,n){const o=this.hls,{type:l,level:h,id:d,groupId:c,deliveryDirectives:u}=s,f=oe(e,s),g=qe(s),m=typeof s.level=="number"&&g===j.MAIN?h:void 0;if(!t.fragments.length){const y=new Error("No Segments found in Playlist");o.trigger(v.ERROR,{type:G.NETWORK_ERROR,details:b.LEVEL_EMPTY_ERROR,fatal:!1,url:f,error:y,reason:y.message,response:e,context:s,level:m,parent:g,networkDetails:i,stats:r});return}t.targetduration||(t.playlistParsingError=new Error("Missing Target Duration"));const p=t.playlistParsingError;if(p){o.trigger(v.ERROR,{type:G.NETWORK_ERROR,details:b.LEVEL_PARSING_ERROR,fatal:!1,url:f,error:p,reason:p.message,response:e,context:s,level:m,parent:g,networkDetails:i,stats:r});return}switch(t.live&&n&&(n.getCacheAge&&(t.ageHeader=n.getCacheAge()||0),(!n.getCacheAge||isNaN(t.ageHeader))&&(t.ageHeader=0)),l){case Y.MANIFEST:case Y.LEVEL:o.trigger(v.LEVEL_LOADED,{details:t,level:m||0,id:d||0,stats:r,networkDetails:i,deliveryDirectives:u});break;case Y.AUDIO_TRACK:o.trigger(v.AUDIO_TRACK_LOADED,{details:t,id:d||0,groupId:c||"",stats:r,networkDetails:i,deliveryDirectives:u});break;case Y.SUBTITLE_TRACK:o.trigger(v.SUBTITLE_TRACK_LOADED,{details:t,id:d||0,groupId:c||"",stats:r,networkDetails:i,deliveryDirectives:u});break}}}function ti(a,t){let e;try{e=new Event("addtrack")}catch{e=document.createEvent("Event"),e.initEvent("addtrack",!1,!1)}e.track=a,t.dispatchEvent(e)}function ei(a){const t=a.mode;if(t==="disabled"&&(a.mode="hidden"),a.cues)for(let e=a.cues.length;e--;)a.removeCue(a.cues[e]);t==="disabled"&&(a.mode=t)}function ri(a,t,e,r){const s=a.mode;if(s==="disabled"&&(a.mode="hidden"),a.cues&&a.cues.length>0){const i=ii(a.cues,t,e);for(let n=0;n<i.length;n++)(!r||r(i[n]))&&a.removeCue(i[n])}s==="disabled"&&(a.mode=s)}function si(a,t){if(t<a[0].startTime)return 0;const e=a.length-1;if(t>a[e].endTime)return-1;let r=0,s=e;for(;r<=s;){const i=Math.floor((s+r)/2);if(t<a[i].startTime)s=i-1;else if(t>a[i].startTime&&r<e)r=i+1;else return i}return a[r].startTime-t<t-a[s].startTime?r:s}function ii(a,t,e){const r=[],s=si(a,t);if(s>-1)for(let i=s,n=a.length;i<n;i++){const o=a[i];if(o.startTime>=t&&o.endTime<=e)r.push(o);else if(o.startTime>e)return r}return r}var ht={audioId3:"org.id3",dateRange:"com.apple.quicktime.HLS",emsg:"https://aomedia.org/emsg/ID3"};const ni=.25;function Te(){if(!(typeof self>"u"))return self.VTTCue||self.TextTrackCue}function ze(a,t,e,r,s){let i=new a(t,e,"");try{i.value=r,s&&(i.type=s)}catch{i=new a(t,e,JSON.stringify(s?at({type:s},r):r))}return i}const Ft=(()=>{const a=Te();try{a&&new a(0,Number.POSITIVE_INFINITY,"")}catch{return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();function le(a,t){return a.getTime()/1e3-t}function ai(a){return Uint8Array.from(a.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}class oi{constructor(t){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=t,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=null}_registerListeners(){const{hls:t}=this;t.on(v.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(v.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(v.MANIFEST_LOADING,this.onManifestLoading,this),t.on(v.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),t.on(v.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(v.LEVEL_UPDATED,this.onLevelUpdated,this)}_unregisterListeners(){const{hls:t}=this;t.off(v.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(v.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(v.MANIFEST_LOADING,this.onManifestLoading,this),t.off(v.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),t.off(v.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(v.LEVEL_UPDATED,this.onLevelUpdated,this)}onMediaAttached(t,e){this.media=e.media}onMediaDetaching(){this.id3Track&&(ei(this.id3Track),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(t){const e=this.getID3Track(t.textTracks);return e.mode="hidden",e}getID3Track(t){if(this.media){for(let e=0;e<t.length;e++){const r=t[e];if(r.kind==="metadata"&&r.label==="id3")return ti(r,this.media),r}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(t,e){if(!this.media)return;const{hls:{config:{enableEmsgMetadataCues:r,enableID3MetadataCues:s}}}=this;if(!r&&!s)return;const{samples:i}=e;this.id3Track||(this.id3Track=this.createTrack(this.media));const n=Te();if(n)for(let o=0;o<i.length;o++){const l=i[o].type;if(l===ht.emsg&&!r||!s)continue;const h=br(i[o].data);if(h){const d=i[o].pts;let c=d+i[o].duration;c>Ft&&(c=Ft),c-d<=0&&(c=d+ni);for(let u=0;u<h.length;u++){const f=h[u];if(!Rr(f)){this.updateId3CueEnds(d,l);const g=ze(n,d,c,f,l);g&&this.id3Track.addCue(g)}}}}}updateId3CueEnds(t,e){var r;const s=(r=this.id3Track)==null?void 0:r.cues;if(s)for(let i=s.length;i--;){const n=s[i];n.type===e&&n.startTime<t&&n.endTime===Ft&&(n.endTime=t)}}onBufferFlushing(t,{startOffset:e,endOffset:r,type:s}){const{id3Track:i,hls:n}=this;if(!n)return;const{config:{enableEmsgMetadataCues:o,enableID3MetadataCues:l}}=n;if(i&&(o||l)){let h;s==="audio"?h=d=>d.type===ht.audioId3&&l:s==="video"?h=d=>d.type===ht.emsg&&o:h=d=>d.type===ht.audioId3&&l||d.type===ht.emsg&&o,ri(i,e,r,h)}}onLevelUpdated(t,{details:e}){if(!this.media||!e.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)return;const{dateRangeCuesAppended:r,id3Track:s}=this,{dateRanges:i}=e,n=Object.keys(i);if(s){const d=Object.keys(r).filter(c=>!n.includes(c));for(let c=d.length;c--;){const u=d[c];Object.keys(r[u].cues).forEach(f=>{s.removeCue(r[u].cues[f])}),delete r[u]}}const o=e.fragments[e.fragments.length-1];if(n.length===0||!M(o==null?void 0:o.programDateTime))return;this.id3Track||(this.id3Track=this.createTrack(this.media));const l=o.programDateTime/1e3-o.start,h=Te();for(let d=0;d<n.length;d++){const c=n[d],u=i[c],f=le(u.startDate,l),g=r[c],m=(g==null?void 0:g.cues)||{};let p=(g==null?void 0:g.durationKnown)||!1,y=Ft;const T=u.endDate;if(T)y=le(T,l),p=!0;else if(u.endOnNext&&!p){const R=n.reduce((L,D)=>{if(D!==u.id){const I=i[D];if(I.class===u.class&&I.startDate>u.startDate&&(!L||u.startDate<L.startDate))return I}return L},null);R&&(y=le(R.startDate,l),p=!0)}const A=Object.keys(u.attr);for(let R=0;R<A.length;R++){const L=A[R];if(!ms(L))continue;const D=m[L];if(D)p&&!g.durationKnown&&(D.endTime=y);else if(h){let I=u.attr[L];ps(L)&&(I=ai(I));const C=ze(h,f,y,{key:L,data:I},ht.dateRange);C&&(C.id=c,this.id3Track.addCue(C),m[L]=C)}}r[c]={cues:m,dateRange:u,durationKnown:p}}}}class li{constructor(t){this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=()=>this.timeupdate(),this.hls=t,this.config=t.config,this.registerListeners()}get latency(){return this._latency||0}get maxLatency(){const{config:t,levelDetails:e}=this;return t.liveMaxLatencyDuration!==void 0?t.liveMaxLatencyDuration:e?t.liveMaxLatencyDurationCount*e.targetduration:0}get targetLatency(){const{levelDetails:t}=this;if(t===null)return null;const{holdBack:e,partHoldBack:r,targetduration:s}=t,{liveSyncDuration:i,liveSyncDurationCount:n,lowLatencyMode:o}=this.config,l=this.hls.userConfig;let h=o&&r||e;(l.liveSyncDuration||l.liveSyncDurationCount||h===0)&&(h=i!==void 0?i:n*s);const d=s;return h+Math.min(this.stallCount*1,d)}get liveSyncPosition(){const t=this.estimateLiveEdge(),e=this.targetLatency,r=this.levelDetails;if(t===null||e===null||r===null)return null;const s=r.edge,i=t-e-this.edgeStalled,n=s-r.totalduration,o=s-(this.config.lowLatencyMode&&r.partTarget||r.targetduration);return Math.min(Math.max(n,i),o)}get drift(){const{levelDetails:t}=this;return t===null?1:t.drift}get edgeStalled(){const{levelDetails:t}=this;if(t===null)return 0;const e=(this.config.lowLatencyMode&&t.partTarget||t.targetduration)*3;return Math.max(t.age-e,0)}get forwardBufferLength(){const{media:t,levelDetails:e}=this;if(!t||!e)return 0;const r=t.buffered.length;return(r?t.buffered.end(r-1):e.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null}registerListeners(){this.hls.on(v.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(v.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(v.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(v.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(v.ERROR,this.onError,this)}unregisterListeners(){this.hls.off(v.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(v.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.off(v.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(v.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.off(v.ERROR,this.onError,this)}onMediaAttached(t,e){this.media=e.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)}onManifestLoading(){this.levelDetails=null,this._latency=null,this.stallCount=0}onLevelUpdated(t,{details:e}){this.levelDetails=e,e.advanced&&this.timeupdate(),!e.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)}onError(t,e){var r;e.details===b.BUFFER_STALLED_ERROR&&(this.stallCount++,(r=this.levelDetails)!=null&&r.live&&S.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))}timeupdate(){const{media:t,levelDetails:e}=this;if(!t||!e)return;this.currentTime=t.currentTime;const r=this.computeLatency();if(r===null)return;this._latency=r;const{lowLatencyMode:s,maxLiveSyncPlaybackRate:i}=this.config;if(!s||i===1||!e.live)return;const n=this.targetLatency;if(n===null)return;const o=r-n,l=Math.min(this.maxLatency,n+e.targetduration);if(o<l&&o>.05&&this.forwardBufferLength>1){const h=Math.min(2,Math.max(1,i)),d=Math.round(2/(1+Math.exp(-.75*o-this.edgeStalled))*20)/20;t.playbackRate=Math.min(h,Math.max(1,d))}else t.playbackRate!==1&&t.playbackRate!==0&&(t.playbackRate=1)}estimateLiveEdge(){const{levelDetails:t}=this;return t===null?null:t.edge+t.age}computeLatency(){const t=this.estimateLiveEdge();return t===null?null:t-this.currentTime}}const Ee=["NONE","TYPE-0","TYPE-1",null];function hi(a){return Ee.indexOf(a)>-1}const jt=["SDR","PQ","HLG"];function di(a){return!!a&&jt.indexOf(a)>-1}var Bt={No:"",Yes:"YES",v2:"v2"};function Xe(a){const{canSkipUntil:t,canSkipDateRanges:e,age:r}=a,s=r<t/2;return t&&s?e?Bt.v2:Bt.Yes:Bt.No}class Qe{constructor(t,e,r){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=t,this.part=e,this.skip=r}addDirectives(t){const e=new self.URL(t);return this.msn!==void 0&&e.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&e.searchParams.set("_HLS_part",this.part.toString()),this.skip&&e.searchParams.set("_HLS_skip",this.skip),e.href}}class Le{constructor(t){this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[t.url],this._attrs=[t.attrs],this.bitrate=t.bitrate,t.details&&(this.details=t.details),this.id=t.id||0,this.name=t.name,this.width=t.width||0,this.height=t.height||0,this.frameRate=t.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=t.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=t.audioCodec,this.videoCodec=t.videoCodec,this.codecSet=[t.videoCodec,t.audioCodec].filter(e=>!!e).map(e=>e.substring(0,4)).join(","),this.addGroupId("audio",t.attrs.AUDIO),this.addGroupId("text",t.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(t){return Je(this._audioGroups,t)}hasSubtitleGroup(t){return Je(this._subtitleGroups,t)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(t,e){if(e){if(t==="audio"){let r=this._audioGroups;r||(r=this._audioGroups=[]),r.indexOf(e)===-1&&r.push(e)}else if(t==="text"){let r=this._subtitleGroups;r||(r=this._subtitleGroups=[]),r.indexOf(e)===-1&&r.push(e)}}}get urlId(){return 0}set urlId(t){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var t;return(t=this.audioGroups)==null?void 0:t[0]}get textGroupId(){var t;return(t=this.subtitleGroups)==null?void 0:t[0]}addFallback(){}}function Je(a,t){return!t||!a?!1:a.indexOf(t)!==-1}function he(a,t){const e=t.startPTS;if(M(e)){let r=0,s;t.sn>a.sn?(r=e-a.start,s=a):(r=a.start-e,s=t),s.duration!==r&&(s.duration=r)}else t.sn>a.sn?a.cc===t.cc&&a.minEndPTS?t.start=a.start+(a.minEndPTS-a.start):t.start=a.start+a.duration:t.start=Math.max(a.start-t.duration,0)}function _r(a,t,e,r,s,i){r-e<=0&&(S.warn("Fragment should have a positive duration",t),r=e+t.duration,i=s+t.duration);let n=e,o=r;const l=t.startPTS,h=t.endPTS;if(M(l)){const m=Math.abs(l-e);M(t.deltaPTS)?t.deltaPTS=Math.max(m,t.deltaPTS):t.deltaPTS=m,n=Math.max(e,l),e=Math.min(e,l),s=Math.min(s,t.startDTS),o=Math.min(r,h),r=Math.max(r,h),i=Math.max(i,t.endDTS)}const d=e-t.start;t.start!==0&&(t.start=e),t.duration=r-t.start,t.startPTS=e,t.maxStartPTS=n,t.startDTS=s,t.endPTS=r,t.minEndPTS=o,t.endDTS=i;const c=t.sn;if(!a||c<a.startSN||c>a.endSN)return 0;let u;const f=c-a.startSN,g=a.fragments;for(g[f]=t,u=f;u>0;u--)he(g[u],g[u-1]);for(u=f;u<g.length-1;u++)he(g[u],g[u+1]);return a.fragmentHint&&he(g[g.length-1],a.fragmentHint),a.PTSKnown=a.alignedSliding=!0,d}function ci(a,t){let e=null;const r=a.fragments;for(let l=r.length-1;l>=0;l--){const h=r[l].initSegment;if(h){e=h;break}}a.fragmentHint&&delete a.fragmentHint.endPTS;let s=0,i;if(gi(a,t,(l,h)=>{l.relurl&&(s=l.cc-h.cc),M(l.startPTS)&&M(l.endPTS)&&(h.start=h.startPTS=l.startPTS,h.startDTS=l.startDTS,h.maxStartPTS=l.maxStartPTS,h.endPTS=l.endPTS,h.endDTS=l.endDTS,h.minEndPTS=l.minEndPTS,h.duration=l.endPTS-l.startPTS,h.duration&&(i=h),t.PTSKnown=t.alignedSliding=!0),h.elementaryStreams=l.elementaryStreams,h.loader=l.loader,h.stats=l.stats,l.initSegment&&(h.initSegment=l.initSegment,e=l.initSegment)}),e&&(t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments).forEach(l=>{var h;l&&(!l.initSegment||l.initSegment.relurl===((h=e)==null?void 0:h.relurl))&&(l.initSegment=e)}),t.skippedSegments)if(t.deltaUpdateFailed=t.fragments.some(l=>!l),t.deltaUpdateFailed){S.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let l=t.skippedSegments;l--;)t.fragments.shift();t.startSN=t.fragments[0].sn,t.startCC=t.fragments[0].cc}else t.canSkipDateRanges&&(t.dateRanges=ui(a.dateRanges,t.dateRanges,t.recentlyRemovedDateranges));const n=t.fragments;if(s){S.warn("discontinuity sliding from playlist, take drift into account");for(let l=0;l<n.length;l++)n[l].cc+=s}t.skippedSegments&&(t.startCC=t.fragments[0].cc),fi(a.partList,t.partList,(l,h)=>{h.elementaryStreams=l.elementaryStreams,h.stats=l.stats}),i?_r(t,i,i.startPTS,i.endPTS,i.startDTS,i.endDTS):Fr(a,t),n.length&&(t.totalduration=t.edge-n[0].start),t.driftStartTime=a.driftStartTime,t.driftStart=a.driftStart;const o=t.advancedDateTime;if(t.advanced&&o){const l=t.edge;t.driftStart||(t.driftStartTime=o,t.driftStart=l),t.driftEndTime=o,t.driftEnd=l}else t.driftEndTime=a.driftEndTime,t.driftEnd=a.driftEnd,t.advancedDateTime=a.advancedDateTime}function ui(a,t,e){const r=it({},a);return e&&e.forEach(s=>{delete r[s]}),Object.keys(t).forEach(s=>{const i=new Er(t[s].attr,r[s]);i.isValid?r[s]=i:S.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${JSON.stringify(t[s].attr)}"`)}),r}function fi(a,t,e){if(a&&t){let r=0;for(let s=0,i=a.length;s<=i;s++){const n=a[s],o=t[s+r];n&&o&&n.index===o.index&&n.fragment.sn===o.fragment.sn?e(n,o):r--}}}function gi(a,t,e){const r=t.skippedSegments,s=Math.max(a.startSN,t.startSN)-t.startSN,i=(a.fragmentHint?1:0)+(r?t.endSN:Math.min(a.endSN,t.endSN))-t.startSN,n=t.startSN-a.startSN,o=t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments,l=a.fragmentHint?a.fragments.concat(a.fragmentHint):a.fragments;for(let h=s;h<=i;h++){const d=l[n+h];let c=o[h];r&&!c&&h<r&&(c=t.fragments[h]=d),d&&c&&e(d,c)}}function Fr(a,t){const e=t.startSN+t.skippedSegments-a.startSN,r=a.fragments;e<0||e>=r.length||mi(t,r[e].start)}function mi(a,t){if(t){const e=a.fragments;for(let r=a.skippedSegments;r<e.length;r++)e[r].start+=t;a.fragmentHint&&(a.fragmentHint.start+=t)}}function pi(a,t=1/0){let e=1e3*a.targetduration;if(a.updated){const r=a.fragments;if(r.length&&e*4>t){const s=r[r.length-1].duration*1e3;s<e&&(e=s)}}else e/=2;return Math.round(e)}function vi(a,t,e){if(!(a!=null&&a.details))return null;const r=a.details;let s=r.fragments[t-r.startSN];return s||(s=r.fragmentHint,s&&s.sn===t)?s:t<r.startSN&&e&&e.sn===t?e:null}function Ze(a,t,e){var r;return a!=null&&a.details?Or((r=a.details)==null?void 0:r.partList,t,e):null}function Or(a,t,e){if(a)for(let r=a.length;r--;){const s=a[r];if(s.index===e&&s.fragment.sn===t)return s}return null}function Mr(a){a.forEach((t,e)=>{const{details:r}=t;r!=null&&r.fragments&&r.fragments.forEach(s=>{s.level=e})})}function qt(a){switch(a.details){case b.FRAG_LOAD_TIMEOUT:case b.KEY_LOAD_TIMEOUT:case b.LEVEL_LOAD_TIMEOUT:case b.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function tr(a,t){const e=qt(t);return a.default[`${e?"timeout":"error"}Retry`]}function Ie(a,t){const e=a.backoff==="linear"?1:Math.pow(2,t);return Math.min(e*a.retryDelayMs,a.maxRetryDelayMs)}function er(a){return at(at({},a),{errorRetry:null,timeoutRetry:null})}function zt(a,t,e,r){if(!a)return!1;const s=r==null?void 0:r.code,i=t<a.maxNumRetry&&(yi(s)||!!e);return a.shouldRetry?a.shouldRetry(a,t,e,r,i):i}function yi(a){return a===0&&navigator.onLine===!1||!!a&&(a<400||a>499)}const Nr={search:function(a,t){let e=0,r=a.length-1,s=null,i=null;for(;e<=r;){s=(e+r)/2|0,i=a[s];const n=t(i);if(n>0)e=s+1;else if(n<0)r=s-1;else return i}return null}};function Ti(a,t,e){if(t===null||!Array.isArray(a)||!a.length||!M(t))return null;const r=a[0].programDateTime;if(t<(r||0))return null;const s=a[a.length-1].endProgramDateTime;if(t>=(s||0))return null;e=e||0;for(let i=0;i<a.length;++i){const n=a[i];if(Li(t,e,n))return n}return null}function Br(a,t,e=0,r=0,s=.005){let i=null;if(a){i=t[a.sn-t[0].sn+1]||null;const o=a.endDTS-e;o>0&&o<15e-7&&(e+=15e-7)}else e===0&&t[0].start===0&&(i=t[0]);if(i&&((!a||a.level===i.level)&&rr(e,r,i)===0||Ei(i,a,Math.min(s,r))))return i;const n=Nr.search(t,rr.bind(null,e,r));return n&&(n!==a||!i)?n:i}function Ei(a,t,e){if(t&&t.start===0&&t.level<a.level&&(t.endPTS||0)>0){const r=t.tagList.reduce((s,i)=>(i[0]==="INF"&&(s+=parseFloat(i[1])),s),e);return a.start<=r}return!1}function rr(a=0,t=0,e){if(e.start<=a&&e.start+e.duration>a)return 0;const r=Math.min(t,e.duration+(e.deltaPTS?e.deltaPTS:0));return e.start+e.duration-r<=a?1:e.start-r>a&&e.start?-1:0}function Li(a,t,e){const r=Math.min(t,e.duration+(e.deltaPTS?e.deltaPTS:0))*1e3;return(e.endProgramDateTime||0)-r>a}function Si(a,t){return Nr.search(a,e=>e.cc<t?1:e.cc>t?-1:0)}var et={DoNothing:0,SendEndCallback:1,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,InsertDiscontinuity:4,RetryRequest:5},ot={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2,SwitchToSDR:4};class Ai{constructor(t){this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.log=void 0,this.warn=void 0,this.error=void 0,this.hls=t,this.log=S.log.bind(S,"[info]:"),this.warn=S.warn.bind(S,"[warning]:"),this.error=S.error.bind(S,"[error]:"),this.registerListeners()}registerListeners(){const t=this.hls;t.on(v.ERROR,this.onError,this),t.on(v.MANIFEST_LOADING,this.onManifestLoading,this),t.on(v.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const t=this.hls;t&&(t.off(v.ERROR,this.onError,this),t.off(v.ERROR,this.onErrorOut,this),t.off(v.MANIFEST_LOADING,this.onManifestLoading,this),t.off(v.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(t){}stopLoad(){this.playlistError=0}getVariantLevelIndex(t){return(t==null?void 0:t.type)===j.MAIN?t.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(t,e){var r,s;if(e.fatal)return;const i=this.hls,n=e.context;switch(e.details){case b.FRAG_LOAD_ERROR:case b.FRAG_LOAD_TIMEOUT:case b.KEY_LOAD_ERROR:case b.KEY_LOAD_TIMEOUT:e.errorAction=this.getFragRetryOrSwitchAction(e);return;case b.FRAG_PARSING_ERROR:if((r=e.frag)!=null&&r.gap){e.errorAction={action:et.DoNothing,flags:ot.None};return}case b.FRAG_GAP:case b.FRAG_DECRYPT_ERROR:{e.errorAction=this.getFragRetryOrSwitchAction(e),e.errorAction.action=et.SendAlternateToPenaltyBox;return}case b.LEVEL_EMPTY_ERROR:case b.LEVEL_PARSING_ERROR:{var o,l;const h=e.parent===j.MAIN?e.level:i.loadLevel;e.details===b.LEVEL_EMPTY_ERROR&&(o=e.context)!=null&&(l=o.levelDetails)!=null&&l.live?e.errorAction=this.getPlaylistRetryOrSwitchAction(e,h):(e.levelRetry=!1,e.errorAction=this.getLevelSwitchAction(e,h))}return;case b.LEVEL_LOAD_ERROR:case b.LEVEL_LOAD_TIMEOUT:typeof(n==null?void 0:n.level)=="number"&&(e.errorAction=this.getPlaylistRetryOrSwitchAction(e,n.level));return;case b.AUDIO_TRACK_LOAD_ERROR:case b.AUDIO_TRACK_LOAD_TIMEOUT:case b.SUBTITLE_LOAD_ERROR:case b.SUBTITLE_TRACK_LOAD_TIMEOUT:if(n){const h=i.levels[i.loadLevel];if(h&&(n.type===Y.AUDIO_TRACK&&h.hasAudioGroup(n.groupId)||n.type===Y.SUBTITLE_TRACK&&h.hasSubtitleGroup(n.groupId))){e.errorAction=this.getPlaylistRetryOrSwitchAction(e,i.loadLevel),e.errorAction.action=et.SendAlternateToPenaltyBox,e.errorAction.flags=ot.MoveAllAlternatesMatchingHost;return}}return;case b.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{const h=i.levels[i.loadLevel],d=h==null?void 0:h.attrs["HDCP-LEVEL"];d?e.errorAction={action:et.SendAlternateToPenaltyBox,flags:ot.MoveAllAlternatesMatchingHDCP,hdcpLevel:d}:this.keySystemError(e)}return;case b.BUFFER_ADD_CODEC_ERROR:case b.REMUX_ALLOC_ERROR:case b.BUFFER_APPEND_ERROR:e.errorAction=this.getLevelSwitchAction(e,(s=e.level)!=null?s:i.loadLevel);return;case b.INTERNAL_EXCEPTION:case b.BUFFER_APPENDING_ERROR:case b.BUFFER_FULL_ERROR:case b.LEVEL_SWITCH_ERROR:case b.BUFFER_STALLED_ERROR:case b.BUFFER_SEEK_OVER_HOLE:case b.BUFFER_NUDGE_ON_STALL:e.errorAction={action:et.DoNothing,flags:ot.None};return}e.type===G.KEY_SYSTEM_ERROR&&this.keySystemError(e)}keySystemError(t){const e=this.getVariantLevelIndex(t.frag);t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,e)}getPlaylistRetryOrSwitchAction(t,e){const r=this.hls,s=tr(r.config.playlistLoadPolicy,t),i=this.playlistError++;if(zt(s,i,qt(t),t.response))return{action:et.RetryRequest,flags:ot.None,retryConfig:s,retryCount:i};const n=this.getLevelSwitchAction(t,e);return s&&(n.retryConfig=s,n.retryCount=i),n}getFragRetryOrSwitchAction(t){const e=this.hls,r=this.getVariantLevelIndex(t.frag),s=e.levels[r],{fragLoadPolicy:i,keyLoadPolicy:n}=e.config,o=tr(t.details.startsWith("key")?n:i,t),l=e.levels.reduce((d,c)=>d+c.fragmentError,0);if(s&&(t.details!==b.FRAG_GAP&&s.fragmentError++,zt(o,l,qt(t),t.response)))return{action:et.RetryRequest,flags:ot.None,retryConfig:o,retryCount:l};const h=this.getLevelSwitchAction(t,r);return o&&(h.retryConfig=o,h.retryCount=l),h}getLevelSwitchAction(t,e){const r=this.hls;e==null&&(e=r.loadLevel);const s=this.hls.levels[e];if(s){var i,n;const h=t.details;s.loadError++,h===b.BUFFER_APPEND_ERROR&&s.fragmentError++;let d=-1;const{levels:c,loadLevel:u,minAutoLevel:f,maxAutoLevel:g}=r;r.autoLevelEnabled||(r.loadLevel=-1);const m=(i=t.frag)==null?void 0:i.type,p=(m===j.AUDIO&&h===b.FRAG_PARSING_ERROR||t.sourceBufferName==="audio"&&(h===b.BUFFER_ADD_CODEC_ERROR||h===b.BUFFER_APPEND_ERROR))&&c.some(({audioCodec:R})=>s.audioCodec!==R),y=t.sourceBufferName==="video"&&(h===b.BUFFER_ADD_CODEC_ERROR||h===b.BUFFER_APPEND_ERROR)&&c.some(({codecSet:R,audioCodec:L})=>s.codecSet!==R&&s.audioCodec===L),{type:T,groupId:A}=(n=t.context)!=null?n:{};for(let R=c.length;R--;){const L=(R+u)%c.length;if(L!==u&&L>=f&&L<=g&&c[L].loadError===0){var o,l;const D=c[L];if(h===b.FRAG_GAP&&m===j.MAIN&&t.frag){const I=c[L].details;if(I){const C=Br(t.frag,I.fragments,t.frag.start);if(C!=null&&C.gap)continue}}else if(T===Y.AUDIO_TRACK&&D.hasAudioGroup(A)||T===Y.SUBTITLE_TRACK&&D.hasSubtitleGroup(A)||m===j.AUDIO&&(o=s.audioGroups)!=null&&o.some(I=>D.hasAudioGroup(I))||m===j.SUBTITLE&&(l=s.subtitleGroups)!=null&&l.some(I=>D.hasSubtitleGroup(I))||p&&s.audioCodec===D.audioCodec||!p&&s.audioCodec!==D.audioCodec||y&&s.codecSet===D.codecSet)continue;d=L;break}}if(d>-1&&r.loadLevel!==d)return t.levelRetry=!0,this.playlistError=0,{action:et.SendAlternateToPenaltyBox,flags:ot.None,nextAutoLevel:d}}return{action:et.SendAlternateToPenaltyBox,flags:ot.MoveAllAlternatesMatchingHost}}onErrorOut(t,e){var r;switch((r=e.errorAction)==null?void 0:r.action){case et.DoNothing:break;case et.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(e),!e.errorAction.resolved&&e.details!==b.FRAG_GAP?e.fatal=!0:/MediaSource readyState: ended/.test(e.error.message)&&(this.warn(`MediaSource ended after "${e.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError());break}if(e.fatal){this.hls.stopLoad();return}}sendAlternateToPenaltyBox(t){const e=this.hls,r=t.errorAction;if(!r)return;const{flags:s,hdcpLevel:i,nextAutoLevel:n}=r;switch(s){case ot.None:this.switchLevel(t,n);break;case ot.MoveAllAlternatesMatchingHDCP:i&&(e.maxHdcpLevel=Ee[Ee.indexOf(i)-1],r.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${e.maxHdcpLevel}" or lower`);break}r.resolved||this.switchLevel(t,n)}switchLevel(t,e){e!==void 0&&t.errorAction&&(this.warn(`switching to level ${e} after ${t.details}`),this.hls.nextAutoLevel=e,t.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel)}}class Ri{constructor(t,e){this.hls=void 0,this.timer=-1,this.requestScheduled=-1,this.canLoad=!1,this.log=void 0,this.warn=void 0,this.log=S.log.bind(S,`${e}:`),this.warn=S.warn.bind(S,`${e}:`),this.hls=t}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){this.timer!==-1&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.requestScheduled=-1,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(t,e,r){const s=e==null?void 0:e.renditionReports;if(s){let i=-1;for(let n=0;n<s.length;n++){const o=s[n];let l;try{l=new self.URL(o.URI,e.url).href}catch(h){S.warn(`Could not construct new URL for Rendition Report: ${h}`),l=o.URI||""}if(l===t){i=n;break}else l===t.substring(0,l.length)&&(i=n)}if(i!==-1){const n=s[i],o=parseInt(n["LAST-MSN"])||(e==null?void 0:e.lastPartSn);let l=parseInt(n["LAST-PART"])||(e==null?void 0:e.lastPartIndex);if(this.hls.config.lowLatencyMode){const d=Math.min(e.age-e.partTarget,e.targetduration);l>=0&&d>e.partTarget&&(l+=1)}const h=r&&Xe(r);return new Qe(o,l>=0?l:void 0,h)}}}loadPlaylist(t){this.requestScheduled===-1&&(this.requestScheduled=self.performance.now())}shouldLoadPlaylist(t){return this.canLoad&&!!t&&!!t.url&&(!t.details||t.details.live)}shouldReloadPlaylist(t){return this.timer===-1&&this.requestScheduled===-1&&this.shouldLoadPlaylist(t)}playlistLoaded(t,e,r){const{details:s,stats:i}=e,n=self.performance.now(),o=i.loading.first?Math.max(0,n-i.loading.first):0;if(s.advancedDateTime=Date.now()-o,s.live||r!=null&&r.live){if(s.reloaded(r),r&&this.log(`live playlist ${t} ${s.advanced?"REFRESHED "+s.lastPartSn+"-"+s.lastPartIndex:s.updated?"UPDATED":"MISSED"}`),r&&s.fragments.length>0&&ci(r,s),!this.canLoad||!s.live)return;let l,h,d;if(s.canBlockReload&&s.endSN&&s.advanced){const p=this.hls.config.lowLatencyMode,y=s.lastPartSn,T=s.endSN,A=s.lastPartIndex,R=A!==-1,L=y===T,D=p?0:A;R?(h=L?T+1:y,d=L?D:A+1):h=T+1;const I=s.age,C=I+s.ageHeader;let w=Math.min(C-s.partTarget,s.targetduration*1.5);if(w>0){if(r&&w>r.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${r.tuneInGoal} to: ${w} with playlist age: ${s.age}`),w=0;else{const O=Math.floor(w/s.targetduration);if(h+=O,d!==void 0){const x=Math.round(w%s.targetduration/s.partTarget);d+=x}this.log(`CDN Tune-in age: ${s.ageHeader}s last advanced ${I.toFixed(2)}s goal: ${w} skip sn ${O} to part ${d}`)}s.tuneInGoal=w}if(l=this.getDeliveryDirectives(s,e.deliveryDirectives,h,d),p||!L){this.loadPlaylist(l);return}}else(s.canBlockReload||s.canSkipUntil)&&(l=this.getDeliveryDirectives(s,e.deliveryDirectives,h,d));const c=this.hls.mainForwardBufferInfo,u=c?c.end-c.len:0,f=(s.edge-u)*1e3,g=pi(s,f);s.updated&&n>this.requestScheduled+g&&(this.requestScheduled=i.loading.start),h!==void 0&&s.canBlockReload?this.requestScheduled=i.loading.first+g-(s.partTarget*1e3||1e3):this.requestScheduled===-1||this.requestScheduled+g<n?this.requestScheduled=n:this.requestScheduled-n<=0&&(this.requestScheduled+=g);let m=this.requestScheduled-n;m=Math.max(0,m),this.log(`reload live playlist ${t} in ${Math.round(m)} ms`),this.timer=self.setTimeout(()=>this.loadPlaylist(l),m)}else this.clearTimer()}getDeliveryDirectives(t,e,r,s){let i=Xe(t);return e!=null&&e.skip&&t.deltaUpdateFailed&&(r=e.msn,s=e.part,i=Bt.No),new Qe(r,s,i)}checkRetry(t){const e=t.details,r=qt(t),s=t.errorAction,{action:i,retryCount:n=0,retryConfig:o}=s||{},l=!!s&&!!o&&(i===et.RetryRequest||!s.resolved&&i===et.SendAlternateToPenaltyBox);if(l){var h;if(this.requestScheduled=-1,n>=o.maxNumRetry)return!1;if(r&&(h=t.context)!=null&&h.deliveryDirectives)this.warn(`Retrying playlist loading ${n+1}/${o.maxNumRetry} after "${e}" without delivery-directives`),this.loadPlaylist();else{const d=Ie(o,n);this.timer=self.setTimeout(()=>this.loadPlaylist(),d),this.warn(`Retrying playlist loading ${n+1}/${o.maxNumRetry} after "${e}" in ${d}ms`)}t.levelRetry=!0,s.resolved=!0}return l}}class Rt{constructor(t,e=0,r=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=t,this.alpha_=t?Math.exp(Math.log(.5)/t):0,this.estimate_=e,this.totalWeight_=r}sample(t,e){const r=Math.pow(this.alpha_,t);this.estimate_=e*(1-r)+r*this.estimate_,this.totalWeight_+=t}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const t=1-Math.pow(this.alpha_,this.totalWeight_);if(t)return this.estimate_/t}return this.estimate_}}class bi{constructor(t,e,r,s=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=r,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new Rt(t),this.fast_=new Rt(e),this.defaultTTFB_=s,this.ttfb_=new Rt(t)}update(t,e){const{slow_:r,fast_:s,ttfb_:i}=this;r.halfLife!==t&&(this.slow_=new Rt(t,r.getEstimate(),r.getTotalWeight())),s.halfLife!==e&&(this.fast_=new Rt(e,s.getEstimate(),s.getTotalWeight())),i.halfLife!==t&&(this.ttfb_=new Rt(t,i.getEstimate(),i.getTotalWeight()))}sample(t,e){t=Math.max(t,this.minDelayMs_);const r=8*e,s=t/1e3,i=r/s;this.fast_.sample(s,i),this.slow_.sample(s,i)}sampleTTFB(t){const e=t/1e3,r=Math.sqrt(2)*Math.exp(-Math.pow(e,2)/2);this.ttfb_.sample(r,Math.max(t,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}destroy(){}}function Di(){if(typeof matchMedia=="function"){const a=matchMedia("(dynamic-range: high)"),t=matchMedia("bad query");if(a.media!==t.media)return a.matches===!0}return!1}function Ii(a,t){let e=!1,r=[];return a&&(e=a!=="SDR",r=[a]),t&&(r=t.allowedVideoRanges||jt.slice(0),e=t.preferHDR!==void 0?t.preferHDR:Di(),e?r=r.filter(s=>s!=="SDR"):r=["SDR"]),{preferHDR:e,allowedVideoRanges:r}}function ki(a,t,e,r,s){const i=Object.keys(a),n=r==null?void 0:r.channels,o=r==null?void 0:r.audioCodec,l=n&&parseInt(n)===2;let h=!0,d=!1,c=1/0,u=1/0,f=1/0,g=0,m=[];const{preferHDR:p,allowedVideoRanges:y}=Ii(t,s);for(let R=i.length;R--;){const L=a[i[R]];h=L.channels[2]>0,c=Math.min(c,L.minHeight),u=Math.min(u,L.minFramerate),f=Math.min(f,L.minBitrate);const D=y.filter(I=>L.videoRanges[I]>0);D.length>0&&(d=!0,m=D)}c=M(c)?c:0,u=M(u)?u:0;const T=Math.max(1080,c),A=Math.max(30,u);return f=M(f)?f:e,e=Math.max(f,e),d||(t=void 0,m=[]),{codecSet:i.reduce((R,L)=>{const D=a[L];if(L===R)return R;if(D.minBitrate>e)return mt(L,`min bitrate of ${D.minBitrate} > current estimate of ${e}`),R;if(!D.hasDefaultAudio)return mt(L,"no renditions with default or auto-select sound found"),R;if(o&&L.indexOf(o.substring(0,4))%5!==0)return mt(L,`audio codec preference "${o}" not found`),R;if(n&&!l){if(!D.channels[n])return mt(L,`no renditions with ${n} channel sound found (channels options: ${Object.keys(D.channels)})`),R}else if((!o||l)&&h&&D.channels[2]===0)return mt(L,"no renditions with stereo sound found"),R;return D.minHeight>T?(mt(L,`min resolution of ${D.minHeight} > maximum of ${T}`),R):D.minFramerate>A?(mt(L,`min framerate of ${D.minFramerate} > maximum of ${A}`),R):m.some(I=>D.videoRanges[I]>0)?D.maxScore<g?(mt(L,`max score of ${D.maxScore} < selected max of ${g}`),R):R&&(Wt(L)>=Wt(R)||D.fragmentError>a[R].fragmentError)?R:(g=D.maxScore,L):(mt(L,`no variants with VIDEO-RANGE of ${JSON.stringify(m)} found`),R)},void 0),videoRanges:m,preferHDR:p,minFramerate:u,minBitrate:f}}function mt(a,t){S.log(`[abr] start candidates with "${a}" ignored because ${t}`)}function xi(a){return a.reduce((t,e)=>{let r=t.groups[e.groupId];r||(r=t.groups[e.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),r.tracks.push(e);const s=e.channels||"2";return r.channels[s]=(r.channels[s]||0)+1,r.hasDefault=r.hasDefault||e.default,r.hasAutoSelect=r.hasAutoSelect||e.autoselect,r.hasDefault&&(t.hasDefaultAudio=!0),r.hasAutoSelect&&(t.hasAutoSelectAudio=!0),t},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function Ci(a,t,e,r){return a.slice(e,r+1).reduce((s,i)=>{if(!i.codecSet)return s;const n=i.audioGroups;let o=s[i.codecSet];o||(s[i.codecSet]=o={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!n,fragmentError:0}),o.minBitrate=Math.min(o.minBitrate,i.bitrate);const l=Math.min(i.height,i.width);return o.minHeight=Math.min(o.minHeight,l),o.minFramerate=Math.min(o.minFramerate,i.frameRate),o.maxScore=Math.max(o.maxScore,i.score),o.fragmentError+=i.fragmentError,o.videoRanges[i.videoRange]=(o.videoRanges[i.videoRange]||0)+1,s},{})}class wi{constructor(t){this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this._abandonRulesCheck=()=>{const{fragCurrent:e,partCurrent:r,hls:s}=this,{autoLevelEnabled:i,media:n}=s;if(!e||!n)return;const o=performance.now(),l=r?r.stats:e.stats,h=r?r.duration:e.duration,d=o-l.loading.start,c=s.minAutoLevel;if(l.aborted||l.loaded&&l.loaded===l.total||e.level<=c){this.clearTimer(),this._nextAutoLevel=-1;return}if(!i||n.paused||!n.playbackRate||!n.readyState)return;const u=s.mainForwardBufferInfo;if(u===null)return;const f=this.bwEstimator.getEstimateTTFB(),g=Math.abs(n.playbackRate);if(d<=Math.max(f,1e3*(h/(g*2))))return;const m=u.len/g,p=l.loading.first?l.loading.first-l.loading.start:-1,y=l.loaded&&p>-1,T=this.getBwEstimate(),A=s.levels,R=A[e.level],L=l.total||Math.max(l.loaded,Math.round(h*R.averageBitrate/8));let D=y?d-p:d;D<1&&y&&(D=Math.min(d,l.loaded*8/T));const I=y?l.loaded*1e3/D:0,C=I?(L-l.loaded)/I:L*8/T+f/1e3;if(C<=m)return;const w=I?I*8:T;let O=Number.POSITIVE_INFINITY,x;for(x=e.level-1;x>c;x--){const _=A[x].maxBitrate;if(O=this.getTimeToLoadFrag(f/1e3,w,h*_,!A[x].details),O<m)break}if(O>=C||O>h*10)return;s.nextLoadLevel=s.nextAutoLevel=x,y?this.bwEstimator.sample(d-Math.min(f,p),l.loaded):this.bwEstimator.sampleTTFB(d);const W=A[x].maxBitrate;this.getBwEstimate()*this.hls.config.abrBandWidthUpFactor>W&&this.resetEstimator(W),this.clearTimer(),S.warn(`[abr] Fragment ${e.sn}${r?" part "+r.index:""} of level ${e.level} is loading too slowly;
      Time to underbuffer: ${m.toFixed(3)} s
      Estimated load time for current fragment: ${C.toFixed(3)} s
      Estimated load time for down switch fragment: ${O.toFixed(3)} s
      TTFB estimate: ${p|0} ms
      Current BW estimate: ${M(T)?T|0:"Unknown"} bps
      New BW estimate: ${this.getBwEstimate()|0} bps
      Switching to level ${x} @ ${W|0} bps`),s.trigger(v.FRAG_LOAD_EMERGENCY_ABORTED,{frag:e,part:r,stats:l})},this.hls=t,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(t){t&&(S.log(`setting initial bwe to ${t}`),this.hls.config.abrEwmaDefaultEstimate=t),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){const t=this.hls.config;return new bi(t.abrEwmaSlowVoD,t.abrEwmaFastVoD,t.abrEwmaDefaultEstimate)}registerListeners(){const{hls:t}=this;t.on(v.MANIFEST_LOADING,this.onManifestLoading,this),t.on(v.FRAG_LOADING,this.onFragLoading,this),t.on(v.FRAG_LOADED,this.onFragLoaded,this),t.on(v.FRAG_BUFFERED,this.onFragBuffered,this),t.on(v.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(v.LEVEL_LOADED,this.onLevelLoaded,this),t.on(v.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(v.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),t.on(v.ERROR,this.onError,this)}unregisterListeners(){const{hls:t}=this;t&&(t.off(v.MANIFEST_LOADING,this.onManifestLoading,this),t.off(v.FRAG_LOADING,this.onFragLoading,this),t.off(v.FRAG_LOADED,this.onFragLoaded,this),t.off(v.FRAG_BUFFERED,this.onFragBuffered,this),t.off(v.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(v.LEVEL_LOADED,this.onLevelLoaded,this),t.off(v.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(v.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),t.off(v.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(t,e){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(t,e){const r=e.frag;if(!this.ignoreFragment(r)){if(!r.bitrateTest){var s;this.fragCurrent=r,this.partCurrent=(s=e.part)!=null?s:null}this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(t,e){this.clearTimer()}onError(t,e){if(!e.fatal)switch(e.details){case b.BUFFER_ADD_CODEC_ERROR:case b.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case b.FRAG_LOAD_TIMEOUT:{const r=e.frag,{fragCurrent:s,partCurrent:i}=this;if(r&&s&&r.sn===s.sn&&r.level===s.level){const n=performance.now(),o=i?i.stats:r.stats,l=n-o.loading.start,h=o.loading.first?o.loading.first-o.loading.start:-1;if(o.loaded&&h>-1){const d=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(l-Math.min(d,h),o.loaded)}else this.bwEstimator.sampleTTFB(l)}break}}}getTimeToLoadFrag(t,e,r,s){const i=t+r/e,n=s?this.lastLevelLoadSec:0;return i+n}onLevelLoaded(t,e){const r=this.hls.config,{loading:s}=e.stats,i=s.end-s.start;M(i)&&(this.lastLevelLoadSec=i/1e3),e.details.live?this.bwEstimator.update(r.abrEwmaSlowLive,r.abrEwmaFastLive):this.bwEstimator.update(r.abrEwmaSlowVoD,r.abrEwmaFastVoD)}onFragLoaded(t,{frag:e,part:r}){const s=r?r.stats:e.stats;if(e.type===j.MAIN&&this.bwEstimator.sampleTTFB(s.loading.first-s.loading.start),!this.ignoreFragment(e)){if(this.clearTimer(),e.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){const i=r?r.duration:e.duration,n=this.hls.levels[e.level],o=(n.loaded?n.loaded.bytes:0)+s.loaded,l=(n.loaded?n.loaded.duration:0)+i;n.loaded={bytes:o,duration:l},n.realBitrate=Math.round(8*o/l)}if(e.bitrateTest){const i={stats:s,frag:e,part:r,id:e.type};this.onFragBuffered(v.FRAG_BUFFERED,i),e.bitrateTest=!1}else this.lastLoadedFragLevel=e.level}}onFragBuffered(t,e){const{frag:r,part:s}=e,i=s!=null&&s.stats.loaded?s.stats:r.stats;if(i.aborted||this.ignoreFragment(r))return;const n=i.parsing.end-i.loading.start-Math.min(i.loading.first-i.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(n,i.loaded),i.bwEstimate=this.getBwEstimate(),r.bitrateTest?this.bitrateTestDelay=n/1e3:this.bitrateTestDelay=0}ignoreFragment(t){return t.type!==j.MAIN||t.sn==="initSegment"}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){const{maxAutoLevel:t,minAutoLevel:e}=this.hls,r=this.getBwEstimate(),s=this.hls.config.maxStarvationDelay,i=this.findBestLevel(r,e,t,0,s,1,1);if(i>-1)return i;const n=this.hls.firstLevel,o=Math.min(Math.max(n,e),t);return S.warn(`[abr] Could not find best starting auto level. Defaulting to first in playlist ${n} clamped to ${o}`),o}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){const t=this.forcedAutoLevel,e=this.bwEstimator.canEstimate(),r=this.lastLoadedFragLevel>-1;if(t!==-1&&(!e||!r||this.nextAutoLevelKey===this.getAutoLevelKey()))return t;const s=e&&r?this.getNextABRAutoLevel():this.firstAutoLevel;if(t!==-1){const i=this.hls.levels;if(i.length>Math.max(t,s)&&i[t].loadError<=i[s].loadError)return t}return this._nextAutoLevel=s,this.nextAutoLevelKey=this.getAutoLevelKey(),s}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){const{fragCurrent:t,partCurrent:e,hls:r}=this,{maxAutoLevel:s,config:i,minAutoLevel:n}=r,o=e?e.duration:t?t.duration:0,l=this.getBwEstimate(),h=this.getStarvationDelay();let d=i.abrBandWidthFactor,c=i.abrBandWidthUpFactor;if(h){const p=this.findBestLevel(l,n,s,h,0,d,c);if(p>=0)return p}let u=o?Math.min(o,i.maxStarvationDelay):i.maxStarvationDelay;if(!h){const p=this.bitrateTestDelay;p&&(u=(o?Math.min(o,i.maxLoadingDelay):i.maxLoadingDelay)-p,S.info(`[abr] bitrate test took ${Math.round(1e3*p)}ms, set first fragment max fetchDuration to ${Math.round(1e3*u)} ms`),d=c=1)}const f=this.findBestLevel(l,n,s,h,u,d,c);if(S.info(`[abr] ${h?"rebuffering expected":"buffer is empty"}, optimal quality level ${f}`),f>-1)return f;const g=r.levels[n],m=r.levels[r.loadLevel];return(g==null?void 0:g.bitrate)<(m==null?void 0:m.bitrate)?n:r.loadLevel}getStarvationDelay(){const t=this.hls,e=t.media;if(!e)return 1/0;const r=e&&e.playbackRate!==0?Math.abs(e.playbackRate):1,s=t.mainForwardBufferInfo;return(s?s.len:0)/r}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(t,e,r,s,i,n,o){var l;const h=s+i,d=this.lastLoadedFragLevel,c=d===-1?this.hls.firstLevel:d,{fragCurrent:u,partCurrent:f}=this,{levels:g,allAudioTracks:m,loadLevel:p,config:y}=this.hls;if(g.length===1)return 0;const T=g[c],A=!!(T!=null&&(l=T.details)!=null&&l.live),R=p===-1||d===-1;let L,D="SDR",I=(T==null?void 0:T.frameRate)||0;const{audioPreference:C,videoPreference:w}=y,O=this.audioTracksByGroup||(this.audioTracksByGroup=xi(m));if(R){if(this.firstSelection!==-1)return this.firstSelection;const N=this.codecTiers||(this.codecTiers=Ci(g,O,e,r)),V=ki(N,D,t,C,w),{codecSet:k,videoRanges:F,minFramerate:q,minBitrate:U,preferHDR:K}=V;L=k,D=K?F[F.length-1]:F[0],I=q,t=Math.max(t,U),S.log(`[abr] picked start tier ${JSON.stringify(V)}`)}else L=T==null?void 0:T.codecSet,D=T==null?void 0:T.videoRange;const x=f?f.duration:u?u.duration:0,W=this.bwEstimator.getEstimateTTFB()/1e3,_=[];for(let N=r;N>=e;N--){var H;const V=g[N],k=N>c;if(!V)continue;if(L&&V.codecSet!==L||D&&V.videoRange!==D||k&&I>V.frameRate||!k&&I>0&&I<V.frameRate||V.supportedResult&&!((H=V.supportedResult.decodingInfoResults)!=null&&H[0].smooth)){_.push(N);continue}const F=V.details,q=(f?F==null?void 0:F.partTarget:F==null?void 0:F.averagetargetduration)||x;let U;k?U=o*t:U=n*t;const K=x&&s>=x*2&&i===0?g[N].averageBitrate:g[N].maxBitrate,J=this.getTimeToLoadFrag(W,U,K*q,F===void 0);if(U>=K&&(N===d||V.loadError===0&&V.fragmentError===0)&&(J<=W||!M(J)||A&&!this.bitrateTestDelay||J<h)){const rt=this.forcedAutoLevel;return N!==p&&(rt===-1||rt!==p)&&(_.length&&S.trace(`[abr] Skipped level(s) ${_.join(",")} of ${r} max with CODECS and VIDEO-RANGE:"${g[_[0]].codecs}" ${g[_[0]].videoRange}; not compatible with "${T.codecs}" ${D}`),S.info(`[abr] switch candidate:${c}->${N} adjustedbw(${Math.round(U)})-bitrate=${Math.round(U-K)} ttfb:${W.toFixed(1)} avgDuration:${q.toFixed(1)} maxFetchDuration:${h.toFixed(1)} fetchDuration:${J.toFixed(1)} firstSelection:${R} codecSet:${L} videoRange:${D} hls.loadLevel:${p}`)),R&&(this.firstSelection=N),N}}return-1}set nextAutoLevel(t){const{maxAutoLevel:e,minAutoLevel:r}=this.hls,s=Math.min(Math.max(t,r),e);this._nextAutoLevel!==s&&(this.nextAutoLevelKey="",this._nextAutoLevel=s)}}const Pi={length:0,start:()=>0,end:()=>0};class X{static isBuffered(t,e){try{if(t){const r=X.getBuffered(t);for(let s=0;s<r.length;s++)if(e>=r.start(s)&&e<=r.end(s))return!0}}catch{}return!1}static bufferInfo(t,e,r){try{if(t){const s=X.getBuffered(t),i=[];let n;for(n=0;n<s.length;n++)i.push({start:s.start(n),end:s.end(n)});return this.bufferedInfo(i,e,r)}}catch{}return{len:0,start:e,end:e,nextStart:void 0}}static bufferedInfo(t,e,r){e=Math.max(0,e),t.sort(function(h,d){return h.start-d.start||d.end-h.end});let s=[];if(r)for(let h=0;h<t.length;h++){const d=s.length;if(d){const c=s[d-1].end;t[h].start-c<r?t[h].end>c&&(s[d-1].end=t[h].end):s.push(t[h])}else s.push(t[h])}else s=t;let i=0,n,o=e,l=e;for(let h=0;h<s.length;h++){const d=s[h].start,c=s[h].end;if(e+r>=d&&e<c)o=d,l=c,i=l-e;else if(e+r<d){n=d;break}}return{len:i,start:o||0,end:l||0,nextStart:n}}static getBuffered(t){try{return t.buffered}catch(e){return S.log("failed to get media.buffered",e),Pi}}}class _i{constructor(t){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=t}append(t,e,r){const s=this.queues[e];s.push(t),s.length===1&&!r&&this.executeNext(e)}insertAbort(t,e){this.queues[e].unshift(t),this.executeNext(e)}appendBlocker(t){let e;const r=new Promise(i=>{e=i}),s={execute:e,onStart:()=>{},onComplete:()=>{},onError:()=>{}};return this.append(s,t),r}executeNext(t){const e=this.queues[t];if(e.length){const r=e[0];try{r.execute()}catch(s){S.warn(`[buffer-operation-queue]: Exception executing "${t}" SourceBuffer operation: ${s}`),r.onError(s);const i=this.buffers[t];i!=null&&i.updating||this.shiftAndExecuteNext(t)}}}shiftAndExecuteNext(t){this.queues[t].shift(),this.executeNext(t)}current(t){return this.queues[t][0]}}const sr=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/;class Fi{constructor(t){this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.appendSource=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this.log=void 0,this.warn=void 0,this.error=void 0,this._onEndStreaming=r=>{this.hls&&this.hls.pauseBuffering()},this._onStartStreaming=r=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=()=>{const{media:r,mediaSource:s}=this;this.log("Media source opened"),r&&(r.removeEventListener("emptied",this._onMediaEmptied),this.updateMediaElementDuration(),this.hls.trigger(v.MEDIA_ATTACHED,{media:r,mediaSource:s})),s&&s.removeEventListener("sourceopen",this._onMediaSourceOpen),this.checkPendingTracks()},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{const{mediaSrc:r,_objectUrl:s}=this;r!==s&&S.error(`Media element src was set while attaching MediaSource (${s} > ${r})`)},this.hls=t;const e="[buffer-controller]";this.appendSource=Ks(At(t.config.preferManagedMediaSource)),this.log=S.log.bind(S,e),this.warn=S.warn.bind(S,e),this.error=S.error.bind(S,e),this._initSourceBuffer(),this.registerListeners()}hasSourceTypes(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=null,this.hls=null}registerListeners(){const{hls:t}=this;t.on(v.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(v.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(v.MANIFEST_LOADING,this.onManifestLoading,this),t.on(v.MANIFEST_PARSED,this.onManifestParsed,this),t.on(v.BUFFER_RESET,this.onBufferReset,this),t.on(v.BUFFER_APPENDING,this.onBufferAppending,this),t.on(v.BUFFER_CODECS,this.onBufferCodecs,this),t.on(v.BUFFER_EOS,this.onBufferEos,this),t.on(v.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(v.LEVEL_UPDATED,this.onLevelUpdated,this),t.on(v.FRAG_PARSED,this.onFragParsed,this),t.on(v.FRAG_CHANGED,this.onFragChanged,this)}unregisterListeners(){const{hls:t}=this;t.off(v.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(v.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(v.MANIFEST_LOADING,this.onManifestLoading,this),t.off(v.MANIFEST_PARSED,this.onManifestParsed,this),t.off(v.BUFFER_RESET,this.onBufferReset,this),t.off(v.BUFFER_APPENDING,this.onBufferAppending,this),t.off(v.BUFFER_CODECS,this.onBufferCodecs,this),t.off(v.BUFFER_EOS,this.onBufferEos,this),t.off(v.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(v.LEVEL_UPDATED,this.onLevelUpdated,this),t.off(v.FRAG_PARSED,this.onFragParsed,this),t.off(v.FRAG_CHANGED,this.onFragChanged,this)}_initSourceBuffer(){this.sourceBuffer={},this.operationQueue=new _i(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]},this.appendErrors={audio:0,video:0,audiovideo:0},this.lastMpegAudioChunk=null}onManifestLoading(){this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=0,this.details=null}onManifestParsed(t,e){let r=2;e.audio&&!e.video||e.altAudio,r=1,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=r,this.log(`${this.bufferCodecEventsExpected} bufferCodec event(s) expected`)}onMediaAttaching(t,e){const r=this.media=e.media,s=At(this.appendSource);if(r&&s){var i;const n=this.mediaSource=new s;this.log(`created media source: ${(i=n.constructor)==null?void 0:i.name}`),n.addEventListener("sourceopen",this._onMediaSourceOpen),n.addEventListener("sourceended",this._onMediaSourceEnded),n.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(n.addEventListener("startstreaming",this._onStartStreaming),n.addEventListener("endstreaming",this._onEndStreaming));const o=this._objectUrl=self.URL.createObjectURL(n);if(this.appendSource)try{r.removeAttribute("src");const l=self.ManagedMediaSource;r.disableRemotePlayback=r.disableRemotePlayback||l&&n instanceof l,ir(r),Oi(r,o),r.load()}catch{r.src=o}else r.src=o;r.addEventListener("emptied",this._onMediaEmptied)}}onMediaDetaching(){const{media:t,mediaSource:e,_objectUrl:r}=this;if(e){if(this.log("media source detaching"),e.readyState==="open")try{e.endOfStream()}catch(s){this.warn(`onMediaDetaching: ${s.message} while calling endOfStream`)}this.onBufferReset(),e.removeEventListener("sourceopen",this._onMediaSourceOpen),e.removeEventListener("sourceended",this._onMediaSourceEnded),e.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(e.removeEventListener("startstreaming",this._onStartStreaming),e.removeEventListener("endstreaming",this._onEndStreaming)),t&&(t.removeEventListener("emptied",this._onMediaEmptied),r&&self.URL.revokeObjectURL(r),this.mediaSrc===r?(t.removeAttribute("src"),this.appendSource&&ir(t),t.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(v.MEDIA_DETACHED,void 0)}onBufferReset(){this.getSourceBufferTypes().forEach(t=>{this.resetBuffer(t)}),this._initSourceBuffer()}resetBuffer(t){const e=this.sourceBuffer[t];try{if(e){var r;this.removeBufferListeners(t),this.sourceBuffer[t]=void 0,(r=this.mediaSource)!=null&&r.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(e)}}catch(s){this.warn(`onBufferReset ${t}`,s)}}onBufferCodecs(t,e){const r=this.getSourceBufferTypes().length,s=Object.keys(e);if(s.forEach(n=>{if(r){const l=this.tracks[n];if(l&&typeof l.buffer.changeType=="function"){var o;const{id:h,codec:d,levelCodec:c,container:u,metadata:f}=e[n],g=Be(l.codec,l.levelCodec),m=g==null?void 0:g.replace(sr,"$1");let p=Be(d,c);const y=(o=p)==null?void 0:o.replace(sr,"$1");if(p&&m!==y){n.slice(0,5)==="audio"&&(p=Yt(p,this.appendSource));const T=`${u};codecs=${p}`;this.appendChangeType(n,T),this.log(`switching codec ${g} to ${p}`),this.tracks[n]={buffer:l.buffer,codec:d,container:u,levelCodec:c,metadata:f,id:h}}}}else this.pendingTracks[n]=e[n]}),r)return;const i=Math.max(this.bufferCodecEventsExpected-1,0);this.bufferCodecEventsExpected!==i&&(this.log(`${i} bufferCodec event(s) expected ${s.join(",")}`),this.bufferCodecEventsExpected=i),this.mediaSource&&this.mediaSource.readyState==="open"&&this.checkPendingTracks()}appendChangeType(t,e){const{operationQueue:r}=this,s={execute:()=>{const i=this.sourceBuffer[t];i&&(this.log(`changing ${t} sourceBuffer type to ${e}`),i.changeType(e)),r.shiftAndExecuteNext(t)},onStart:()=>{},onComplete:()=>{},onError:i=>{this.warn(`Failed to change ${t} SourceBuffer type`,i)}};r.append(s,t,!!this.pendingTracks[t])}onBufferAppending(t,e){const{hls:r,operationQueue:s,tracks:i}=this,{data:n,type:o,frag:l,part:h,chunkMeta:d}=e,c=d.buffering[o],u=self.performance.now();c.start=u;const f=l.stats.buffering,g=h?h.stats.buffering:null;f.start===0&&(f.start=u),g&&g.start===0&&(g.start=u);const m=i.audio;let p=!1;o==="audio"&&(m==null?void 0:m.container)==="audio/mpeg"&&(p=!this.lastMpegAudioChunk||d.id===1||this.lastMpegAudioChunk.sn!==d.sn,this.lastMpegAudioChunk=d);const y=l.start,T={execute:()=>{if(c.executeStart=self.performance.now(),p){const A=this.sourceBuffer[o];if(A){const R=y-A.timestampOffset;Math.abs(R)>=.1&&(this.log(`Updating audio SourceBuffer timestampOffset to ${y} (delta: ${R}) sn: ${l.sn})`),A.timestampOffset=y)}}this.appendExecutor(n,o)},onStart:()=>{},onComplete:()=>{const A=self.performance.now();c.executeEnd=c.end=A,f.first===0&&(f.first=A),g&&g.first===0&&(g.first=A);const{sourceBuffer:R}=this,L={};for(const D in R)L[D]=X.getBuffered(R[D]);this.appendErrors[o]=0,o==="audio"||o==="video"?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(v.BUFFER_APPENDED,{type:o,frag:l,part:h,chunkMeta:d,parent:l.type,timeRanges:L})},onError:A=>{const R={type:G.MEDIA_ERROR,parent:l.type,details:b.BUFFER_APPEND_ERROR,sourceBufferName:o,frag:l,part:h,chunkMeta:d,error:A,err:A,fatal:!1};if(A.code===DOMException.QUOTA_EXCEEDED_ERR)R.details=b.BUFFER_FULL_ERROR;else{const L=++this.appendErrors[o];R.details=b.BUFFER_APPEND_ERROR,this.warn(`Failed ${L}/${r.config.appendErrorMaxRetry} times to append segment in "${o}" sourceBuffer`),L>=r.config.appendErrorMaxRetry&&(R.fatal=!0)}r.trigger(v.ERROR,R)}};s.append(T,o,!!this.pendingTracks[o])}onBufferFlushing(t,e){const{operationQueue:r}=this,s=i=>({execute:this.removeExecutor.bind(this,i,e.startOffset,e.endOffset),onStart:()=>{},onComplete:()=>{this.hls.trigger(v.BUFFER_FLUSHED,{type:i})},onError:n=>{this.warn(`Failed to remove from ${i} SourceBuffer`,n)}});e.type?r.append(s(e.type),e.type):this.getSourceBufferTypes().forEach(i=>{r.append(s(i),i)})}onFragParsed(t,e){const{frag:r,part:s}=e,i=[],n=s?s.elementaryStreams:r.elementaryStreams;n[z.AUDIOVIDEO]?i.push("audiovideo"):(n[z.AUDIO]&&i.push("audio"),n[z.VIDEO]&&i.push("video"));const o=()=>{const l=self.performance.now();r.stats.buffering.end=l,s&&(s.stats.buffering.end=l);const h=s?s.stats:r.stats;this.hls.trigger(v.FRAG_BUFFERED,{frag:r,part:s,stats:h,id:r.type})};i.length===0&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${r.type} level: ${r.level} sn: ${r.sn}`),this.blockBuffers(o,i)}onFragChanged(t,e){this.trimBuffers()}onBufferEos(t,e){this.getSourceBufferTypes().reduce((r,s)=>{const i=this.sourceBuffer[s];return i&&(!e.type||e.type===s)&&(i.ending=!0,i.ended||(i.ended=!0,this.log(`${s} sourceBuffer now EOS`))),r&&!!(!i||i.ended)},!0)&&(this.log("Queueing mediaSource.endOfStream()"),this.blockBuffers(()=>{this.getSourceBufferTypes().forEach(s=>{const i=this.sourceBuffer[s];i&&(i.ending=!1)});const{mediaSource:r}=this;if(!r||r.readyState!=="open"){r&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${r.readyState}`);return}this.log("Calling mediaSource.endOfStream()"),r.endOfStream()}))}onLevelUpdated(t,{details:e}){e.fragments.length&&(this.details=e,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())}trimBuffers(){const{hls:t,details:e,media:r}=this;if(!r||e===null||!this.getSourceBufferTypes().length)return;const s=t.config,i=r.currentTime,n=e.levelTargetDuration,o=e.live&&s.liveBackBufferLength!==null?s.liveBackBufferLength:s.backBufferLength;if(M(o)&&o>0){const l=Math.max(o,n),h=Math.floor(i/n)*n-l;this.flushBackBuffer(i,n,h)}if(M(s.frontBufferFlushThreshold)&&s.frontBufferFlushThreshold>0){const l=Math.max(s.maxBufferLength,s.frontBufferFlushThreshold),h=Math.max(l,n),d=Math.floor(i/n)*n+h;this.flushFrontBuffer(i,n,d)}}flushBackBuffer(t,e,r){const{details:s,sourceBuffer:i}=this;this.getSourceBufferTypes().forEach(n=>{const o=i[n];if(o){const l=X.getBuffered(o);if(l.length>0&&r>l.start(0)){if(this.hls.trigger(v.BACK_BUFFER_REACHED,{bufferEnd:r}),s!=null&&s.live)this.hls.trigger(v.LIVE_BACK_BUFFER_REACHED,{bufferEnd:r});else if(o.ended&&l.end(l.length-1)-t<e*2){this.log(`Cannot flush ${n} back buffer while SourceBuffer is in ended state`);return}this.hls.trigger(v.BUFFER_FLUSHING,{startOffset:0,endOffset:r,type:n})}}})}flushFrontBuffer(t,e,r){const{sourceBuffer:s}=this;this.getSourceBufferTypes().forEach(i=>{const n=s[i];if(n){const o=X.getBuffered(n),l=o.length;if(l<2)return;const h=o.start(l-1),d=o.end(l-1);if(r>h||t>=h&&t<=d)return;if(n.ended&&t-d<2*e){this.log(`Cannot flush ${i} front buffer while SourceBuffer is in ended state`);return}this.hls.trigger(v.BUFFER_FLUSHING,{startOffset:h,endOffset:1/0,type:i})}})}updateMediaElementDuration(){if(!this.details||!this.media||!this.mediaSource||this.mediaSource.readyState!=="open")return;const{details:t,hls:e,media:r,mediaSource:s}=this,i=t.fragments[0].start+t.totalduration,n=r.duration,o=M(s.duration)?s.duration:0;t.live&&e.config.liveDurationInfinity?(s.duration=1/0,this.updateSeekableRange(t)):(i>o&&i>n||!M(n))&&(this.log(`Updating Media Source duration to ${i.toFixed(3)}`),s.duration=i)}updateSeekableRange(t){const e=this.mediaSource,r=t.fragments;if(r.length&&t.live&&e!=null&&e.setLiveSeekableRange){const s=Math.max(0,r[0].start),i=Math.max(s,s+t.totalduration);this.log(`Media Source duration is set to ${e.duration}. Setting seekable range to ${s}-${i}.`),e.setLiveSeekableRange(s,i)}}checkPendingTracks(){const{bufferCodecEventsExpected:t,operationQueue:e,pendingTracks:r}=this,s=Object.keys(r).length;if(s&&(!t||s===2||"audiovideo"in r)){this.createSourceBuffers(r),this.pendingTracks={};const i=this.getSourceBufferTypes();if(i.length)this.hls.trigger(v.BUFFER_CREATED,{tracks:this.tracks}),i.forEach(n=>{e.executeNext(n)});else{const n=new Error("could not create source buffer for media codec(s)");this.hls.trigger(v.ERROR,{type:G.MEDIA_ERROR,details:b.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:n,reason:n.message})}}}createSourceBuffers(t){const{sourceBuffer:e,mediaSource:r}=this;if(!r)throw Error("createSourceBuffers called when mediaSource was null");for(const i in t)if(!e[i]){var s;const n=t[i];if(!n)throw Error(`source buffer exists for track ${i}, however track does not`);let o=((s=n.levelCodec)==null?void 0:s.indexOf(","))===-1?n.levelCodec:n.codec;o&&i.slice(0,5)==="audio"&&(o=Yt(o,this.appendSource));const l=`${n.container};codecs=${o}`;this.log(`creating sourceBuffer(${l})`);try{const h=e[i]=r.addSourceBuffer(l),d=i;this.addBufferListener(d,"updatestart",this._onSBUpdateStart),this.addBufferListener(d,"updateend",this._onSBUpdateEnd),this.addBufferListener(d,"error",this._onSBUpdateError),this.appendSource&&this.addBufferListener(d,"bufferedchange",(c,u)=>{const f=u.removedRanges;f!=null&&f.length&&this.hls.trigger(v.BUFFER_FLUSHED,{type:i})}),this.tracks[i]={buffer:h,codec:o,container:n.container,levelCodec:n.levelCodec,metadata:n.metadata,id:n.id}}catch(h){this.error(`error while trying to add sourceBuffer: ${h.message}`),this.hls.trigger(v.ERROR,{type:G.MEDIA_ERROR,details:b.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:h,sourceBufferName:i,mimeType:l})}}}get mediaSrc(){var t;const e=((t=this.media)==null?void 0:t.firstChild)||this.media;return e==null?void 0:e.src}_onSBUpdateStart(t){const{operationQueue:e}=this;e.current(t).onStart()}_onSBUpdateEnd(t){var e;if(((e=this.mediaSource)==null?void 0:e.readyState)==="closed"){this.resetBuffer(t);return}const{operationQueue:r}=this;r.current(t).onComplete(),r.shiftAndExecuteNext(t)}_onSBUpdateError(t,e){var r;const s=new Error(`${t} SourceBuffer error. MediaSource readyState: ${(r=this.mediaSource)==null?void 0:r.readyState}`);this.error(`${s}`,e),this.hls.trigger(v.ERROR,{type:G.MEDIA_ERROR,details:b.BUFFER_APPENDING_ERROR,sourceBufferName:t,error:s,fatal:!1});const i=this.operationQueue.current(t);i&&i.onError(s)}removeExecutor(t,e,r){const{media:s,mediaSource:i,operationQueue:n,sourceBuffer:o}=this,l=o[t];if(!s||!i||!l){this.warn(`Attempting to remove from the ${t} SourceBuffer, but it does not exist`),n.shiftAndExecuteNext(t);return}const h=M(s.duration)?s.duration:1/0,d=M(i.duration)?i.duration:1/0,c=Math.max(0,e),u=Math.min(r,h,d);u>c&&(!l.ending||l.ended)?(l.ended=!1,this.log(`Removing [${c},${u}] from the ${t} SourceBuffer`),l.remove(c,u)):n.shiftAndExecuteNext(t)}appendExecutor(t,e){const r=this.sourceBuffer[e];if(!r){if(!this.pendingTracks[e])throw new Error(`Attempting to append to the ${e} SourceBuffer, but it does not exist`);return}r.ended=!1,r.appendBuffer(t)}blockBuffers(t,e=this.getSourceBufferTypes()){if(!e.length){this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(t);return}const{operationQueue:r}=this,s=e.map(i=>r.appendBlocker(i));Promise.all(s).then(()=>{t(),e.forEach(i=>{const n=this.sourceBuffer[i];n!=null&&n.updating||r.shiftAndExecuteNext(i)})})}getSourceBufferTypes(){return Object.keys(this.sourceBuffer)}addBufferListener(t,e,r){const s=this.sourceBuffer[t];if(!s)return;const i=r.bind(this,t);this.listeners[t].push({event:e,listener:i}),s.addEventListener(e,i)}removeBufferListeners(t){const e=this.sourceBuffer[t];e&&this.listeners[t].forEach(r=>{e.removeEventListener(r.event,r.listener)})}}function ir(a){const t=a.querySelectorAll("source");[].slice.call(t).forEach(e=>{a.removeChild(e)})}function Oi(a,t){const e=self.document.createElement("source");e.type="video/mp4",e.src=t,a.appendChild(e)}class ke{constructor(t){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=t,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(t){this.streamController=t}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:t}=this;t.on(v.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),t.on(v.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(v.MANIFEST_PARSED,this.onManifestParsed,this),t.on(v.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(v.BUFFER_CODECS,this.onBufferCodecs,this),t.on(v.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:t}=this;t.off(v.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),t.off(v.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(v.MANIFEST_PARSED,this.onManifestParsed,this),t.off(v.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(v.BUFFER_CODECS,this.onBufferCodecs,this),t.off(v.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(t,e){const r=this.hls.levels[e.droppedLevel];this.isLevelAllowed(r)&&this.restrictedLevels.push({bitrate:r.bitrate,height:r.height,width:r.width})}onMediaAttaching(t,e){this.media=e.media instanceof HTMLVideoElement?e.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(t,e){const r=this.hls;this.restrictedLevels=[],this.firstLevel=e.firstLevel,r.config.capLevelToPlayerSize&&e.video&&this.startCapping()}onLevelsUpdated(t,e){this.timer&&M(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(t,e){this.hls.config.capLevelToPlayerSize&&e.video&&this.startCapping()}onMediaDetaching(){this.stopCapping()}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0){this.clientRect=null;return}const t=this.hls.levels;if(t.length){const e=this.hls,r=this.getMaxLevel(t.length-1);r!==this.autoLevelCapping&&S.log(`Setting autoLevelCapping to ${r}: ${t[r].height}p@${t[r].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),e.autoLevelCapping=r,e.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=e.autoLevelCapping}}}getMaxLevel(t){const e=this.hls.levels;if(!e.length)return-1;const r=e.filter((s,i)=>this.isLevelAllowed(s)&&i<=t);return this.clientRect=null,ke.getMaxLevelByMediaSize(r,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const t=this.media,e={width:0,height:0};if(t){const r=t.getBoundingClientRect();e.width=r.width,e.height=r.height,!e.width&&!e.height&&(e.width=r.right-r.left||t.width||0,e.height=r.bottom-r.top||t.height||0)}return this.clientRect=e,e}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let t=1;if(!this.hls.config.ignoreDevicePixelRatio)try{t=self.devicePixelRatio}catch{}return t}isLevelAllowed(t){return!this.restrictedLevels.some(e=>t.bitrate===e.bitrate&&t.width===e.width&&t.height===e.height)}static getMaxLevelByMediaSize(t,e,r){if(!(t!=null&&t.length))return-1;const s=(o,l)=>l?o.width!==l.width||o.height!==l.height:!0;let i=t.length-1;const n=Math.max(e,r);for(let o=0;o<t.length;o+=1){const l=t[o];if((l.width>=n||l.height>=n)&&s(l,t[o+1])){i=o;break}}return i}}class Mi{constructor(t){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=t,this.registerListeners()}setStreamController(t){this.streamController=t}registerListeners(){this.hls.on(v.MEDIA_ATTACHING,this.onMediaAttaching,this)}unregisterListeners(){this.hls.off(v.MEDIA_ATTACHING,this.onMediaAttaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(t,e){const r=this.hls.config;if(r.capLevelOnFPSDrop){const s=e.media instanceof self.HTMLVideoElement?e.media:null;this.media=s,s&&typeof s.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),r.fpsDroppedMonitoringPeriod)}}checkFPS(t,e,r){const s=performance.now();if(e){if(this.lastTime){const i=s-this.lastTime,n=r-this.lastDroppedFrames,o=e-this.lastDecodedFrames,l=1e3*n/i,h=this.hls;if(h.trigger(v.FPS_DROP,{currentDropped:n,currentDecoded:o,totalDroppedFrames:r}),l>0&&n>h.config.fpsDroppedMonitoringThreshold*o){let d=h.currentLevel;S.warn("drop FPS ratio greater than max allowed value for currentLevel: "+d),d>0&&(h.autoLevelCapping===-1||h.autoLevelCapping>=d)&&(d=d-1,h.trigger(v.FPS_DROP_LEVEL_CAPPING,{level:d,droppedLevel:h.currentLevel}),h.autoLevelCapping=d,this.streamController.nextLevelSwitch())}}this.lastTime=s,this.lastDroppedFrames=r,this.lastDecodedFrames=e}}checkFPSInterval(){const t=this.media;if(t)if(this.isVideoPlaybackQualityAvailable){const e=t.getVideoPlaybackQuality();this.checkFPS(t,e.totalVideoFrames,e.droppedVideoFrames)}else this.checkFPS(t,t.webkitDecodedFrameCount,t.webkitDroppedFrameCount)}}const Ni=3e5;class Bi{constructor(t){this.hls=void 0,this.log=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this.pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=t,this.log=S.log.bind(S,"[content-steering]:"),this.registerListeners()}registerListeners(){const t=this.hls;t.on(v.MANIFEST_LOADING,this.onManifestLoading,this),t.on(v.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(v.MANIFEST_PARSED,this.onManifestParsed,this),t.on(v.ERROR,this.onError,this)}unregisterListeners(){const t=this.hls;t&&(t.off(v.MANIFEST_LOADING,this.onManifestLoading,this),t.off(v.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(v.MANIFEST_PARSED,this.onManifestParsed,this),t.off(v.ERROR,this.onError,this))}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){const t=this.timeToLoad*1e3-(performance.now()-this.updated);if(t>0){this.scheduleRefresh(this.uri,t);return}}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){this.reloadTimer!==-1&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(t){const e=this.levels;e&&(this.levels=e.filter(r=>r!==t))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(t,e){const{contentSteering:r}=e;r!==null&&(this.pathwayId=r.pathwayId,this.uri=r.uri,this.started&&this.startLoad())}onManifestParsed(t,e){this.audioTracks=e.audioTracks,this.subtitleTracks=e.subtitleTracks}onError(t,e){const{errorAction:r}=e;if((r==null?void 0:r.action)===et.SendAlternateToPenaltyBox&&r.flags===ot.MoveAllAlternatesMatchingHost){const s=this.levels;let i=this.pathwayPriority,n=this.pathwayId;if(e.context){const{groupId:o,pathwayId:l,type:h}=e.context;o&&s?n=this.getPathwayForGroupId(o,h,n):l&&(n=l)}n in this.penalizedPathways||(this.penalizedPathways[n]=performance.now()),!i&&s&&(i=s.reduce((o,l)=>(o.indexOf(l.pathwayId)===-1&&o.push(l.pathwayId),o),[])),i&&i.length>1&&(this.updatePathwayPriority(i),r.resolved=this.pathwayId!==n),r.resolved||S.warn(`Could not resolve ${e.details} ("${e.error.message}") with content-steering for Pathway: ${n} levels: ${s&&s.length} priorities: ${JSON.stringify(i)} penalized: ${JSON.stringify(this.penalizedPathways)}`)}}filterParsedLevels(t){this.levels=t;let e=this.getLevelsForPathway(this.pathwayId);if(e.length===0){const r=t[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${r}"`),e=this.getLevelsForPathway(r),this.pathwayId=r}return e.length!==t.length?(this.log(`Found ${e.length}/${t.length} levels in Pathway "${this.pathwayId}"`),e):t}getLevelsForPathway(t){return this.levels===null?[]:this.levels.filter(e=>t===e.pathwayId)}updatePathwayPriority(t){this.pathwayPriority=t;let e;const r=this.penalizedPathways,s=performance.now();Object.keys(r).forEach(i=>{s-r[i]>Ni&&delete r[i]});for(let i=0;i<t.length;i++){const n=t[i];if(n in r)continue;if(n===this.pathwayId)return;const o=this.hls.nextLoadLevel,l=this.hls.levels[o];if(e=this.getLevelsForPathway(n),e.length>0){this.log(`Setting Pathway to "${n}"`),this.pathwayId=n,Mr(e),this.hls.trigger(v.LEVELS_UPDATED,{levels:e});const h=this.hls.levels[o];l&&h&&this.levels&&(h.attrs["STABLE-VARIANT-ID"]!==l.attrs["STABLE-VARIANT-ID"]&&h.bitrate!==l.bitrate&&this.log(`Unstable Pathways change from bitrate ${l.bitrate} to ${h.bitrate}`),this.hls.nextLoadLevel=o);break}}}getPathwayForGroupId(t,e,r){const s=this.getLevelsForPathway(r).concat(this.levels||[]);for(let i=0;i<s.length;i++)if(e===Y.AUDIO_TRACK&&s[i].hasAudioGroup(t)||e===Y.SUBTITLE_TRACK&&s[i].hasSubtitleGroup(t))return s[i].pathwayId;return r}clonePathways(t){const e=this.levels;if(!e)return;const r={},s={};t.forEach(i=>{const{ID:n,"BASE-ID":o,"URI-REPLACEMENT":l}=i;if(e.some(d=>d.pathwayId===n))return;const h=this.getLevelsForPathway(o).map(d=>{const c=new Q(d.attrs);c["PATHWAY-ID"]=n;const u=c.AUDIO&&`${c.AUDIO}_clone_${n}`,f=c.SUBTITLES&&`${c.SUBTITLES}_clone_${n}`;u&&(r[c.AUDIO]=u,c.AUDIO=u),f&&(s[c.SUBTITLES]=f,c.SUBTITLES=f);const g=Ur(d.uri,c["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",l),m=new Le({attrs:c,audioCodec:d.audioCodec,bitrate:d.bitrate,height:d.height,name:d.name,url:g,videoCodec:d.videoCodec,width:d.width});if(d.audioGroups)for(let p=1;p<d.audioGroups.length;p++)m.addGroupId("audio",`${d.audioGroups[p]}_clone_${n}`);if(d.subtitleGroups)for(let p=1;p<d.subtitleGroups.length;p++)m.addGroupId("text",`${d.subtitleGroups[p]}_clone_${n}`);return m});e.push(...h),nr(this.audioTracks,r,l,n),nr(this.subtitleTracks,s,l,n)})}loadSteeringManifest(t){const e=this.hls.config,r=e.loader;this.loader&&this.loader.destroy(),this.loader=new r(e);let s;try{s=new self.URL(t)}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest URI: ${t}`);return}if(s.protocol!=="data:"){const d=(this.hls.bandwidthEstimate||e.abrEwmaDefaultEstimate)|0;s.searchParams.set("_HLS_pathway",this.pathwayId),s.searchParams.set("_HLS_throughput",""+d)}const i={responseType:"json",url:s.href},n=e.steeringManifestLoadPolicy.default,o=n.errorRetry||n.timeoutRetry||{},l={loadPolicy:n,timeout:n.maxLoadTimeMs,maxRetry:o.maxNumRetry||0,retryDelay:o.retryDelayMs||0,maxRetryDelay:o.maxRetryDelayMs||0},h={onSuccess:(d,c,u,f)=>{this.log(`Loaded steering manifest: "${s}"`);const g=d.data;if(g.VERSION!==1){this.log(`Steering VERSION ${g.VERSION} not supported!`);return}this.updated=performance.now(),this.timeToLoad=g.TTL;const{"RELOAD-URI":m,"PATHWAY-CLONES":p,"PATHWAY-PRIORITY":y}=g;if(m)try{this.uri=new self.URL(m,s).href}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest RELOAD-URI: ${m}`);return}this.scheduleRefresh(this.uri||u.url),p&&this.clonePathways(p);const T={steeringManifest:g,url:s.toString()};this.hls.trigger(v.STEERING_MANIFEST_LOADED,T),y&&this.updatePathwayPriority(y)},onError:(d,c,u,f)=>{if(this.log(`Error loading steering manifest: ${d.code} ${d.text} (${c.url})`),this.stopLoad(),d.code===410){this.enabled=!1,this.log(`Steering manifest ${c.url} no longer available`);return}let g=this.timeToLoad*1e3;if(d.code===429){const m=this.loader;if(typeof(m==null?void 0:m.getResponseHeader)=="function"){const p=m.getResponseHeader("Retry-After");p&&(g=parseFloat(p)*1e3)}this.log(`Steering manifest ${c.url} rate limited`);return}this.scheduleRefresh(this.uri||c.url,g)},onTimeout:(d,c,u)=>{this.log(`Timeout loading steering manifest (${c.url})`),this.scheduleRefresh(this.uri||c.url)}};this.log(`Requesting steering manifest: ${s}`),this.loader.load(i,l,h)}scheduleRefresh(t,e=this.timeToLoad*1e3){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var r;const s=(r=this.hls)==null?void 0:r.media;if(s&&!s.ended){this.loadSteeringManifest(t);return}this.scheduleRefresh(t,this.timeToLoad*1e3)},e)}}function nr(a,t,e,r){a&&Object.keys(t).forEach(s=>{const i=a.filter(n=>n.groupId===s).map(n=>{const o=it({},n);return o.details=void 0,o.attrs=new Q(o.attrs),o.url=o.attrs.URI=Ur(n.url,n.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",e),o.groupId=o.attrs["GROUP-ID"]=t[s],o.attrs["PATHWAY-ID"]=r,o});a.push(...i)})}function Ur(a,t,e,r){const{HOST:s,PARAMS:i,[e]:n}=r;let o;t&&(o=n==null?void 0:n[t],o&&(a=o));const l=new self.URL(a);return s&&!o&&(l.host=s),i&&Object.keys(i).sort().forEach(h=>{h&&l.searchParams.set(h,i[h])}),l.href}const Ui=/^age:\s*[\d.]+\s*$/im;class $r{constructor(t){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=t&&t.xhrSetup||null,this.stats=new Jt,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}abortInternal(){const t=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),t&&(t.onreadystatechange=null,t.onprogress=null,t.readyState!==4&&(this.stats.aborted=!0,t.abort()))}abort(){var t;this.abortInternal(),(t=this.callbacks)!=null&&t.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(t,e,r){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=t,this.config=e,this.callbacks=r,this.loadInternal()}loadInternal(){const{config:t,context:e}=this;if(!t||!e)return;const r=this.loader=new self.XMLHttpRequest,s=this.stats;s.loading.first=0,s.loaded=0,s.aborted=!1;const i=this.xhrSetup;i?Promise.resolve().then(()=>{if(!(this.loader!==r||this.stats.aborted))return i(r,e.url)}).catch(n=>{if(!(this.loader!==r||this.stats.aborted))return r.open("GET",e.url,!0),i(r,e.url)}).then(()=>{this.loader!==r||this.stats.aborted||this.openAndSendXhr(r,e,t)}).catch(n=>{this.callbacks.onError({code:r.status,text:n.message},e,r,s)}):this.openAndSendXhr(r,e,t)}openAndSendXhr(t,e,r){t.readyState||t.open("GET",e.url,!0);const s=e.headers,{maxTimeToFirstByteMs:i,maxLoadTimeMs:n}=r.loadPolicy;if(s)for(const o in s)t.setRequestHeader(o,s[o]);e.rangeEnd&&t.setRequestHeader("Range","bytes="+e.rangeStart+"-"+(e.rangeEnd-1)),t.onreadystatechange=this.readystatechange.bind(this),t.onprogress=this.loadprogress.bind(this),t.responseType=e.responseType,self.clearTimeout(this.requestTimeout),r.timeout=i&&M(i)?i:n,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),r.timeout),t.send()}readystatechange(){const{context:t,loader:e,stats:r}=this;if(!t||!e)return;const s=e.readyState,i=this.config;if(!r.aborted&&s>=2&&(r.loading.first===0&&(r.loading.first=Math.max(self.performance.now(),r.loading.start),i.timeout!==i.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),i.timeout=i.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.loadPolicy.maxLoadTimeMs-(r.loading.first-r.loading.start)))),s===4)){self.clearTimeout(this.requestTimeout),e.onreadystatechange=null,e.onprogress=null;const n=e.status,o=e.responseType!=="text";if(n>=200&&n<300&&(o&&e.response||e.responseText!==null)){r.loading.end=Math.max(self.performance.now(),r.loading.first);const l=o?e.response:e.responseText,h=e.responseType==="arraybuffer"?l.byteLength:l.length;if(r.loaded=r.total=h,r.bwEstimate=r.total*8e3/(r.loading.end-r.loading.first),!this.callbacks)return;const d=this.callbacks.onProgress;if(d&&d(r,t,l,e),!this.callbacks)return;const c={url:e.responseURL,data:l,code:n};this.callbacks.onSuccess(c,r,t,e)}else{const l=i.loadPolicy.errorRetry,h=r.retry,d={url:t.url,data:void 0,code:n};zt(l,h,!1,d)?this.retry(l):(S.error(`${n} while loading ${t.url}`),this.callbacks.onError({code:n,text:e.statusText},t,e,r))}}}loadtimeout(){if(!this.config)return;const t=this.config.loadPolicy.timeoutRetry,e=this.stats.retry;if(zt(t,e,!0))this.retry(t);else{var r;S.warn(`timeout while loading ${(r=this.context)==null?void 0:r.url}`);const s=this.callbacks;s&&(this.abortInternal(),s.onTimeout(this.stats,this.context,this.loader))}}retry(t){const{context:e,stats:r}=this;this.retryDelay=Ie(t,r.retry),r.retry++,S.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${e==null?void 0:e.url}, retrying ${r.retry}/${t.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(t){const e=this.stats;e.loaded=t.loaded,t.lengthComputable&&(e.total=t.total)}getCacheAge(){let t=null;if(this.loader&&Ui.test(this.loader.getAllResponseHeaders())){const e=this.loader.getResponseHeader("age");t=e?parseFloat(e):null}return t}getResponseHeader(t){return this.loader&&new RegExp(`^${t}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(t):null}}class $i{constructor(){this.chunks=[],this.dataLength=0}push(t){this.chunks.push(t),this.dataLength+=t.length}flush(){const{chunks:t,dataLength:e}=this;let r;if(t.length)t.length===1?r=t[0]:r=Gi(t,e);else return new Uint8Array(0);return this.reset(),r}reset(){this.chunks.length=0,this.dataLength=0}}function Gi(a,t){const e=new Uint8Array(t);let r=0;for(let s=0;s<a.length;s++){const i=a[s];e.set(i,r),r+=i.length}return e}function Hi(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch{}return!1}const Vi=/(\d+)-(\d+)\/(\d+)/;class ar{constructor(t){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=t.fetchSetup||ji,this.controller=new self.AbortController,this.stats=new Jt}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var t;this.abortInternal(),(t=this.callbacks)!=null&&t.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(t,e,r){const s=this.stats;if(s.loading.start)throw new Error("Loader can only be used once.");s.loading.start=self.performance.now();const i=Ki(t,this.controller.signal),n=r.onProgress,o=t.responseType==="arraybuffer",l=o?"byteLength":"length",{maxTimeToFirstByteMs:h,maxLoadTimeMs:d}=e.loadPolicy;this.context=t,this.config=e,this.callbacks=r,this.request=this.fetchSetup(t,i),self.clearTimeout(this.requestTimeout),e.timeout=h&&M(h)?h:d,this.requestTimeout=self.setTimeout(()=>{this.abortInternal(),r.onTimeout(s,t,this.response)},e.timeout),self.fetch(this.request).then(c=>{this.response=this.loader=c;const u=Math.max(self.performance.now(),s.loading.start);if(self.clearTimeout(this.requestTimeout),e.timeout=d,this.requestTimeout=self.setTimeout(()=>{this.abortInternal(),r.onTimeout(s,t,this.response)},d-(u-s.loading.start)),!c.ok){const{status:f,statusText:g}=c;throw new qi(g||"fetch, bad network response",f,c)}return s.loading.first=u,s.total=Yi(c.headers)||s.total,n&&M(e.highWaterMark)?this.loadProgressively(c,s,t,e.highWaterMark,n):o?c.arrayBuffer():t.responseType==="json"?c.json():c.text()}).then(c=>{const u=this.response;if(!u)throw new Error("loader destroyed");self.clearTimeout(this.requestTimeout),s.loading.end=Math.max(self.performance.now(),s.loading.first);const f=c[l];f&&(s.loaded=s.total=f);const g={url:u.url,data:c,code:u.status};n&&!M(e.highWaterMark)&&n(s,t,c,u),r.onSuccess(g,s,t,u)}).catch(c=>{if(self.clearTimeout(this.requestTimeout),s.aborted)return;const u=c&&c.code||0,f=c?c.message:null;r.onError({code:u,text:f},t,c?c.details:null,s)})}getCacheAge(){let t=null;if(this.response){const e=this.response.headers.get("age");t=e?parseFloat(e):null}return t}getResponseHeader(t){return this.response?this.response.headers.get(t):null}loadProgressively(t,e,r,s=0,i){const n=new $i,o=t.body.getReader(),l=()=>o.read().then(h=>{if(h.done)return n.dataLength&&i(e,r,n.flush(),t),Promise.resolve(new ArrayBuffer(0));const d=h.value,c=d.length;return e.loaded+=c,c<s||n.dataLength?(n.push(d),n.dataLength>=s&&i(e,r,n.flush(),t)):i(e,r,d,t),l()}).catch(()=>Promise.reject());return l()}}function Ki(a,t){const e={method:"GET",mode:"cors",credentials:"same-origin",signal:t,headers:new self.Headers(it({},a.headers))};return a.rangeEnd&&e.headers.set("Range","bytes="+a.rangeStart+"-"+String(a.rangeEnd-1)),e}function Wi(a){const t=Vi.exec(a);if(t)return parseInt(t[2])-parseInt(t[1])+1}function Yi(a){const t=a.get("Content-Range");if(t){const r=Wi(t);if(M(r))return r}const e=a.get("Content-Length");if(e)return parseInt(e)}function ji(a,t){return new self.Request(a.url,t)}class qi extends Error{constructor(t,e,r){super(t),this.code=void 0,this.details=void 0,this.code=e,this.details=r}}const zi={maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null},Gr=at(at({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,maxBufferSize:60*1e3*1e3,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:$r,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:wi,bufferController:Fi,capLevelController:ke,errorController:Ai,fpsController:Mi,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:null,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableID3MetadataCues:!0,useMediaCapabilities:!1,certLoadPolicy:{default:zi},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},Xi()),{},{subtitleStreamController:void 0,subtitleTrackController:void 0,timelineController:void 0,audioStreamController:void 0,audioTrackController:void 0,emeController:void 0,cmcdController:void 0,contentSteeringController:Bi});function Xi(){return{cueHandler:Es,enableWebVTT:!1,enableIMSC1:!1,enableCEA708Captions:!1,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function Qi(a,t){if((t.liveSyncDurationCount||t.liveMaxLatencyDurationCount)&&(t.liveSyncDuration||t.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(t.liveMaxLatencyDurationCount!==void 0&&(t.liveSyncDurationCount===void 0||t.liveMaxLatencyDurationCount<=t.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(t.liveMaxLatencyDuration!==void 0&&(t.liveSyncDuration===void 0||t.liveMaxLatencyDuration<=t.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');const e=Se(a),r=["manifest","level","frag"],s=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return r.forEach(i=>{const n=`${i==="level"?"playlist":i}LoadPolicy`,o=t[n]===void 0,l=[];s.forEach(h=>{const d=`${i}Loading${h}`,c=t[d];if(c!==void 0&&o){l.push(d);const u=e[n].default;switch(t[n]={default:u},h){case"TimeOut":u.maxLoadTimeMs=c,u.maxTimeToFirstByteMs=c;break;case"MaxRetry":u.errorRetry.maxNumRetry=c,u.timeoutRetry.maxNumRetry=c;break;case"RetryDelay":u.errorRetry.retryDelayMs=c,u.timeoutRetry.retryDelayMs=c;break;case"MaxRetryTimeout":u.errorRetry.maxRetryDelayMs=c,u.timeoutRetry.maxRetryDelayMs=c;break}}}),l.length&&S.warn(`hls.js config: "${l.join('", "')}" setting(s) are deprecated, use "${n}": ${JSON.stringify(t[n])}`)}),at(at({},e),t)}function Se(a){return a&&typeof a=="object"?Array.isArray(a)?a.map(Se):Object.keys(a).reduce((t,e)=>(t[e]=Se(a[e]),t),{}):a}function Ji(a){const t=a.loader;t!==ar&&t!==$r?(S.log("[config]: Custom loader detected, cannot enable progressive streaming"),a.progressive=!1):Hi()&&(a.loader=ar,a.progressive=!0,a.enableSoftwareAES=!0,S.log("[config]: Progressive streaming enabled, using FetchLoader"))}let de;class Zi extends Ri{constructor(t,e){super(t,"[level-controller]"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=e,this._registerListeners()}_registerListeners(){const{hls:t}=this;t.on(v.MANIFEST_LOADING,this.onManifestLoading,this),t.on(v.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(v.LEVEL_LOADED,this.onLevelLoaded,this),t.on(v.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(v.FRAG_BUFFERED,this.onFragBuffered,this),t.on(v.ERROR,this.onError,this)}_unregisterListeners(){const{hls:t}=this;t.off(v.MANIFEST_LOADING,this.onManifestLoading,this),t.off(v.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(v.LEVEL_LOADED,this.onLevelLoaded,this),t.off(v.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(v.FRAG_BUFFERED,this.onFragBuffered,this),t.off(v.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach(t=>{t.loadError=0,t.fragmentError=0}),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(t,e){this.resetLevels()}onManifestLoaded(t,e){const r=this.hls.config.preferManagedMediaSource,s=[],i={},n={};let o=!1,l=!1,h=!1;e.levels.forEach(d=>{var c,u;const f=d.attrs;let{audioCodec:g,videoCodec:m}=d;((c=g)==null?void 0:c.indexOf("mp4a.40.34"))!==-1&&(de||(de=/chrome|firefox/i.test(navigator.userAgent)),de&&(d.audioCodec=g=void 0)),g&&(d.audioCodec=g=Yt(g,r)),((u=m)==null?void 0:u.indexOf("avc1"))===0&&(m=d.videoCodec=qs(m));const{width:p,height:y,unknownCodecs:T}=d;if(o||(o=!!(p&&y)),l||(l=!!m),h||(h=!!g),T!=null&&T.length||g&&!ne(g,"audio",r)||m&&!ne(m,"video",r))return;const{CODECS:A,"FRAME-RATE":R,"HDCP-LEVEL":L,"PATHWAY-ID":D,RESOLUTION:I,"VIDEO-RANGE":C}=f,w=`${`${D||"."}-`}${d.bitrate}-${I}-${R}-${A}-${C}-${L}`;if(i[w])if(i[w].uri!==d.url&&!d.attrs["PATHWAY-ID"]){const O=n[w]+=1;d.attrs["PATHWAY-ID"]=new Array(O+1).join(".");const x=new Le(d);i[w]=x,s.push(x)}else i[w].addGroupId("audio",f.AUDIO),i[w].addGroupId("text",f.SUBTITLES);else{const O=new Le(d);i[w]=O,n[w]=1,s.push(O)}}),this.filterAndSortMediaOptions(s,e,o,l,h)}filterAndSortMediaOptions(t,e,r,s,i){let n=[],o=[],l=t;if((r||s)&&i&&(l=l.filter(({videoCodec:g,videoRange:m,width:p,height:y})=>(!!g||!!(p&&y))&&di(m))),l.length===0){Promise.resolve().then(()=>{if(this.hls){e.levels.length&&this.warn(`One or more CODECS in variant not supported: ${JSON.stringify(e.levels[0].attrs)}`);const g=new Error("no level with compatible codecs found in manifest");this.hls.trigger(v.ERROR,{type:G.MEDIA_ERROR,details:b.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:e.url,error:g,reason:g.message})}});return}if(e.audioTracks){const{preferManagedMediaSource:g}=this.hls.config;n=e.audioTracks.filter(m=>!m.audioCodec||ne(m.audioCodec,"audio",g)),or(n)}e.subtitles&&(o=e.subtitles,or(o));const h=l.slice(0);l.sort((g,m)=>{if(g.attrs["HDCP-LEVEL"]!==m.attrs["HDCP-LEVEL"])return(g.attrs["HDCP-LEVEL"]||"")>(m.attrs["HDCP-LEVEL"]||"")?1:-1;if(r&&g.height!==m.height)return g.height-m.height;if(g.frameRate!==m.frameRate)return g.frameRate-m.frameRate;if(g.videoRange!==m.videoRange)return jt.indexOf(g.videoRange)-jt.indexOf(m.videoRange);if(g.videoCodec!==m.videoCodec){const p=Ne(g.videoCodec),y=Ne(m.videoCodec);if(p!==y)return y-p}if(g.uri===m.uri&&g.codecSet!==m.codecSet){const p=Wt(g.codecSet),y=Wt(m.codecSet);if(p!==y)return y-p}return g.averageBitrate!==m.averageBitrate?g.averageBitrate-m.averageBitrate:0});let d=h[0];if(this.steering&&(l=this.steering.filterParsedLevels(l),l.length!==h.length)){for(let g=0;g<h.length;g++)if(h[g].pathwayId===l[0].pathwayId){d=h[g];break}}this._levels=l;for(let g=0;g<l.length;g++)if(l[g]===d){var c;this._firstLevel=g;const m=d.bitrate,p=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${l.length} level(s) found, first bitrate: ${m}`),((c=this.hls.userConfig)==null?void 0:c.abrEwmaDefaultEstimate)===void 0){const y=Math.min(m,this.hls.config.abrEwmaDefaultEstimateMax);y>p&&p===Gr.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=y)}break}const u=i&&!s,f={levels:l,audioTracks:n,subtitleTracks:o,sessionData:e.sessionData,sessionKeys:e.sessionKeys,firstLevel:this._firstLevel,stats:e.stats,audio:i,video:s,altAudio:!u&&n.some(g=>!!g.url)};this.hls.trigger(v.MANIFEST_PARSED,f),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}get levels(){return this._levels.length===0?null:this._levels}get level(){return this.currentLevelIndex}set level(t){const e=this._levels;if(e.length===0)return;if(t<0||t>=e.length){const d=new Error("invalid level idx"),c=t<0;if(this.hls.trigger(v.ERROR,{type:G.OTHER_ERROR,details:b.LEVEL_SWITCH_ERROR,level:t,fatal:c,error:d,reason:d.message}),c)return;t=Math.min(t,e.length-1)}const r=this.currentLevelIndex,s=this.currentLevel,i=s?s.attrs["PATHWAY-ID"]:void 0,n=e[t],o=n.attrs["PATHWAY-ID"];if(this.currentLevelIndex=t,this.currentLevel=n,r===t&&n.details&&s&&i===o)return;this.log(`Switching to level ${t} (${n.height?n.height+"p ":""}${n.videoRange?n.videoRange+" ":""}${n.codecSet?n.codecSet+" ":""}@${n.bitrate})${o?" with Pathway "+o:""} from level ${r}${i?" with Pathway "+i:""}`);const l={level:t,attrs:n.attrs,details:n.details,bitrate:n.bitrate,averageBitrate:n.averageBitrate,maxBitrate:n.maxBitrate,realBitrate:n.realBitrate,width:n.width,height:n.height,codecSet:n.codecSet,audioCodec:n.audioCodec,videoCodec:n.videoCodec,audioGroups:n.audioGroups,subtitleGroups:n.subtitleGroups,loaded:n.loaded,loadError:n.loadError,fragmentError:n.fragmentError,name:n.name,id:n.id,uri:n.uri,url:n.url,urlId:0,audioGroupIds:n.audioGroupIds,textGroupIds:n.textGroupIds};this.hls.trigger(v.LEVEL_SWITCHING,l);const h=n.details;if(!h||h.live){const d=this.switchParams(n.uri,s==null?void 0:s.details,h);this.loadPlaylist(d)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(t){this.manualLevelIndex=t,this._startLevel===void 0&&(this._startLevel=t),t!==-1&&(this.level=t)}get firstLevel(){return this._firstLevel}set firstLevel(t){this._firstLevel=t}get startLevel(){if(this._startLevel===void 0){const t=this.hls.config.startLevel;return t!==void 0?t:this.hls.firstAutoLevel}return this._startLevel}set startLevel(t){this._startLevel=t}onError(t,e){e.fatal||!e.context||e.context.type===Y.LEVEL&&e.context.level===this.level&&this.checkRetry(e)}onFragBuffered(t,{frag:e}){if(e!==void 0&&e.type===j.MAIN){const r=e.elementaryStreams;if(!Object.keys(r).some(i=>!!r[i]))return;const s=this._levels[e.level];s!=null&&s.loadError&&(this.log(`Resetting level error count of ${s.loadError} on frag buffered`),s.loadError=0)}}onLevelLoaded(t,e){var r;const{level:s,details:i}=e,n=this._levels[s];if(!n){var o;this.warn(`Invalid level index ${s}`),(o=e.deliveryDirectives)!=null&&o.skip&&(i.deltaUpdateFailed=!0);return}s===this.currentLevelIndex?(n.fragmentError===0&&(n.loadError=0),this.playlistLoaded(s,e,n.details)):(r=e.deliveryDirectives)!=null&&r.skip&&(i.deltaUpdateFailed=!0)}loadPlaylist(t){super.loadPlaylist();const e=this.currentLevelIndex,r=this.currentLevel;if(r&&this.shouldLoadPlaylist(r)){let s=r.uri;if(t)try{s=t.addDirectives(s)}catch(n){this.warn(`Could not construct new URL with HLS Delivery Directives: ${n}`)}const i=r.attrs["PATHWAY-ID"];this.log(`Loading level index ${e}${(t==null?void 0:t.msn)!==void 0?" at sn "+t.msn+" part "+t.part:""} with${i?" Pathway "+i:""} ${s}`),this.clearTimer(),this.hls.trigger(v.LEVEL_LOADING,{url:s,level:e,pathwayId:r.attrs["PATHWAY-ID"],id:0,deliveryDirectives:t||null})}}get nextLoadLevel(){return this.manualLevelIndex!==-1?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(t){this.level=t,this.manualLevelIndex===-1&&(this.hls.nextAutoLevel=t)}removeLevel(t){var e;const r=this._levels.filter((s,i)=>i!==t?!0:(this.steering&&this.steering.removeLevel(s),s===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,s.details&&s.details.fragments.forEach(n=>n.level=-1)),!1));Mr(r),this._levels=r,this.currentLevelIndex>-1&&(e=this.currentLevel)!=null&&e.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.hls.trigger(v.LEVELS_UPDATED,{levels:r})}onLevelsUpdated(t,{levels:e}){this._levels=e}checkMaxAutoUpdated(){const{autoLevelCapping:t,maxAutoLevel:e,maxHdcpLevel:r}=this.hls;this._maxAutoLevel!==e&&(this._maxAutoLevel=e,this.hls.trigger(v.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:t,levels:this.levels,maxAutoLevel:e,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:r}))}}function or(a){const t={};a.forEach(e=>{const r=e.groupId||"";e.id=t[r]=t[r]||0,t[r]++})}var st={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"};class tn{constructor(t){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=t,this._registerListeners()}_registerListeners(){const{hls:t}=this;t.on(v.BUFFER_APPENDED,this.onBufferAppended,this),t.on(v.FRAG_BUFFERED,this.onFragBuffered,this),t.on(v.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){const{hls:t}=this;t.off(v.BUFFER_APPENDED,this.onBufferAppended,this),t.off(v.FRAG_BUFFERED,this.onFragBuffered,this),t.off(v.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(t,e){const r=this.activePartLists[e];if(r)for(let s=r.length;s--;){const i=r[s];if(!i)break;const n=i.end;if(i.start<=t&&n!==null&&t<=n)return i}return this.getBufferedFrag(t,e)}getBufferedFrag(t,e){const{fragments:r}=this,s=Object.keys(r);for(let i=s.length;i--;){const n=r[s[i]];if((n==null?void 0:n.body.type)===e&&n.buffered){const o=n.body;if(o.start<=t&&t<=o.end)return o}}return null}detectEvictedFragments(t,e,r,s){this.timeRanges&&(this.timeRanges[t]=e);const i=(s==null?void 0:s.fragment.sn)||-1;Object.keys(this.fragments).forEach(n=>{const o=this.fragments[n];if(!o||i>=o.body.sn)return;if(!o.buffered&&!o.loaded){o.body.type===r&&this.removeFragment(o.body);return}const l=o.range[t];l&&l.time.some(h=>{const d=!this.isTimeBuffered(h.startPTS,h.endPTS,e);return d&&this.removeFragment(o.body),d})})}detectPartialFragments(t){const e=this.timeRanges,{frag:r,part:s}=t;if(!e||r.sn==="initSegment")return;const i=bt(r),n=this.fragments[i];if(!n||n.buffered&&r.gap)return;const o=!r.relurl;Object.keys(e).forEach(l=>{const h=r.elementaryStreams[l];if(!h)return;const d=e[l],c=o||h.partial===!0;n.range[l]=this.getBufferedTimes(r,s,c,d)}),n.loaded=null,Object.keys(n.range).length?(n.buffered=!0,(n.body.endList=r.endList||n.body.endList)&&(this.endListFragments[n.body.type]=n),Ot(n)||this.removeParts(r.sn-1,r.type)):this.removeFragment(n.body)}removeParts(t,e){const r=this.activePartLists[e];r&&(this.activePartLists[e]=r.filter(s=>s.fragment.sn>=t))}fragBuffered(t,e){const r=bt(t);let s=this.fragments[r];!s&&e&&(s=this.fragments[r]={body:t,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},t.gap&&(this.hasGaps=!0)),s&&(s.loaded=null,s.buffered=!0)}getBufferedTimes(t,e,r,s){const i={time:[],partial:r},n=t.start,o=t.end,l=t.minEndPTS||o,h=t.maxStartPTS||n;for(let d=0;d<s.length;d++){const c=s.start(d)-this.bufferPadding,u=s.end(d)+this.bufferPadding;if(h>=c&&l<=u){i.time.push({startPTS:Math.max(n,s.start(d)),endPTS:Math.min(o,s.end(d))});break}else if(n<u&&o>c){const f=Math.max(n,s.start(d)),g=Math.min(o,s.end(d));g>f&&(i.partial=!0,i.time.push({startPTS:f,endPTS:g}))}else if(o<=c)break}return i}getPartialFragment(t){let e=null,r,s,i,n=0;const{bufferPadding:o,fragments:l}=this;return Object.keys(l).forEach(h=>{const d=l[h];d&&Ot(d)&&(s=d.body.start-o,i=d.body.end+o,t>=s&&t<=i&&(r=Math.min(t-s,i-t),n<=r&&(e=d.body,n=r)))}),e}isEndListAppended(t){const e=this.endListFragments[t];return e!==void 0&&(e.buffered||Ot(e))}getState(t){const e=bt(t),r=this.fragments[e];return r?r.buffered?Ot(r)?st.PARTIAL:st.OK:st.APPENDING:st.NOT_LOADED}isTimeBuffered(t,e,r){let s,i;for(let n=0;n<r.length;n++){if(s=r.start(n)-this.bufferPadding,i=r.end(n)+this.bufferPadding,t>=s&&e<=i)return!0;if(e<=s)return!1}return!1}onFragLoaded(t,e){const{frag:r,part:s}=e;if(r.sn==="initSegment"||r.bitrateTest)return;const i=s?null:e,n=bt(r);this.fragments[n]={body:r,appendedPTS:null,loaded:i,buffered:!1,range:Object.create(null)}}onBufferAppended(t,e){const{frag:r,part:s,timeRanges:i}=e;if(r.sn==="initSegment")return;const n=r.type;if(s){let o=this.activePartLists[n];o||(this.activePartLists[n]=o=[]),o.push(s)}this.timeRanges=i,Object.keys(i).forEach(o=>{const l=i[o];this.detectEvictedFragments(o,l,n,s)})}onFragBuffered(t,e){this.detectPartialFragments(e)}hasFragment(t){const e=bt(t);return!!this.fragments[e]}hasParts(t){var e;return!!((e=this.activePartLists[t])!=null&&e.length)}removeFragmentsInRange(t,e,r,s,i){s&&!this.hasGaps||Object.keys(this.fragments).forEach(n=>{const o=this.fragments[n];if(!o)return;const l=o.body;l.type!==r||s&&!l.gap||l.start<e&&l.end>t&&(o.buffered||i)&&this.removeFragment(l)})}removeFragment(t){const e=bt(t);t.stats.loaded=0,t.clearElementaryStreamInfo();const r=this.activePartLists[t.type];if(r){const s=t.sn;this.activePartLists[t.type]=r.filter(i=>i.fragment.sn!==s)}delete this.fragments[e],t.endList&&delete this.endListFragments[t.type]}removeAllFragments(){this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1}}function Ot(a){var t,e,r;return a.buffered&&(a.body.gap||((t=a.range.video)==null?void 0:t.partial)||((e=a.range.audio)==null?void 0:e.partial)||((r=a.range.audiovideo)==null?void 0:r.partial))}function bt(a){return`${a.type}_${a.level}_${a.sn}`}const lr=Math.pow(2,17);class en{constructor(t){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=t}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(t,e){const r=t.url;if(!r)return Promise.reject(new pt({type:G.NETWORK_ERROR,details:b.FRAG_LOAD_ERROR,fatal:!1,frag:t,error:new Error(`Fragment does not have a ${r?"part list":"url"}`),networkDetails:null}));this.abort();const s=this.config,i=s.fLoader,n=s.loader;return new Promise((o,l)=>{if(this.loader&&this.loader.destroy(),t.gap)if(t.tagList.some(f=>f[0]==="GAP")){l(dr(t));return}else t.gap=!1;const h=this.loader=t.loader=i?new i(s):new n(s),d=hr(t),c=er(s.fragLoadPolicy.default),u={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:t.sn==="initSegment"?1/0:lr};t.stats=h.stats,h.load(d,u,{onSuccess:(f,g,m,p)=>{this.resetLoader(t,h);let y=f.data;m.resetIV&&t.decryptdata&&(t.decryptdata.iv=new Uint8Array(y.slice(0,16)),y=y.slice(16)),o({frag:t,part:null,payload:y,networkDetails:p})},onError:(f,g,m,p)=>{this.resetLoader(t,h),l(new pt({type:G.NETWORK_ERROR,details:b.FRAG_LOAD_ERROR,fatal:!1,frag:t,response:at({url:r,data:void 0},f),error:new Error(`HTTP Error ${f.code} ${f.text}`),networkDetails:m,stats:p}))},onAbort:(f,g,m)=>{this.resetLoader(t,h),l(new pt({type:G.NETWORK_ERROR,details:b.INTERNAL_ABORTED,fatal:!1,frag:t,error:new Error("Aborted"),networkDetails:m,stats:f}))},onTimeout:(f,g,m)=>{this.resetLoader(t,h),l(new pt({type:G.NETWORK_ERROR,details:b.FRAG_LOAD_TIMEOUT,fatal:!1,frag:t,error:new Error(`Timeout after ${u.timeout}ms`),networkDetails:m,stats:f}))},onProgress:(f,g,m,p)=>{e&&e({frag:t,part:null,payload:m,networkDetails:p})}})})}loadPart(t,e,r){this.abort();const s=this.config,i=s.fLoader,n=s.loader;return new Promise((o,l)=>{if(this.loader&&this.loader.destroy(),t.gap||e.gap){l(dr(t,e));return}const h=this.loader=t.loader=i?new i(s):new n(s),d=hr(t,e),c=er(s.fragLoadPolicy.default),u={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:lr};e.stats=h.stats,h.load(d,u,{onSuccess:(f,g,m,p)=>{this.resetLoader(t,h),this.updateStatsFromPart(t,e);const y={frag:t,part:e,payload:f.data,networkDetails:p};r(y),o(y)},onError:(f,g,m,p)=>{this.resetLoader(t,h),l(new pt({type:G.NETWORK_ERROR,details:b.FRAG_LOAD_ERROR,fatal:!1,frag:t,part:e,response:at({url:d.url,data:void 0},f),error:new Error(`HTTP Error ${f.code} ${f.text}`),networkDetails:m,stats:p}))},onAbort:(f,g,m)=>{t.stats.aborted=e.stats.aborted,this.resetLoader(t,h),l(new pt({type:G.NETWORK_ERROR,details:b.INTERNAL_ABORTED,fatal:!1,frag:t,part:e,error:new Error("Aborted"),networkDetails:m,stats:f}))},onTimeout:(f,g,m)=>{this.resetLoader(t,h),l(new pt({type:G.NETWORK_ERROR,details:b.FRAG_LOAD_TIMEOUT,fatal:!1,frag:t,part:e,error:new Error(`Timeout after ${u.timeout}ms`),networkDetails:m,stats:f}))}})})}updateStatsFromPart(t,e){const r=t.stats,s=e.stats,i=s.total;if(r.loaded+=s.loaded,i){const l=Math.round(t.duration/e.duration),h=Math.min(Math.round(r.loaded/i),l),d=(l-h)*Math.round(r.loaded/h);r.total=r.loaded+d}else r.total=Math.max(r.loaded,r.total);const n=r.loading,o=s.loading;n.start?n.first+=o.first-o.start:(n.start=o.start,n.first=o.first),n.end=o.end}resetLoader(t,e){t.loader=null,this.loader===e&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),e.destroy()}}function hr(a,t=null){const e=t||a,r={frag:a,part:t,responseType:"arraybuffer",url:e.url,headers:{},rangeStart:0,rangeEnd:0},s=e.byteRangeStartOffset,i=e.byteRangeEndOffset;if(M(s)&&M(i)){var n;let o=s,l=i;if(a.sn==="initSegment"&&((n=a.decryptdata)==null?void 0:n.method)==="AES-128"){const h=i-s;h%16&&(l=i+(16-h%16)),s!==0&&(r.resetIV=!0,o=s-16)}r.rangeStart=o,r.rangeEnd=l}return r}function dr(a,t){const e=new Error(`GAP ${a.gap?"tag":"attribute"} found`),r={type:G.MEDIA_ERROR,details:b.FRAG_GAP,fatal:!1,frag:a,error:e,networkDetails:null};return t&&(r.part=t),(t||a).stats.aborted=!0,new pt(r)}class pt extends Error{constructor(t){super(t.error.message),this.data=void 0,this.data=t}}class rn{constructor(t){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=t}abort(t){for(const r in this.keyUriToKeyInfo){const s=this.keyUriToKeyInfo[r].loader;if(s){var e;if(t&&t!==((e=s.context)==null?void 0:e.frag.type))return;s.abort()}}}detach(){for(const t in this.keyUriToKeyInfo){const e=this.keyUriToKeyInfo[t];(e.mediaKeySessionContext||e.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[t]}}destroy(){this.detach();for(const t in this.keyUriToKeyInfo){const e=this.keyUriToKeyInfo[t].loader;e&&e.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(t,e=b.KEY_LOAD_ERROR,r,s,i){return new pt({type:G.NETWORK_ERROR,details:e,fatal:!1,frag:t,response:i,error:r,networkDetails:s})}loadClear(t,e){if(this.emeController&&this.config.emeEnabled){const{sn:r,cc:s}=t;for(let i=0;i<e.length;i++){const n=e[i];if(s<=n.cc&&(r==="initSegment"||n.sn==="initSegment"||r<n.sn)){this.emeController.selectKeySystemFormat(n).then(o=>{n.setKeyFormat(o)});break}}}}load(t){return!t.decryptdata&&t.encrypted&&this.emeController?this.emeController.selectKeySystemFormat(t).then(e=>this.loadInternal(t,e)):this.loadInternal(t)}loadInternal(t,e){var r,s;e&&t.setKeyFormat(e);const i=t.decryptdata;if(!i){const h=new Error(e?`Expected frag.decryptdata to be defined after setting format ${e}`:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(t,b.KEY_LOAD_ERROR,h))}const n=i.uri;if(!n)return Promise.reject(this.createKeyLoadError(t,b.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${n}"`)));let o=this.keyUriToKeyInfo[n];if((r=o)!=null&&r.decryptdata.key)return i.key=o.decryptdata.key,Promise.resolve({frag:t,keyInfo:o});if((s=o)!=null&&s.keyLoadPromise){var l;switch((l=o.mediaKeySessionContext)==null?void 0:l.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return o.keyLoadPromise.then(h=>(i.key=h.keyInfo.decryptdata.key,{frag:t,keyInfo:o}))}}switch(o=this.keyUriToKeyInfo[n]={decryptdata:i,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},i.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return i.keyFormat==="identity"?this.loadKeyHTTP(o,t):this.loadKeyEME(o,t);case"AES-128":return this.loadKeyHTTP(o,t);default:return Promise.reject(this.createKeyLoadError(t,b.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${i.method}"`)))}}loadKeyEME(t,e){const r={frag:e,keyInfo:t};if(this.emeController&&this.config.emeEnabled){const s=this.emeController.loadKey(r);if(s)return(t.keyLoadPromise=s.then(i=>(t.mediaKeySessionContext=i,r))).catch(i=>{throw t.keyLoadPromise=null,i})}return Promise.resolve(r)}loadKeyHTTP(t,e){const r=this.config,s=r.loader,i=new s(r);return e.keyLoader=t.loader=i,t.keyLoadPromise=new Promise((n,o)=>{const l={keyInfo:t,frag:e,responseType:"arraybuffer",url:t.decryptdata.uri},h=r.keyLoadPolicy.default,d={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},c={onSuccess:(u,f,g,m)=>{const{frag:p,keyInfo:y,url:T}=g;if(!p.decryptdata||y!==this.keyUriToKeyInfo[T])return o(this.createKeyLoadError(p,b.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),m));y.decryptdata.key=p.decryptdata.key=new Uint8Array(u.data),p.keyLoader=null,y.loader=null,n({frag:p,keyInfo:y})},onError:(u,f,g,m)=>{this.resetLoader(f),o(this.createKeyLoadError(e,b.KEY_LOAD_ERROR,new Error(`HTTP Error ${u.code} loading key ${u.text}`),g,at({url:l.url,data:void 0},u)))},onTimeout:(u,f,g)=>{this.resetLoader(f),o(this.createKeyLoadError(e,b.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),g))},onAbort:(u,f,g)=>{this.resetLoader(f),o(this.createKeyLoadError(e,b.INTERNAL_ABORTED,new Error("key loading aborted"),g))}};i.load(l,d,c)})}resetLoader(t){const{frag:e,keyInfo:r,url:s}=t,i=r.loader;e.keyLoader===i&&(e.keyLoader=null,r.loader=null),delete this.keyUriToKeyInfo[s],i&&i.destroy()}}class sn{constructor(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(t){return this._tickInterval?!1:(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,t),!0)}clearInterval(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1}clearNextTick(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1}tick(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}class Hr{constructor(t,e,r,s=0,i=-1,n=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=Mt(),this.buffering={audio:Mt(),video:Mt(),audiovideo:Mt()},this.level=t,this.sn=e,this.id=r,this.size=s,this.part=i,this.partial=n}}function Mt(){return{start:0,executeStart:0,executeEnd:0,end:0}}function Ut(a,t){for(let r=0,s=a.length;r<s;r++){var e;if(((e=a[r])==null?void 0:e.cc)===t)return a[r]}return null}function nn(a,t,e){return!!(t&&(e.endCC>e.startCC||a&&a.cc<e.startCC))}function an(a,t){const e=a.fragments,r=t.fragments;if(!r.length||!e.length){S.log("No fragments to align");return}const s=Ut(e,r[0].cc);if(!s||s&&!s.startPTS){S.log("No frag in previous level to align on");return}return s}function cr(a,t){if(a){const e=a.start+t;a.start=a.startPTS=e,a.endPTS=e+a.duration}}function Vr(a,t){const e=t.fragments;for(let r=0,s=e.length;r<s;r++)cr(e[r],a);t.fragmentHint&&cr(t.fragmentHint,a),t.alignedSliding=!0}function on(a,t,e){t&&(ln(a,e,t),!e.alignedSliding&&t&&hn(e,t),!e.alignedSliding&&t&&!e.skippedSegments&&Fr(t,e))}function ln(a,t,e){if(nn(a,e,t)){const r=an(e,t);r&&M(r.start)&&(S.log(`Adjusting PTS using last level due to CC increase within current level ${t.url}`),Vr(r.start,t))}}function hn(a,t){if(!a.hasProgramDateTime||!t.hasProgramDateTime)return;const e=a.fragments,r=t.fragments;if(!e.length||!r.length)return;let s,i;const n=Math.min(t.endCC,a.endCC);t.startCC<n&&a.startCC<n&&(s=Ut(r,n),i=Ut(e,n)),(!s||!i)&&(s=r[Math.floor(r.length/2)],i=Ut(e,s.cc)||e[Math.floor(e.length/2)]);const o=s.programDateTime,l=i.programDateTime;if(!o||!l)return;const h=(l-o)/1e3-(i.start-s.start);Vr(h,a)}class dn{constructor(t,e){this.subtle=void 0,this.aesIV=void 0,this.subtle=t,this.aesIV=e}decrypt(t,e){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},e,t)}}class cn{constructor(t,e){this.subtle=void 0,this.key=void 0,this.subtle=t,this.key=e}expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])}}function un(a){const t=a.byteLength,e=t&&new DataView(a.buffer).getUint8(t-1);return e?St(a,0,t-e):a}class fn{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(t){const e=new DataView(t),r=new Uint32Array(4);for(let s=0;s<4;s++)r[s]=e.getUint32(s*4);return r}initTable(){const t=this.sBox,e=this.invSBox,r=this.subMix,s=r[0],i=r[1],n=r[2],o=r[3],l=this.invSubMix,h=l[0],d=l[1],c=l[2],u=l[3],f=new Uint32Array(256);let g=0,m=0,p=0;for(p=0;p<256;p++)p<128?f[p]=p<<1:f[p]=p<<1^283;for(p=0;p<256;p++){let y=m^m<<1^m<<2^m<<3^m<<4;y=y>>>8^y&255^99,t[g]=y,e[y]=g;const T=f[g],A=f[T],R=f[A];let L=f[y]*257^y*16843008;s[g]=L<<24|L>>>8,i[g]=L<<16|L>>>16,n[g]=L<<8|L>>>24,o[g]=L,L=R*16843009^A*65537^T*257^g*16843008,h[y]=L<<24|L>>>8,d[y]=L<<16|L>>>16,c[y]=L<<8|L>>>24,u[y]=L,g?(g=T^f[f[f[R^T]]],m^=f[f[m]]):g=m=1}}expandKey(t){const e=this.uint8ArrayToUint32Array_(t);let r=!0,s=0;for(;s<e.length&&r;)r=e[s]===this.key[s],s++;if(r)return;this.key=e;const i=this.keySize=e.length;if(i!==4&&i!==6&&i!==8)throw new Error("Invalid aes key size="+i);const n=this.ksRows=(i+6+1)*4;let o,l;const h=this.keySchedule=new Uint32Array(n),d=this.invKeySchedule=new Uint32Array(n),c=this.sBox,u=this.rcon,f=this.invSubMix,g=f[0],m=f[1],p=f[2],y=f[3];let T,A;for(o=0;o<n;o++){if(o<i){T=h[o]=e[o];continue}A=T,o%i===0?(A=A<<8|A>>>24,A=c[A>>>24]<<24|c[A>>>16&255]<<16|c[A>>>8&255]<<8|c[A&255],A^=u[o/i|0]<<24):i>6&&o%i===4&&(A=c[A>>>24]<<24|c[A>>>16&255]<<16|c[A>>>8&255]<<8|c[A&255]),h[o]=T=(h[o-i]^A)>>>0}for(l=0;l<n;l++)o=n-l,l&3?A=h[o]:A=h[o-4],l<4||o<=4?d[l]=A:d[l]=g[c[A>>>24]]^m[c[A>>>16&255]]^p[c[A>>>8&255]]^y[c[A&255]],d[l]=d[l]>>>0}networkToHostOrderSwap(t){return t<<24|(t&65280)<<8|(t&16711680)>>8|t>>>24}decrypt(t,e,r){const s=this.keySize+6,i=this.invKeySchedule,n=this.invSBox,o=this.invSubMix,l=o[0],h=o[1],d=o[2],c=o[3],u=this.uint8ArrayToUint32Array_(r);let f=u[0],g=u[1],m=u[2],p=u[3];const y=new Int32Array(t),T=new Int32Array(y.length);let A,R,L,D,I,C,w,O,x,W,_,H,N,V;const k=this.networkToHostOrderSwap;for(;e<y.length;){for(x=k(y[e]),W=k(y[e+1]),_=k(y[e+2]),H=k(y[e+3]),I=x^i[0],C=H^i[1],w=_^i[2],O=W^i[3],N=4,V=1;V<s;V++)A=l[I>>>24]^h[C>>16&255]^d[w>>8&255]^c[O&255]^i[N],R=l[C>>>24]^h[w>>16&255]^d[O>>8&255]^c[I&255]^i[N+1],L=l[w>>>24]^h[O>>16&255]^d[I>>8&255]^c[C&255]^i[N+2],D=l[O>>>24]^h[I>>16&255]^d[C>>8&255]^c[w&255]^i[N+3],I=A,C=R,w=L,O=D,N=N+4;A=n[I>>>24]<<24^n[C>>16&255]<<16^n[w>>8&255]<<8^n[O&255]^i[N],R=n[C>>>24]<<24^n[w>>16&255]<<16^n[O>>8&255]<<8^n[I&255]^i[N+1],L=n[w>>>24]<<24^n[O>>16&255]<<16^n[I>>8&255]<<8^n[C&255]^i[N+2],D=n[O>>>24]<<24^n[I>>16&255]<<16^n[C>>8&255]<<8^n[w&255]^i[N+3],T[e]=k(A^f),T[e+1]=k(D^g),T[e+2]=k(L^m),T[e+3]=k(R^p),f=x,g=W,m=_,p=H,e=e+4}return T.buffer}}const gn=16;class xe{constructor(t,{removePKCS7Padding:e=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.useSoftware=t.enableSoftwareAES,this.removePKCS7Padding=e,e)try{const r=self.crypto;r&&(this.subtle=r.subtle||r.webkitSubtle)}catch{}this.useSoftware=!this.subtle}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:t,remainderData:e}=this;if(!t||e)return this.reset(),null;const r=new Uint8Array(t);return this.reset(),this.removePKCS7Padding?un(r):r}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(t,e,r){return this.useSoftware?new Promise((s,i)=>{this.softwareDecrypt(new Uint8Array(t),e,r);const n=this.flush();n?s(n.buffer):i(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(t),e,r)}softwareDecrypt(t,e,r){const{currentIV:s,currentResult:i,remainderData:n}=this;this.logOnce("JS AES decrypt"),n&&(t=dt(n,t),this.remainderData=null);const o=this.getValidChunk(t);if(!o.length)return null;s&&(r=s);let l=this.softwareDecrypter;l||(l=this.softwareDecrypter=new fn),l.expandKey(e);const h=i;return this.currentResult=l.decrypt(o.buffer,0,r),this.currentIV=St(o,-16).buffer,h||null}webCryptoDecrypt(t,e,r){if(this.key!==e||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(t,e,r));this.key=e,this.fastAesKey=new cn(this.subtle,e)}return this.fastAesKey.expandKey().then(s=>this.subtle?(this.logOnce("WebCrypto AES decrypt"),new dn(this.subtle,new Uint8Array(r)).decrypt(t.buffer,s)):Promise.reject(new Error("web crypto not initialized"))).catch(s=>(S.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${s.name}: ${s.message}`),this.onWebCryptoError(t,e,r)))}onWebCryptoError(t,e,r){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(t,e,r);const s=this.flush();if(s)return s.buffer;throw new Error("WebCrypto and softwareDecrypt: failed to decrypt data")}getValidChunk(t){let e=t;const r=t.length-t.length%gn;return r!==t.length&&(e=St(t,0,r),this.remainderData=St(t,r)),e}logOnce(t){this.logEnabled&&(S.log(`[decrypter]: ${t}`),this.logEnabled=!1)}}const mn={toString:function(a){let t="";const e=a.length;for(let r=0;r<e;r++)t+=`[${a.start(r).toFixed(3)}-${a.end(r).toFixed(3)}]`;return t}},P={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"};class pn extends sn{constructor(t,e,r,s,i){super(),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=P.STOPPED,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.loadedmetadata=!1,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.onvseeking=null,this.onvended=null,this.logPrefix="",this.log=void 0,this.warn=void 0,this.playlistType=i,this.logPrefix=s,this.log=S.log.bind(S,`${s}:`),this.warn=S.warn.bind(S,`${s}:`),this.hls=t,this.fragmentLoader=new en(t.config),this.keyLoader=r,this.fragmentTracker=e,this.config=t.config,this.decrypter=new xe(t.config),t.on(v.MANIFEST_LOADED,this.onManifestLoaded,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(t){}stopLoad(){this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const t=this.fragCurrent;t!=null&&t.loader&&(t.abortRequests(),this.fragmentTracker.removeFragment(t)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=P.STOPPED}_streamEnded(t,e){if(e.live||t.nextStart||!t.end||!this.media)return!1;const r=e.partList;if(r!=null&&r.length){const i=r[r.length-1];return X.isBuffered(this.media,i.start+i.duration/2)}const s=e.fragments[e.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(s)}getLevelDetails(){if(this.levels&&this.levelLastLoaded!==null){var t;return(t=this.levelLastLoaded)==null?void 0:t.details}}onMediaAttached(t,e){const r=this.media=this.mediaBuffer=e.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),r.addEventListener("seeking",this.onvseeking),r.addEventListener("ended",this.onvended);const s=this.config;this.levels&&s.autoStartLoad&&this.state===P.STOPPED&&this.startLoad(s.startPosition)}onMediaDetaching(){const t=this.media;t!=null&&t.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),t&&this.onvseeking&&this.onvended&&(t.removeEventListener("seeking",this.onvseeking),t.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.keyLoader&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}onMediaSeeking(){const{config:t,fragCurrent:e,media:r,mediaBuffer:s,state:i}=this,n=r?r.currentTime:0,o=X.bufferInfo(s||r,n,t.maxBufferHole);if(this.log(`media seeking to ${M(n)?n.toFixed(3):n}, state: ${i}`),this.state===P.ENDED)this.resetLoadingState();else if(e){const l=t.maxFragLookUpTolerance,h=e.start-l,d=e.start+e.duration+l;if(!o.len||d<o.start||h>o.end){const c=n>d;(n<h||c)&&(c&&e.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),e.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}r&&(this.fragmentTracker.removeFragmentsInRange(n,1/0,this.playlistType,!0),this.lastCurrentTime=n),!this.loadedmetadata&&!o.len&&(this.nextLoadPosition=this.startPosition=n),this.tickImmediate()}onMediaEnded(){this.startPosition=this.lastCurrentTime=0}onManifestLoaded(t,e){this.startTimeOffset=e.startTimeOffset,this.initPTS=[]}onHandlerDestroying(){this.hls.off(v.MANIFEST_LOADED,this.onManifestLoaded,this),this.stopLoad(),super.onHandlerDestroying(),this.hls=null}onHandlerDestroyed(){this.state=P.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(t,e,r){this._loadFragForPlayback(t,e,r)}_loadFragForPlayback(t,e,r){const s=i=>{if(this.fragContextChanged(t)){this.warn(`Fragment ${t.sn}${i.part?" p: "+i.part.index:""} of level ${t.level} was dropped during download.`),this.fragmentTracker.removeFragment(t);return}t.stats.chunkCount++,this._handleFragmentLoadProgress(i)};this._doFragLoad(t,e,r,s).then(i=>{if(!i)return;const n=this.state;if(this.fragContextChanged(t)){(n===P.FRAG_LOADING||!this.fragCurrent&&n===P.PARSING)&&(this.fragmentTracker.removeFragment(t),this.state=P.IDLE);return}"payload"in i&&(this.log(`Loaded fragment ${t.sn} of level ${t.level}`),this.hls.trigger(v.FRAG_LOADED,i)),this._handleFragmentLoadComplete(i)}).catch(i=>{this.state===P.STOPPED||this.state===P.ERROR||(this.warn(`Frag error: ${(i==null?void 0:i.message)||i}`),this.resetFragmentLoading(t))})}clearTrackerIfNeeded(t){var e;const{fragmentTracker:r}=this;if(r.getState(t)===st.APPENDING){const s=t.type,i=this.getFwdBufferInfo(this.mediaBuffer,s),n=Math.max(t.duration,i?i.len:this.config.maxBufferLength),o=this.backtrackFragment;((o?t.sn-o.sn:0)===1||this.reduceMaxBufferLength(n))&&r.removeFragment(t)}else((e=this.mediaBuffer)==null?void 0:e.buffered.length)===0?r.removeAllFragments():r.hasParts(t.type)&&(r.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type}),r.getState(t)===st.PARTIAL&&r.removeFragment(t))}checkLiveUpdate(t){if(t.updated&&!t.live){const e=t.fragments[t.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type})}t.fragments[0]||(t.deltaUpdateFailed=!0)}flushMainBuffer(t,e,r=null){if(!(t-e))return;const s={startOffset:t,endOffset:e,type:r};this.hls.trigger(v.BUFFER_FLUSHING,s)}_loadInitSegment(t,e){this._doFragLoad(t,e).then(r=>{if(!r||this.fragContextChanged(t)||!this.levels)throw new Error("init load aborted");return r}).then(r=>{const{hls:s}=this,{payload:i}=r,n=t.decryptdata;if(i&&i.byteLength>0&&n!=null&&n.key&&n.iv&&n.method==="AES-128"){const o=self.performance.now();return this.decrypter.decrypt(new Uint8Array(i),n.key.buffer,n.iv.buffer).catch(l=>{throw s.trigger(v.ERROR,{type:G.MEDIA_ERROR,details:b.FRAG_DECRYPT_ERROR,fatal:!1,error:l,reason:l.message,frag:t}),l}).then(l=>{const h=self.performance.now();return s.trigger(v.FRAG_DECRYPTED,{frag:t,payload:l,stats:{tstart:o,tdecrypt:h}}),r.payload=l,this.completeInitSegmentLoad(r)})}return this.completeInitSegmentLoad(r)}).catch(r=>{this.state===P.STOPPED||this.state===P.ERROR||(this.warn(r),this.resetFragmentLoading(t))})}completeInitSegmentLoad(t){const{levels:e}=this;if(!e)throw new Error("init load aborted, missing levels");const r=t.frag.stats;this.state=P.IDLE,t.frag.data=new Uint8Array(t.payload),r.parsing.start=r.buffering.start=self.performance.now(),r.parsing.end=r.buffering.end=self.performance.now(),this.tick()}fragContextChanged(t){const{fragCurrent:e}=this;return!t||!e||t.sn!==e.sn||t.level!==e.level}fragBufferedComplete(t,e){var r,s,i,n;const o=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${t.type} sn: ${t.sn}${e?" part: "+e.index:""} of ${this.playlistType===j.MAIN?"level":"track"} ${t.level} (frag:[${((r=t.startPTS)!=null?r:NaN).toFixed(3)}-${((s=t.endPTS)!=null?s:NaN).toFixed(3)}] > buffer:${o?mn.toString(X.getBuffered(o)):"(detached)"})`),t.sn!=="initSegment"){var l;if(t.type!==j.SUBTITLE){const d=t.elementaryStreams;if(!Object.keys(d).some(c=>!!d[c])){this.state=P.IDLE;return}}const h=(l=this.levels)==null?void 0:l[t.level];h!=null&&h.fragmentError&&(this.log(`Resetting level fragment error count of ${h.fragmentError} on frag buffered`),h.fragmentError=0)}this.state=P.IDLE,o&&(!this.loadedmetadata&&t.type==j.MAIN&&o.buffered.length&&((i=this.fragCurrent)==null?void 0:i.sn)===((n=this.fragPrevious)==null?void 0:n.sn)&&(this.loadedmetadata=!0,this.seekToStartPos()),this.tick())}seekToStartPos(){}_handleFragmentLoadComplete(t){const{transmuxer:e}=this;if(!e)return;const{frag:r,part:s,partsLoaded:i}=t,n=!i||i.length===0||i.some(l=>!l),o=new Hr(r.level,r.sn,r.stats.chunkCount+1,0,s?s.index:-1,!n);e.flush(o)}_handleFragmentLoadProgress(t){}_doFragLoad(t,e,r=null,s){var i;const n=e==null?void 0:e.details;if(!this.levels||!n)throw new Error(`frag load aborted, missing level${n?"":" detail"}s`);let o=null;if(t.encrypted&&!((i=t.decryptdata)!=null&&i.key)?(this.log(`Loading key for ${t.sn} of [${n.startSN}-${n.endSN}], ${this.logPrefix==="[stream-controller]"?"level":"track"} ${t.level}`),this.state=P.KEY_LOADING,this.fragCurrent=t,o=this.keyLoader.load(t).then(d=>{if(!this.fragContextChanged(d.frag))return this.hls.trigger(v.KEY_LOADED,d),this.state===P.KEY_LOADING&&(this.state=P.IDLE),d}),this.hls.trigger(v.KEY_LOADING,{frag:t}),this.fragCurrent===null&&(o=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING")))):!t.encrypted&&n.encryptedFragments.length&&this.keyLoader.loadClear(t,n.encryptedFragments),r=Math.max(t.start,r||0),this.config.lowLatencyMode&&t.sn!=="initSegment"){const d=n.partList;if(d&&s){r>t.end&&n.fragmentHint&&(t=n.fragmentHint);const c=this.getNextPart(d,t,r);if(c>-1){const u=d[c];this.log(`Loading part sn: ${t.sn} p: ${u.index} cc: ${t.cc} of playlist [${n.startSN}-${n.endSN}] parts [0-${c}-${d.length-1}] ${this.logPrefix==="[stream-controller]"?"level":"track"}: ${t.level}, target: ${parseFloat(r.toFixed(3))}`),this.nextLoadPosition=u.start+u.duration,this.state=P.FRAG_LOADING;let f;return o?f=o.then(g=>!g||this.fragContextChanged(g.frag)?null:this.doFragPartsLoad(t,u,e,s)).catch(g=>this.handleFragLoadError(g)):f=this.doFragPartsLoad(t,u,e,s).catch(g=>this.handleFragLoadError(g)),this.hls.trigger(v.FRAG_LOADING,{frag:t,part:u,targetBufferTime:r}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):f}else if(!t.url||this.loadedEndOfParts(d,r))return Promise.resolve(null)}}this.log(`Loading fragment ${t.sn} cc: ${t.cc} ${n?"of ["+n.startSN+"-"+n.endSN+"] ":""}${this.logPrefix==="[stream-controller]"?"level":"track"}: ${t.level}, target: ${parseFloat(r.toFixed(3))}`),M(t.sn)&&!this.bitrateTest&&(this.nextLoadPosition=t.start+t.duration),this.state=P.FRAG_LOADING;const l=this.config.progressive;let h;return l&&o?h=o.then(d=>!d||this.fragContextChanged(d==null?void 0:d.frag)?null:this.fragmentLoader.load(t,s)).catch(d=>this.handleFragLoadError(d)):h=Promise.all([this.fragmentLoader.load(t,l?s:void 0),o]).then(([d])=>(!l&&d&&s&&s(d),d)).catch(d=>this.handleFragLoadError(d)),this.hls.trigger(v.FRAG_LOADING,{frag:t,targetBufferTime:r}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):h}doFragPartsLoad(t,e,r,s){return new Promise((i,n)=>{var o;const l=[],h=(o=r.details)==null?void 0:o.partList,d=c=>{this.fragmentLoader.loadPart(t,c,s).then(u=>{l[c.index]=u;const f=u.part;this.hls.trigger(v.FRAG_LOADED,u);const g=Ze(r,t.sn,c.index+1)||Or(h,t.sn,c.index+1);if(g)d(g);else return i({frag:t,part:f,partsLoaded:l})}).catch(n)};d(e)})}handleFragLoadError(t){if("data"in t){const e=t.data;t.data&&e.details===b.INTERNAL_ABORTED?this.handleFragLoadAborted(e.frag,e.part):this.hls.trigger(v.ERROR,e)}else this.hls.trigger(v.ERROR,{type:G.OTHER_ERROR,details:b.INTERNAL_EXCEPTION,err:t,error:t,fatal:!0});return null}_handleTransmuxerFlush(t){const e=this.getCurrentContext(t);if(!e||this.state!==P.PARSING){!this.fragCurrent&&this.state!==P.STOPPED&&this.state!==P.ERROR&&(this.state=P.IDLE);return}const{frag:r,part:s,level:i}=e,n=self.performance.now();r.stats.parsing.end=n,s&&(s.stats.parsing.end=n),this.updateLevelTiming(r,s,i,t.partial)}getCurrentContext(t){const{levels:e,fragCurrent:r}=this,{level:s,sn:i,part:n}=t;if(!(e!=null&&e[s]))return this.warn(`Levels object was unset while buffering fragment ${i} of level ${s}. The current chunk will not be buffered.`),null;const o=e[s],l=n>-1?Ze(o,i,n):null,h=l?l.fragment:vi(o,i,r);return h?(r&&r!==h&&(h.stats=r.stats),{frag:h,part:l,level:o}):null}bufferFragmentData(t,e,r,s,i){var n;if(!t||this.state!==P.PARSING)return;const{data1:o,data2:l}=t;let h=o;if(o&&l&&(h=dt(o,l)),!((n=h)!=null&&n.length))return;const d={type:t.type,frag:e,part:r,chunkMeta:s,parent:e.type,data:h};if(this.hls.trigger(v.BUFFER_APPENDING,d),t.dropped&&t.independent&&!r){if(i)return;this.flushBufferGap(e)}}flushBufferGap(t){const e=this.media;if(!e)return;if(!X.isBuffered(e,e.currentTime)){this.flushMainBuffer(0,t.start);return}const r=e.currentTime,s=X.bufferInfo(e,r,0),i=t.duration,n=Math.min(this.config.maxFragLookUpTolerance*2,i*.25),o=Math.max(Math.min(t.start-n,s.end-n),r+n);t.start-o>n&&this.flushMainBuffer(o,t.start)}getFwdBufferInfo(t,e){const r=this.getLoadPosition();return M(r)?this.getFwdBufferInfoAtPos(t,r,e):null}getFwdBufferInfoAtPos(t,e,r){const{config:{maxBufferHole:s}}=this,i=X.bufferInfo(t,e,s);if(i.len===0&&i.nextStart!==void 0){const n=this.fragmentTracker.getBufferedFrag(e,r);if(n&&i.nextStart<n.end)return X.bufferInfo(t,e,Math.max(i.nextStart,s))}return i}getMaxBufferLength(t){const{config:e}=this;let r;return t?r=Math.max(8*e.maxBufferSize/t,e.maxBufferLength):r=e.maxBufferLength,Math.min(r,e.maxMaxBufferLength)}reduceMaxBufferLength(t){const e=this.config,r=t||e.maxBufferLength,s=e.maxMaxBufferLength/2;return s>=r?(e.maxMaxBufferLength=s,this.warn(`Reduce max buffer length to ${s}s`),!0):!1}getAppendedFrag(t,e=j.MAIN){const r=this.fragmentTracker.getAppendedFrag(t,j.MAIN);return r&&"fragment"in r?r.fragment:r}getNextFragment(t,e){const r=e.fragments,s=r.length;if(!s)return null;const{config:i}=this,n=r[0].start;let o;if(e.live){const l=i.initialLiveManifestSize;if(s<l)return this.warn(`Not enough fragments to start playback (have: ${s}, need: ${l})`),null;(!e.PTSKnown&&!this.startFragRequested&&this.startPosition===-1||t<n)&&(o=this.getInitialLiveFragment(e,r),this.startPosition=this.nextLoadPosition=o?this.hls.liveSyncPosition||o.start:t)}else t<=n&&(o=r[0]);if(!o){const l=i.lowLatencyMode?e.partEnd:e.fragmentEnd;o=this.getFragmentAtPosition(t,l,e)}return this.mapToInitFragWhenRequired(o)}isLoopLoading(t,e){const r=this.fragmentTracker.getState(t);return(r===st.OK||r===st.PARTIAL&&!!t.gap)&&this.nextLoadPosition>e}getNextFragmentLoopLoading(t,e,r,s,i){const n=t.gap,o=this.getNextFragment(this.nextLoadPosition,e);if(o===null)return o;if(t=o,n&&t&&!t.gap&&r.nextStart){const l=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,r.nextStart,s);if(l!==null&&r.len+l.len>=i)return this.log(`buffer full after gaps in "${s}" playlist starting at sn: ${t.sn}`),null}return t}mapToInitFragWhenRequired(t){return t!=null&&t.initSegment&&!(t!=null&&t.initSegment.data)&&!this.bitrateTest?t.initSegment:t}getNextPart(t,e,r){let s=-1,i=!1,n=!0;for(let o=0,l=t.length;o<l;o++){const h=t[o];if(n=n&&!h.independent,s>-1&&r<h.start)break;const d=h.loaded;d?s=-1:(i||h.independent||n)&&h.fragment===e&&(s=o),i=d}return s}loadedEndOfParts(t,e){const r=t[t.length-1];return r&&e>r.start&&r.loaded}getInitialLiveFragment(t,e){const r=this.fragPrevious;let s=null;if(r){if(t.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${r.programDateTime}`),s=Ti(e,r.endProgramDateTime,this.config.maxFragLookUpTolerance)),!s){const i=r.sn+1;if(i>=t.startSN&&i<=t.endSN){const n=e[i-t.startSN];r.cc===n.cc&&(s=n,this.log(`Live playlist, switching playlist, load frag with next SN: ${s.sn}`))}s||(s=Si(e,r.cc),s&&this.log(`Live playlist, switching playlist, load frag with same CC: ${s.sn}`))}}else{const i=this.hls.liveSyncPosition;i!==null&&(s=this.getFragmentAtPosition(i,this.bitrateTest?t.fragmentEnd:t.edge,t))}return s}getFragmentAtPosition(t,e,r){const{config:s}=this;let{fragPrevious:i}=this,{fragments:n,endSN:o}=r;const{fragmentHint:l}=r,{maxFragLookUpTolerance:h}=s,d=r.partList,c=!!(s.lowLatencyMode&&d!=null&&d.length&&l);c&&l&&!this.bitrateTest&&(n=n.concat(l),o=l.sn);let u;if(t<e){const f=t>e-h?0:h;u=Br(i,n,t,f)}else u=n[n.length-1];if(u){const f=u.sn-r.startSN,g=this.fragmentTracker.getState(u);if((g===st.OK||g===st.PARTIAL&&u.gap)&&(i=u),i&&u.sn===i.sn&&(!c||d[0].fragment.sn>u.sn)&&i&&u.level===i.level){const m=n[f+1];u.sn<o&&this.fragmentTracker.getState(m)!==st.OK?u=m:u=null}}return u}synchronizeToLiveEdge(t){const{config:e,media:r}=this;if(!r)return;const s=this.hls.liveSyncPosition,i=r.currentTime,n=t.fragments[0].start,o=t.edge,l=i>=n-e.maxFragLookUpTolerance&&i<=o;if(s!==null&&r.duration>s&&(i<s||!l)){const h=e.liveMaxLatencyDuration!==void 0?e.liveMaxLatencyDuration:e.liveMaxLatencyDurationCount*t.targetduration;(!l&&r.readyState<4||i<o-h)&&(this.loadedmetadata||(this.nextLoadPosition=s),r.readyState&&(this.warn(`Playback: ${i.toFixed(3)} is located too far from the end of live sliding playlist: ${o}, reset currentTime to : ${s.toFixed(3)}`),r.currentTime=s))}}alignPlaylists(t,e,r){const s=t.fragments.length;if(!s)return this.warn("No fragments in live playlist"),0;const i=t.fragments[0].start,n=!e,o=t.alignedSliding&&M(i);if(n||!o&&!i){const{fragPrevious:l}=this;on(l,r,t);const h=t.fragments[0].start;return this.log(`Live playlist sliding: ${h.toFixed(2)} start-sn: ${e?e.startSN:"na"}->${t.startSN} prev-sn: ${l?l.sn:"na"} fragments: ${s}`),h}return i}waitForCdnTuneIn(t){return t.live&&t.canBlockReload&&t.partTarget&&t.tuneInGoal>Math.max(t.partHoldBack,t.partTarget*3)}setStartPosition(t,e){let r=this.startPosition;if(r<e&&(r=-1),r===-1||this.lastCurrentTime===-1){const s=this.startTimeOffset!==null,i=s?this.startTimeOffset:t.startTimeOffset;i!==null&&M(i)?(r=e+i,i<0&&(r+=t.totalduration),r=Math.min(Math.max(e,r),e+t.totalduration),this.log(`Start time offset ${i} found in ${s?"multivariant":"media"} playlist, adjust startPosition to ${r}`),this.startPosition=r):t.live?r=this.hls.liveSyncPosition||e:this.startPosition=r=0,this.lastCurrentTime=r}this.nextLoadPosition=r}getLoadPosition(){const{media:t}=this;let e=0;return this.loadedmetadata&&t?e=t.currentTime:this.nextLoadPosition&&(e=this.nextLoadPosition),e}handleFragLoadAborted(t,e){this.transmuxer&&t.sn!=="initSegment"&&t.stats.aborted&&(this.warn(`Fragment ${t.sn}${e?" part "+e.index:""} of level ${t.level} was aborted`),this.resetFragmentLoading(t))}resetFragmentLoading(t){(!this.fragCurrent||!this.fragContextChanged(t)&&this.state!==P.FRAG_LOADING_WAITING_RETRY)&&(this.state=P.IDLE)}onFragmentOrKeyLoadError(t,e){if(e.chunkMeta&&!e.frag){const d=this.getCurrentContext(e.chunkMeta);d&&(e.frag=d.frag)}const r=e.frag;if(!r||r.type!==t||!this.levels)return;if(this.fragContextChanged(r)){var s;this.warn(`Frag load error must match current frag to retry ${r.url} > ${(s=this.fragCurrent)==null?void 0:s.url}`);return}const i=e.details===b.FRAG_GAP;i&&this.fragmentTracker.fragBuffered(r,!0);const n=e.errorAction,{action:o,retryCount:l=0,retryConfig:h}=n||{};if(n&&o===et.RetryRequest&&h){this.resetStartWhenNotLoaded(this.levelLastLoaded);const d=Ie(h,l);this.warn(`Fragment ${r.sn} of ${t} ${r.level} errored with ${e.details}, retrying loading ${l+1}/${h.maxNumRetry} in ${d}ms`),n.resolved=!0,this.retryDate=self.performance.now()+d,this.state=P.FRAG_LOADING_WAITING_RETRY}else if(h&&n)if(this.resetFragmentErrors(t),l<h.maxNumRetry)!i&&o!==et.RemoveAlternatePermanently&&(n.resolved=!0);else{S.warn(`${e.details} reached or exceeded max retry (${l})`);return}else(n==null?void 0:n.action)===et.SendAlternateToPenaltyBox?this.state=P.WAITING_LEVEL:this.state=P.ERROR;this.tickImmediate()}reduceLengthAndFlushBuffer(t){if(this.state===P.PARSING||this.state===P.PARSED){const e=t.parent,r=this.getFwdBufferInfo(this.mediaBuffer,e),s=r&&r.len>.5;s&&this.reduceMaxBufferLength(r.len);const i=!s;return i&&this.warn(`Buffer full error while media.currentTime is not buffered, flush ${e} buffer`),t.frag&&(this.fragmentTracker.removeFragment(t.frag),this.nextLoadPosition=t.frag.start),this.resetLoadingState(),i}return!1}resetFragmentErrors(t){t===j.AUDIO&&(this.fragCurrent=null),this.loadedmetadata||(this.startFragRequested=!1),this.state!==P.STOPPED&&(this.state=P.IDLE)}afterBufferFlushed(t,e,r){if(!t)return;const s=X.getBuffered(t);this.fragmentTracker.detectEvictedFragments(e,s,r),this.state===P.ENDED&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state=P.IDLE}resetStartWhenNotLoaded(t){if(!this.loadedmetadata){this.startFragRequested=!1;const e=t?t.details:null;e!=null&&e.live?(this.startPosition=-1,this.setStartPosition(e,0),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(t){this.warn(`The loading context changed while buffering fragment ${t.sn} of level ${t.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}removeUnbufferedFrags(t=0){this.fragmentTracker.removeFragmentsInRange(t,1/0,this.playlistType,!1,!0)}updateLevelTiming(t,e,r,s){var i;const n=r.details;if(!n){this.warn("level.details undefined");return}if(!Object.keys(t.elementaryStreams).reduce((o,l)=>{const h=t.elementaryStreams[l];if(h){const d=h.endPTS-h.startPTS;if(d<=0)return this.warn(`Could not parse fragment ${t.sn} ${l} duration reliably (${d})`),o||!1;const c=s?0:_r(n,t,h.startPTS,h.endPTS,h.startDTS,h.endDTS);return this.hls.trigger(v.LEVEL_PTS_UPDATED,{details:n,level:r,drift:c,type:l,frag:t,start:h.startPTS,end:h.endPTS}),!0}return o},!1)&&((i=this.transmuxer)==null?void 0:i.error)===null){const o=new Error(`Found no media in fragment ${t.sn} of level ${t.level} resetting transmuxer to fallback to playlist timing`);if(r.fragmentError===0&&(r.fragmentError++,t.gap=!0,this.fragmentTracker.removeFragment(t),this.fragmentTracker.fragBuffered(t,!0)),this.warn(o.message),this.hls.trigger(v.ERROR,{type:G.MEDIA_ERROR,details:b.FRAG_PARSING_ERROR,fatal:!1,error:o,frag:t,reason:`Found no media in msn ${t.sn} of level "${r.url}"`}),!this.hls)return;this.resetTransmuxer()}this.state=P.PARSED,this.hls.trigger(v.FRAG_PARSED,{frag:t,part:e})}resetTransmuxer(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)}recoverWorkerError(t){t.event==="demuxerWorker"&&(this.fragmentTracker.removeAllFragments(),this.resetTransmuxer(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())}set state(t){const e=this._state;e!==t&&(this._state=t,this.log(`${e}->${t}`))}get state(){return this._state}}function Kr(){return self.SourceBuffer||self.WebKitSourceBuffer}function Wr(){if(!At())return!1;const a=Kr();return!a||a.prototype&&typeof a.prototype.appendBuffer=="function"&&typeof a.prototype.remove=="function"}function vn(){if(!Wr())return!1;const a=At();return typeof(a==null?void 0:a.isTypeSupported)=="function"&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some(t=>a.isTypeSupported(ye(t,"video")))||["mp4a.40.2","fLaC"].some(t=>a.isTypeSupported(ye(t,"audio"))))}function yn(){var a;const t=Kr();return typeof(t==null||(a=t.prototype)==null?void 0:a.changeType)=="function"}function Tn(){return typeof __HLS_WORKER_BUNDLE__=="function"}function En(){const a=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),t=self.URL.createObjectURL(a);return{worker:new self.Worker(t),objectURL:t}}function Ln(a){const t=new self.URL(a,self.location.href).href;return{worker:new self.Worker(t),scriptURL:t}}function ft(a="",t=9e4){return{type:a,id:-1,pid:-1,inputTimeScale:t,sequenceNumber:-1,samples:[],dropped:0}}class Yr{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(t,e,r,s){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(t){this.initPTS=t,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(t,e){return!1}appendFrame(t,e,r){}demux(t,e){this.cachedData&&(t=dt(this.cachedData,t),this.cachedData=null);let r=Ht(t,0),s=r?r.length:0,i;const n=this._audioTrack,o=this._id3Track,l=r?Ar(r):void 0,h=t.length;for((this.basePTS===null||this.frameIndex===0&&M(l))&&(this.basePTS=Sn(l,e,this.initPTS),this.lastPTS=this.basePTS),this.lastPTS===null&&(this.lastPTS=this.basePTS),r&&r.length>0&&o.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:r,type:ht.audioId3,duration:Number.POSITIVE_INFINITY});s<h;){if(this.canParse(t,s)){const d=this.appendFrame(n,t,s);d?(this.frameIndex++,this.lastPTS=d.sample.pts,s+=d.length,i=s):s=h}else Ls(t,s)?(r=Ht(t,s),o.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:r,type:ht.audioId3,duration:Number.POSITIVE_INFINITY}),s+=r.length,i=s):s++;if(s===h&&i!==h){const d=St(t,i);this.cachedData?this.cachedData=dt(this.cachedData,d):this.cachedData=d}}return{audioTrack:n,videoTrack:ft(),id3Track:o,textTrack:ft()}}demuxSampleAes(t,e,r){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(t){const e=this.cachedData;return e&&(this.cachedData=null,this.demux(e,0)),{audioTrack:this._audioTrack,videoTrack:ft(),id3Track:this._id3Track,textTrack:ft()}}destroy(){}}const Sn=(a,t,e)=>{if(M(a))return a*90;const r=e?e.baseTime*9e4/e.timescale:0;return t*9e4+r};function An(a,t,e,r){let s,i,n,o;const l=navigator.userAgent.toLowerCase(),h=r,d=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];s=((t[e+2]&192)>>>6)+1;const c=(t[e+2]&60)>>>2;if(c>d.length-1){const u=new Error(`invalid ADTS sampling index:${c}`);a.emit(v.ERROR,v.ERROR,{type:G.MEDIA_ERROR,details:b.FRAG_PARSING_ERROR,fatal:!0,error:u,reason:u.message});return}return n=(t[e+2]&1)<<2,n|=(t[e+3]&192)>>>6,S.log(`manifest codec:${r}, ADTS type:${s}, samplingIndex:${c}`),/firefox/i.test(l)?c>=6?(s=5,o=new Array(4),i=c-3):(s=2,o=new Array(2),i=c):l.indexOf("android")!==-1?(s=2,o=new Array(2),i=c):(s=5,o=new Array(4),r&&(r.indexOf("mp4a.40.29")!==-1||r.indexOf("mp4a.40.5")!==-1)||!r&&c>=6?i=c-3:((r&&r.indexOf("mp4a.40.2")!==-1&&(c>=6&&n===1||/vivaldi/i.test(l))||!r&&n===1)&&(s=2,o=new Array(2)),i=c)),o[0]=s<<3,o[0]|=(c&14)>>1,o[1]|=(c&1)<<7,o[1]|=n<<3,s===5&&(o[1]|=(i&14)>>1,o[2]=(i&1)<<7,o[2]|=8,o[3]=0),{config:o,samplerate:d[c],channelCount:n,codec:"mp4a.40."+s,manifestCodec:h}}function jr(a,t){return a[t]===255&&(a[t+1]&246)===240}function qr(a,t){return a[t+1]&1?7:9}function Ce(a,t){return(a[t+3]&3)<<11|a[t+4]<<3|(a[t+5]&224)>>>5}function Rn(a,t){return t+5<a.length}function Xt(a,t){return t+1<a.length&&jr(a,t)}function bn(a,t){return Rn(a,t)&&jr(a,t)&&Ce(a,t)<=a.length-t}function Dn(a,t){if(Xt(a,t)){const e=qr(a,t);if(t+e>=a.length)return!1;const r=Ce(a,t);if(r<=e)return!1;const s=t+r;return s===a.length||Xt(a,s)}return!1}function zr(a,t,e,r,s){if(!a.samplerate){const i=An(t,e,r,s);if(!i)return;a.config=i.config,a.samplerate=i.samplerate,a.channelCount=i.channelCount,a.codec=i.codec,a.manifestCodec=i.manifestCodec,S.log(`parsed codec:${a.codec}, rate:${i.samplerate}, channels:${i.channelCount}`)}}function Xr(a){return 1024*9e4/a}function In(a,t){const e=qr(a,t);if(t+e<=a.length){const r=Ce(a,t)-e;if(r>0)return{headerLength:e,frameLength:r}}}function Qr(a,t,e,r,s){const i=Xr(a.samplerate),n=r+s*i,o=In(t,e);let l;if(o){const{frameLength:d,headerLength:c}=o,u=c+d,f=Math.max(0,e+u-t.length);f?(l=new Uint8Array(u-c),l.set(t.subarray(e+c,t.length),0)):l=t.subarray(e+c,e+u);const g={unit:l,pts:n};return f||a.samples.push(g),{sample:g,length:u,missing:f}}const h=t.length-e;return l=new Uint8Array(h),l.set(t.subarray(e,t.length),0),{sample:{unit:l,pts:n},length:h,missing:-1}}let Nt=null;const kn=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],xn=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],Cn=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],wn=[0,1,1,4];function Jr(a,t,e,r,s){if(e+24>t.length)return;const i=Zr(t,e);if(i&&e+i.frameLength<=t.length){const n=i.samplesPerFrame*9e4/i.sampleRate,o=r+s*n,l={unit:t.subarray(e,e+i.frameLength),pts:o,dts:o};return a.config=[],a.channelCount=i.channelCount,a.samplerate=i.sampleRate,a.samples.push(l),{sample:l,length:i.frameLength,missing:0}}}function Zr(a,t){const e=a[t+1]>>3&3,r=a[t+1]>>1&3,s=a[t+2]>>4&15,i=a[t+2]>>2&3;if(e!==1&&s!==0&&s!==15&&i!==3){const n=a[t+2]>>1&1,o=a[t+3]>>6,l=e===3?3-r:r===3?3:4,h=kn[l*14+s-1]*1e3,d=xn[(e===3?0:e===2?1:2)*3+i],c=o===3?1:2,u=Cn[e][r],f=wn[r],g=u*8*f,m=Math.floor(u*h/d+n)*f;if(Nt===null){const p=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);Nt=p?parseInt(p[1]):0}return Nt&&Nt<=87&&r===2&&h>=224e3&&o===0&&(a[t+3]=a[t+3]|128),{sampleRate:d,channelCount:c,frameLength:m,samplesPerFrame:g}}}function we(a,t){return a[t]===255&&(a[t+1]&224)===224&&(a[t+1]&6)!==0}function ts(a,t){return t+1<a.length&&we(a,t)}function Pn(a,t){return we(a,t)&&4<=a.length-t}function es(a,t){if(t+1<a.length&&we(a,t)){const e=Zr(a,t);let r=4;e!=null&&e.frameLength&&(r=e.frameLength);const s=t+r;return s===a.length||ts(a,s)}return!1}class _n extends Yr{constructor(t,e){super(),this.observer=void 0,this.config=void 0,this.observer=t,this.config=e}resetInitSegment(t,e,r,s){super.resetInitSegment(t,e,r,s),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:e,duration:s,inputTimeScale:9e4,dropped:0}}static probe(t){if(!t)return!1;const e=Ht(t,0);let r=(e==null?void 0:e.length)||0;if(es(t,r))return!1;for(let s=t.length;r<s;r++)if(Dn(t,r))return S.log("ADTS sync word found !"),!0;return!1}canParse(t,e){return bn(t,e)}appendFrame(t,e,r){zr(t,this.observer,e,r,t.manifestCodec);const s=Qr(t,e,r,this.basePTS,this.frameIndex);if(s&&s.missing===0)return s}}const Fn=/\/emsg[-/]ID3/i;class On{constructor(t,e){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=e}resetTimeStamp(){}resetInitSegment(t,e,r,s){const i=this.videoTrack=ft("video",1),n=this.audioTrack=ft("audio",1),o=this.txtTrack=ft("text",1);if(this.id3Track=ft("id3",1),this.timeOffset=0,!(t!=null&&t.byteLength))return;const l=xr(t);if(l.video){const{id:h,timescale:d,codec:c}=l.video;i.id=h,i.timescale=o.timescale=d,i.codec=c}if(l.audio){const{id:h,timescale:d,codec:c}=l.audio;n.id=h,n.timescale=d,n.codec=c}o.id=Dr.text,i.sampleDuration=0,i.duration=n.duration=s}resetContiguity(){this.remainderData=null}static probe(t){return Cs(t)}demux(t,e){this.timeOffset=e;let r=t;const s=this.videoTrack,i=this.txtTrack;if(this.config.progressive){this.remainderData&&(r=dt(this.remainderData,t));const o=Us(r);this.remainderData=o.remainder,s.samples=o.valid||new Uint8Array}else s.samples=r;const n=this.extractID3Track(s,e);return i.samples=Me(e,s),{videoTrack:s,audioTrack:this.audioTrack,id3Track:n,textTrack:this.txtTrack}}flush(){const t=this.timeOffset,e=this.videoTrack,r=this.txtTrack;e.samples=this.remainderData||new Uint8Array,this.remainderData=null;const s=this.extractID3Track(e,this.timeOffset);return r.samples=Me(t,e),{videoTrack:e,audioTrack:ft(),id3Track:s,textTrack:ft()}}extractID3Track(t,e){const r=this.id3Track;if(t.samples.length){const s=$(t.samples,["emsg"]);s&&s.forEach(i=>{const n=Hs(i);if(Fn.test(n.schemeIdUri)){const o=M(n.presentationTime)?n.presentationTime/n.timeScale:e+n.presentationTimeDelta/n.timeScale;let l=n.eventDuration===4294967295?Number.POSITIVE_INFINITY:n.eventDuration/n.timeScale;l<=.001&&(l=Number.POSITIVE_INFINITY);const h=n.payload;r.samples.push({data:h,len:h.byteLength,dts:o,pts:o,type:ht.emsg,duration:l})}})}return r}demuxSampleAes(t,e,r){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){}}const Mn=(a,t)=>{let e=0,r=5;t+=r;const s=new Uint32Array(1),i=new Uint32Array(1),n=new Uint8Array(1);for(;r>0;){n[0]=a[t];const o=Math.min(r,8),l=8-o;i[0]=4278190080>>>24+l<<l,s[0]=(n[0]&i[0])>>l,e=e?e<<o|s[0]:s[0],t+=1,r-=o}return e};class Nn{constructor(){this.VideoSample=null}createVideoSample(t,e,r,s){return{key:t,frame:!1,pts:e,dts:r,units:[],debug:s,length:0}}getLastNalUnit(t){var e;let r=this.VideoSample,s;if((!r||r.units.length===0)&&(r=t[t.length-1]),(e=r)!=null&&e.units){const i=r.units;s=i[i.length-1]}return s}pushAccessUnit(t,e){if(t.units.length&&t.frame){if(t.pts===void 0){const r=e.samples,s=r.length;if(s){const i=r[s-1];t.pts=i.pts,t.dts=i.dts}else{e.dropped++;return}}e.samples.push(t)}t.debug.length&&S.log(t.pts+"/"+t.dts+":"+t.debug)}}class ur{constructor(t){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=t,this.bytesAvailable=t.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const t=this.data,e=this.bytesAvailable,r=t.byteLength-e,s=new Uint8Array(4),i=Math.min(4,e);if(i===0)throw new Error("no bytes available");s.set(t.subarray(r,r+i)),this.word=new DataView(s.buffer).getUint32(0),this.bitsAvailable=i*8,this.bytesAvailable-=i}skipBits(t){let e;t=Math.min(t,this.bytesAvailable*8+this.bitsAvailable),this.bitsAvailable>t?(this.word<<=t,this.bitsAvailable-=t):(t-=this.bitsAvailable,e=t>>3,t-=e<<3,this.bytesAvailable-=e,this.loadWord(),this.word<<=t,this.bitsAvailable-=t)}readBits(t){let e=Math.min(this.bitsAvailable,t);const r=this.word>>>32-e;if(t>32&&S.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=e,this.bitsAvailable>0)this.word<<=e;else if(this.bytesAvailable>0)this.loadWord();else throw new Error("no bits available");return e=t-e,e>0&&this.bitsAvailable?r<<e|this.readBits(e):r}skipLZ(){let t;for(t=0;t<this.bitsAvailable;++t)if(this.word&2147483648>>>t)return this.word<<=t,this.bitsAvailable-=t,t;return this.loadWord(),t+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const t=this.skipLZ();return this.readBits(t+1)-1}readEG(){const t=this.readUEG();return 1&t?1+t>>>1:-1*(t>>>1)}readBoolean(){return this.readBits(1)===1}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(t){let e=8,r=8,s;for(let i=0;i<t;i++)r!==0&&(s=this.readEG(),r=(e+s+256)%256),e=r===0?e:r}readSPS(){let t=0,e=0,r=0,s=0,i,n,o;const l=this.readUByte.bind(this),h=this.readBits.bind(this),d=this.readUEG.bind(this),c=this.readBoolean.bind(this),u=this.skipBits.bind(this),f=this.skipEG.bind(this),g=this.skipUEG.bind(this),m=this.skipScalingList.bind(this);l();const p=l();if(h(5),u(3),l(),g(),p===100||p===110||p===122||p===244||p===44||p===83||p===86||p===118||p===128){const D=d();if(D===3&&u(1),g(),g(),u(1),c())for(n=D!==3?8:12,o=0;o<n;o++)c()&&(o<6?m(16):m(64))}g();const y=d();if(y===0)d();else if(y===1)for(u(1),f(),f(),i=d(),o=0;o<i;o++)f();g(),u(1);const T=d(),A=d(),R=h(1);R===0&&u(1),u(1),c()&&(t=d(),e=d(),r=d(),s=d());let L=[1,1];if(c()&&c())switch(l()){case 1:L=[1,1];break;case 2:L=[12,11];break;case 3:L=[10,11];break;case 4:L=[16,11];break;case 5:L=[40,33];break;case 6:L=[24,11];break;case 7:L=[20,11];break;case 8:L=[32,11];break;case 9:L=[80,33];break;case 10:L=[18,11];break;case 11:L=[15,11];break;case 12:L=[64,33];break;case 13:L=[160,99];break;case 14:L=[4,3];break;case 15:L=[3,2];break;case 16:L=[2,1];break;case 255:{L=[l()<<8|l(),l()<<8|l()];break}}return{width:Math.ceil((T+1)*16-t*2-e*2),height:(2-R)*(A+1)*16-(R?2:4)*(r+s),pixelRatio:L}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}}class Bn extends Nn{parseAVCPES(t,e,r,s,i){const n=this.parseAVCNALu(t,r.data);let o=this.VideoSample,l,h=!1;r.data=null,o&&n.length&&!t.audFound&&(this.pushAccessUnit(o,t),o=this.VideoSample=this.createVideoSample(!1,r.pts,r.dts,"")),n.forEach(d=>{var c;switch(d.type){case 1:{let m=!1;l=!0;const p=d.data;if(h&&p.length>4){const y=new ur(p).readSliceType();(y===2||y===4||y===7||y===9)&&(m=!0)}if(m){var u;(u=o)!=null&&u.frame&&!o.key&&(this.pushAccessUnit(o,t),o=this.VideoSample=null)}o||(o=this.VideoSample=this.createVideoSample(!0,r.pts,r.dts,"")),o.frame=!0,o.key=m;break}case 5:l=!0,(c=o)!=null&&c.frame&&!o.key&&(this.pushAccessUnit(o,t),o=this.VideoSample=null),o||(o=this.VideoSample=this.createVideoSample(!0,r.pts,r.dts,"")),o.key=!0,o.frame=!0;break;case 6:{l=!0,Cr(d.data,1,r.pts,e.samples);break}case 7:{var f,g;l=!0,h=!0;const m=d.data,p=new ur(m).readSPS();if(!t.sps||t.width!==p.width||t.height!==p.height||((f=t.pixelRatio)==null?void 0:f[0])!==p.pixelRatio[0]||((g=t.pixelRatio)==null?void 0:g[1])!==p.pixelRatio[1]){t.width=p.width,t.height=p.height,t.pixelRatio=p.pixelRatio,t.sps=[m],t.duration=i;const y=m.subarray(1,4);let T="avc1.";for(let A=0;A<3;A++){let R=y[A].toString(16);R.length<2&&(R="0"+R),T+=R}t.codec=T}break}case 8:l=!0,t.pps=[d.data];break;case 9:l=!0,t.audFound=!0,o&&this.pushAccessUnit(o,t),o=this.VideoSample=this.createVideoSample(!1,r.pts,r.dts,"");break;case 12:l=!0;break;default:l=!1,o&&(o.debug+="unknown NAL "+d.type+" ");break}o&&l&&o.units.push(d)}),s&&o&&(this.pushAccessUnit(o,t),this.VideoSample=null)}parseAVCNALu(t,e){const r=e.byteLength;let s=t.naluState||0;const i=s,n=[];let o=0,l,h,d,c=-1,u=0;for(s===-1&&(c=0,u=e[0]&31,s=0,o=1);o<r;){if(l=e[o++],!s){s=l?0:1;continue}if(s===1){s=l?0:2;continue}if(!l)s=3;else if(l===1){if(h=o-s-1,c>=0){const f={data:e.subarray(c,h),type:u};n.push(f)}else{const f=this.getLastNalUnit(t.samples);f&&(i&&o<=4-i&&f.state&&(f.data=f.data.subarray(0,f.data.byteLength-i)),h>0&&(f.data=dt(f.data,e.subarray(0,h)),f.state=0))}o<r?(d=e[o]&31,c=o,u=d,s=0):s=-1}else s=0}if(c>=0&&s>=0){const f={data:e.subarray(c,r),type:u,state:s};n.push(f)}if(n.length===0){const f=this.getLastNalUnit(t.samples);f&&(f.data=dt(f.data,e))}return t.naluState=s,n}}class Un{constructor(t,e,r){this.keyData=void 0,this.decrypter=void 0,this.keyData=r,this.decrypter=new xe(e,{removePKCS7Padding:!1})}decryptBuffer(t){return this.decrypter.decrypt(t,this.keyData.key.buffer,this.keyData.iv.buffer)}decryptAacSample(t,e,r){const s=t[e].unit;if(s.length<=16)return;const i=s.subarray(16,s.length-s.length%16),n=i.buffer.slice(i.byteOffset,i.byteOffset+i.length);this.decryptBuffer(n).then(o=>{const l=new Uint8Array(o);s.set(l,16),this.decrypter.isSync()||this.decryptAacSamples(t,e+1,r)})}decryptAacSamples(t,e,r){for(;;e++){if(e>=t.length){r();return}if(!(t[e].unit.length<32)&&(this.decryptAacSample(t,e,r),!this.decrypter.isSync()))return}}getAvcEncryptedData(t){const e=Math.floor((t.length-48)/160)*16+16,r=new Int8Array(e);let s=0;for(let i=32;i<t.length-16;i+=160,s+=16)r.set(t.subarray(i,i+16),s);return r}getAvcDecryptedUnit(t,e){const r=new Uint8Array(e);let s=0;for(let i=32;i<t.length-16;i+=160,s+=16)t.set(r.subarray(s,s+16),i);return t}decryptAvcSample(t,e,r,s,i){const n=wr(i.data),o=this.getAvcEncryptedData(n);this.decryptBuffer(o.buffer).then(l=>{i.data=this.getAvcDecryptedUnit(n,l),this.decrypter.isSync()||this.decryptAvcSamples(t,e,r+1,s)})}decryptAvcSamples(t,e,r,s){if(t instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;e++,r=0){if(e>=t.length){s();return}const i=t[e].units;for(;!(r>=i.length);r++){const n=i[r];if(!(n.data.length<=48||n.type!==1&&n.type!==5)&&(this.decryptAvcSample(t,e,r,s,n),!this.decrypter.isSync()))return}}}}const Z=188;class Tt{constructor(t,e,r){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=t,this.config=e,this.typeSupported=r,this.videoParser=new Bn}static probe(t){const e=Tt.syncOffset(t);return e>0&&S.warn(`MPEG2-TS detected but first sync word found @ offset ${e}`),e!==-1}static syncOffset(t){const e=t.length;let r=Math.min(Z*5,e-Z)+1,s=0;for(;s<r;){let i=!1,n=-1,o=0;for(let l=s;l<e;l+=Z)if(t[l]===71&&(e-l===Z||t[l+Z]===71)){if(o++,n===-1&&(n=l,n!==0&&(r=Math.min(n+Z*99,t.length-Z)+1)),i||(i=Ae(t,l)===0),i&&o>1&&(n===0&&o>2||l+Z>r))return n}else{if(o)return-1;break}s++}return-1}static createTrack(t,e){return{container:t==="video"||t==="audio"?"video/mp2t":void 0,type:t,id:Dr[t],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:t==="audio"?e:void 0}}resetInitSegment(t,e,r,s){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=Tt.createTrack("video"),this._audioTrack=Tt.createTrack("audio",s),this._id3Track=Tt.createTrack("id3"),this._txtTrack=Tt.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=e,this.videoCodec=r,this._duration=s}resetTimeStamp(){}resetContiguity(){const{_audioTrack:t,_videoTrack:e,_id3Track:r}=this;t&&(t.pesData=null),e&&(e.pesData=null),r&&(r.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(t,e,r=!1,s=!1){r||(this.sampleAes=null);let i;const n=this._videoTrack,o=this._audioTrack,l=this._id3Track,h=this._txtTrack;let d=n.pid,c=n.pesData,u=o.pid,f=l.pid,g=o.pesData,m=l.pesData,p=null,y=this.pmtParsed,T=this._pmtId,A=t.length;if(this.remainderData&&(t=dt(this.remainderData,t),A=t.length,this.remainderData=null),A<Z&&!s)return this.remainderData=t,{audioTrack:o,videoTrack:n,id3Track:l,textTrack:h};const R=Math.max(0,Tt.syncOffset(t));A-=(A-R)%Z,A<t.byteLength&&!s&&(this.remainderData=new Uint8Array(t.buffer,A,t.buffer.byteLength-A));let L=0;for(let I=R;I<A;I+=Z)if(t[I]===71){const C=!!(t[I+1]&64),w=Ae(t,I),O=(t[I+3]&48)>>4;let x;if(O>1){if(x=I+5+t[I+4],x===I+Z)continue}else x=I+4;switch(w){case d:C&&(c&&(i=Dt(c))&&this.videoParser.parseAVCPES(n,h,i,!1,this._duration),c={data:[],size:0}),c&&(c.data.push(t.subarray(x,I+Z)),c.size+=I+Z-x);break;case u:if(C){if(g&&(i=Dt(g)))switch(o.segmentCodec){case"aac":this.parseAACPES(o,i);break;case"mp3":this.parseMPEGPES(o,i);break}g={data:[],size:0}}g&&(g.data.push(t.subarray(x,I+Z)),g.size+=I+Z-x);break;case f:C&&(m&&(i=Dt(m))&&this.parseID3PES(l,i),m={data:[],size:0}),m&&(m.data.push(t.subarray(x,I+Z)),m.size+=I+Z-x);break;case 0:C&&(x+=t[x]+1),T=this._pmtId=$n(t,x);break;case T:{C&&(x+=t[x]+1);const W=Gn(t,x,this.typeSupported,r,this.observer);d=W.videoPid,d>0&&(n.pid=d,n.segmentCodec=W.segmentVideoCodec),u=W.audioPid,u>0&&(o.pid=u,o.segmentCodec=W.segmentAudioCodec),f=W.id3Pid,f>0&&(l.pid=f),p!==null&&!y&&(S.warn(`MPEG-TS PMT found at ${I} after unknown PID '${p}'. Backtracking to sync byte @${R} to parse all TS packets.`),p=null,I=R-188),y=this.pmtParsed=!0;break}case 17:case 8191:break;default:p=w;break}}else L++;L>0&&Qt(this.observer,new Error(`Found ${L} TS packet/s that do not start with 0x47`)),n.pesData=c,o.pesData=g,l.pesData=m;const D={audioTrack:o,videoTrack:n,id3Track:l,textTrack:h};return s&&this.extractRemainingSamples(D),D}flush(){const{remainderData:t}=this;this.remainderData=null;let e;return t?e=this.demux(t,-1,!1,!0):e={videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(e),this.sampleAes?this.decrypt(e,this.sampleAes):e}extractRemainingSamples(t){const{audioTrack:e,videoTrack:r,id3Track:s,textTrack:i}=t,n=r.pesData,o=e.pesData,l=s.pesData;let h;if(n&&(h=Dt(n))?(this.videoParser.parseAVCPES(r,i,h,!0,this._duration),r.pesData=null):r.pesData=n,o&&(h=Dt(o))){switch(e.segmentCodec){case"aac":this.parseAACPES(e,h);break;case"mp3":this.parseMPEGPES(e,h);break}e.pesData=null}else o!=null&&o.size&&S.log("last AAC PES packet truncated,might overlap between fragments"),e.pesData=o;l&&(h=Dt(l))?(this.parseID3PES(s,h),s.pesData=null):s.pesData=l}demuxSampleAes(t,e,r){const s=this.demux(t,r,!0,!this.config.progressive),i=this.sampleAes=new Un(this.observer,this.config,e);return this.decrypt(s,i)}decrypt(t,e){return new Promise(r=>{const{audioTrack:s,videoTrack:i}=t;s.samples&&s.segmentCodec==="aac"?e.decryptAacSamples(s.samples,0,()=>{i.samples?e.decryptAvcSamples(i.samples,0,0,()=>{r(t)}):r(t)}):i.samples&&e.decryptAvcSamples(i.samples,0,0,()=>{r(t)})})}destroy(){this._duration=0}parseAACPES(t,e){let r=0;const s=this.aacOverFlow;let i=e.data;if(s){this.aacOverFlow=null;const c=s.missing,u=s.sample.unit.byteLength;if(c===-1)i=dt(s.sample.unit,i);else{const f=u-c;s.sample.unit.set(i.subarray(0,c),f),t.samples.push(s.sample),r=s.missing}}let n,o;for(n=r,o=i.length;n<o-1&&!Xt(i,n);n++);if(n!==r){let c;const u=n<o-1;if(u?c=`AAC PES did not start with ADTS header,offset:${n}`:c="No ADTS header found in AAC PES",Qt(this.observer,new Error(c),u),!u)return}zr(t,this.observer,i,n,this.audioCodec);let l;if(e.pts!==void 0)l=e.pts;else if(s){const c=Xr(t.samplerate);l=s.sample.pts+c}else{S.warn("[tsdemuxer]: AAC PES unknown PTS");return}let h=0,d;for(;n<o;)if(d=Qr(t,i,n,l,h),n+=d.length,d.missing){this.aacOverFlow=d;break}else for(h++;n<o-1&&!Xt(i,n);n++);}parseMPEGPES(t,e){const r=e.data,s=r.length;let i=0,n=0;const o=e.pts;if(o===void 0){S.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;n<s;)if(ts(r,n)){const l=Jr(t,r,n,o,i);if(l)n+=l.length,i++;else break}else n++}parseAC3PES(t,e){}parseID3PES(t,e){if(e.pts===void 0){S.warn("[tsdemuxer]: ID3 PES unknown PTS");return}const r=it({},e,{type:this._videoTrack?ht.emsg:ht.audioId3,duration:Number.POSITIVE_INFINITY});t.samples.push(r)}}function Ae(a,t){return((a[t+1]&31)<<8)+a[t+2]}function $n(a,t){return(a[t+10]&31)<<8|a[t+11]}function Gn(a,t,e,r,s){const i={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},n=(a[t+1]&15)<<8|a[t+2],o=t+3+n-4,l=(a[t+10]&15)<<8|a[t+11];for(t+=12+l;t<o;){const h=Ae(a,t),d=(a[t+3]&15)<<8|a[t+4];switch(a[t]){case 207:if(!r){ce("ADTS AAC");break}case 15:i.audioPid===-1&&(i.audioPid=h);break;case 21:i.id3Pid===-1&&(i.id3Pid=h);break;case 219:if(!r){ce("H.264");break}case 27:i.videoPid===-1&&(i.videoPid=h,i.segmentVideoCodec="avc");break;case 3:case 4:!e.mpeg&&!e.mp3?S.log("MPEG audio found, not supported in this browser"):i.audioPid===-1&&(i.audioPid=h,i.segmentAudioCodec="mp3");break;case 193:if(!r){ce("AC-3");break}case 129:S.warn("AC-3 in M2TS support not included in build");break;case 6:if(i.audioPid===-1&&d>0){let c=t+5,u=d;for(;u>2;){switch(a[c]){case 106:S.warn("AC-3 in M2TS support not included in build");break}const f=a[c+1]+2;c+=f,u-=f}}break;case 194:case 135:return Qt(s,new Error("Unsupported EC-3 in M2TS found")),i;case 36:return Qt(s,new Error("Unsupported HEVC in M2TS found")),i}t+=d+5}return i}function Qt(a,t,e){S.warn(`parsing error: ${t.message}`),a.emit(v.ERROR,v.ERROR,{type:G.MEDIA_ERROR,details:b.FRAG_PARSING_ERROR,fatal:!1,levelRetry:e,error:t,reason:t.message})}function ce(a){S.log(`${a} with AES-128-CBC encryption found in unencrypted stream`)}function Dt(a){let t=0,e,r,s,i,n;const o=a.data;if(!a||a.size===0)return null;for(;o[0].length<19&&o.length>1;)o[0]=dt(o[0],o[1]),o.splice(1,1);if(e=o[0],(e[0]<<16)+(e[1]<<8)+e[2]===1){if(r=(e[4]<<8)+e[5],r&&r>a.size-6)return null;const l=e[7];l&192&&(i=(e[9]&14)*536870912+(e[10]&255)*4194304+(e[11]&254)*16384+(e[12]&255)*128+(e[13]&254)/2,l&64?(n=(e[14]&14)*536870912+(e[15]&255)*4194304+(e[16]&254)*16384+(e[17]&255)*128+(e[18]&254)/2,i-n>60*9e4&&(S.warn(`${Math.round((i-n)/9e4)}s delta between PTS and DTS, align them`),i=n)):n=i),s=e[8];let h=s+9;if(a.size<=h)return null;a.size-=h;const d=new Uint8Array(a.size);for(let c=0,u=o.length;c<u;c++){e=o[c];let f=e.byteLength;if(h)if(h>f){h-=f;continue}else e=e.subarray(h),f-=h,h=0;d.set(e,t),t+=f}return r&&(r-=s+3),{data:d,pts:i,dts:n,len:r}}return null}class Hn extends Yr{resetInitSegment(t,e,r,s){super.resetInitSegment(t,e,r,s),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:e,duration:s,inputTimeScale:9e4,dropped:0}}static probe(t){if(!t)return!1;const e=Ht(t,0);let r=(e==null?void 0:e.length)||0;if(e&&t[r]===11&&t[r+1]===119&&Ar(e)!==void 0&&Mn(t,r)<=16)return!1;for(let s=t.length;r<s;r++)if(es(t,r))return S.log("MPEG Audio sync word found !"),!0;return!1}canParse(t,e){return Pn(t,e)}appendFrame(t,e,r){if(this.basePTS!==null)return Jr(t,e,r,this.basePTS,this.frameIndex)}}class fr{static getSilentFrame(t,e){switch(t){case"mp4a.40.2":if(e===1)return new Uint8Array([0,200,0,128,35,128]);if(e===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(e===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(e===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(e===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(e===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(e===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(e===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(e===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}}}const yt=Math.pow(2,32)-1;class E{static init(){E.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};let t;for(t in E.types)E.types.hasOwnProperty(t)&&(E.types[t]=[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)]);const e=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),r=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);E.HDLR_TYPES={video:e,audio:r};const s=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),i=new Uint8Array([0,0,0,0,0,0,0,0]);E.STTS=E.STSC=E.STCO=i,E.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),E.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),E.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),E.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const n=new Uint8Array([105,115,111,109]),o=new Uint8Array([97,118,99,49]),l=new Uint8Array([0,0,0,1]);E.FTYP=E.box(E.types.ftyp,n,l,n,o),E.DINF=E.box(E.types.dinf,E.box(E.types.dref,s))}static box(t,...e){let r=8,s=e.length;const i=s;for(;s--;)r+=e[s].byteLength;const n=new Uint8Array(r);for(n[0]=r>>24&255,n[1]=r>>16&255,n[2]=r>>8&255,n[3]=r&255,n.set(t,4),s=0,r=8;s<i;s++)n.set(e[s],r),r+=e[s].byteLength;return n}static hdlr(t){return E.box(E.types.hdlr,E.HDLR_TYPES[t])}static mdat(t){return E.box(E.types.mdat,t)}static mdhd(t,e){e*=t;const r=Math.floor(e/(yt+1)),s=Math.floor(e%(yt+1));return E.box(E.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,r>>24,r>>16&255,r>>8&255,r&255,s>>24,s>>16&255,s>>8&255,s&255,85,196,0,0]))}static mdia(t){return E.box(E.types.mdia,E.mdhd(t.timescale,t.duration),E.hdlr(t.type),E.minf(t))}static mfhd(t){return E.box(E.types.mfhd,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255]))}static minf(t){return t.type==="audio"?E.box(E.types.minf,E.box(E.types.smhd,E.SMHD),E.DINF,E.stbl(t)):E.box(E.types.minf,E.box(E.types.vmhd,E.VMHD),E.DINF,E.stbl(t))}static moof(t,e,r){return E.box(E.types.moof,E.mfhd(t),E.traf(r,e))}static moov(t){let e=t.length;const r=[];for(;e--;)r[e]=E.trak(t[e]);return E.box.apply(null,[E.types.moov,E.mvhd(t[0].timescale,t[0].duration)].concat(r).concat(E.mvex(t)))}static mvex(t){let e=t.length;const r=[];for(;e--;)r[e]=E.trex(t[e]);return E.box.apply(null,[E.types.mvex,...r])}static mvhd(t,e){e*=t;const r=Math.floor(e/(yt+1)),s=Math.floor(e%(yt+1)),i=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,r>>24,r>>16&255,r>>8&255,r&255,s>>24,s>>16&255,s>>8&255,s&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return E.box(E.types.mvhd,i)}static sdtp(t){const e=t.samples||[],r=new Uint8Array(4+e.length);let s,i;for(s=0;s<e.length;s++)i=e[s].flags,r[s+4]=i.dependsOn<<4|i.isDependedOn<<2|i.hasRedundancy;return E.box(E.types.sdtp,r)}static stbl(t){return E.box(E.types.stbl,E.stsd(t),E.box(E.types.stts,E.STTS),E.box(E.types.stsc,E.STSC),E.box(E.types.stsz,E.STSZ),E.box(E.types.stco,E.STCO))}static avc1(t){let e=[],r=[],s,i,n;for(s=0;s<t.sps.length;s++)i=t.sps[s],n=i.byteLength,e.push(n>>>8&255),e.push(n&255),e=e.concat(Array.prototype.slice.call(i));for(s=0;s<t.pps.length;s++)i=t.pps[s],n=i.byteLength,r.push(n>>>8&255),r.push(n&255),r=r.concat(Array.prototype.slice.call(i));const o=E.box(E.types.avcC,new Uint8Array([1,e[3],e[4],e[5],255,224|t.sps.length].concat(e).concat([t.pps.length]).concat(r))),l=t.width,h=t.height,d=t.pixelRatio[0],c=t.pixelRatio[1];return E.box(E.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,l>>8&255,l&255,h>>8&255,h&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),o,E.box(E.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),E.box(E.types.pasp,new Uint8Array([d>>24,d>>16&255,d>>8&255,d&255,c>>24,c>>16&255,c>>8&255,c&255])))}static esds(t){const e=t.config.length;return new Uint8Array([0,0,0,0,3,23+e,0,1,0,4,15+e,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([e]).concat(t.config).concat([6,1,2]))}static audioStsd(t){const e=t.samplerate;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,e>>8&255,e&255,0,0])}static mp4a(t){return E.box(E.types.mp4a,E.audioStsd(t),E.box(E.types.esds,E.esds(t)))}static mp3(t){return E.box(E.types[".mp3"],E.audioStsd(t))}static ac3(t){return E.box(E.types["ac-3"],E.audioStsd(t),E.box(E.types.dac3,t.config))}static stsd(t){return t.type==="audio"?t.segmentCodec==="mp3"&&t.codec==="mp3"?E.box(E.types.stsd,E.STSD,E.mp3(t)):t.segmentCodec==="ac3"?E.box(E.types.stsd,E.STSD,E.ac3(t)):E.box(E.types.stsd,E.STSD,E.mp4a(t)):E.box(E.types.stsd,E.STSD,E.avc1(t))}static tkhd(t){const e=t.id,r=t.duration*t.timescale,s=t.width,i=t.height,n=Math.floor(r/(yt+1)),o=Math.floor(r%(yt+1));return E.box(E.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,0,0,0,0,n>>24,n>>16&255,n>>8&255,n&255,o>>24,o>>16&255,o>>8&255,o&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,s>>8&255,s&255,0,0,i>>8&255,i&255,0,0]))}static traf(t,e){const r=E.sdtp(t),s=t.id,i=Math.floor(e/(yt+1)),n=Math.floor(e%(yt+1));return E.box(E.types.traf,E.box(E.types.tfhd,new Uint8Array([0,0,0,0,s>>24,s>>16&255,s>>8&255,s&255])),E.box(E.types.tfdt,new Uint8Array([1,0,0,0,i>>24,i>>16&255,i>>8&255,i&255,n>>24,n>>16&255,n>>8&255,n&255])),E.trun(t,r.length+16+20+8+16+8+8),r)}static trak(t){return t.duration=t.duration||4294967295,E.box(E.types.trak,E.tkhd(t),E.mdia(t))}static trex(t){const e=t.id;return E.box(E.types.trex,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(t,e){const r=t.samples||[],s=r.length,i=12+16*s,n=new Uint8Array(i);let o,l,h,d,c,u;for(e+=8+i,n.set([t.type==="video"?1:0,0,15,1,s>>>24&255,s>>>16&255,s>>>8&255,s&255,e>>>24&255,e>>>16&255,e>>>8&255,e&255],0),o=0;o<s;o++)l=r[o],h=l.duration,d=l.size,c=l.flags,u=l.cts,n.set([h>>>24&255,h>>>16&255,h>>>8&255,h&255,d>>>24&255,d>>>16&255,d>>>8&255,d&255,c.isLeading<<2|c.dependsOn,c.isDependedOn<<6|c.hasRedundancy<<4|c.paddingValue<<1|c.isNonSync,c.degradPrio&61440,c.degradPrio&15,u>>>24&255,u>>>16&255,u>>>8&255,u&255],12+16*o);return E.box(E.types.trun,n)}static initSegment(t){E.types||E.init();const e=E.moov(t);return dt(E.FTYP,e)}}E.types=void 0;E.HDLR_TYPES=void 0;E.STTS=void 0;E.STSC=void 0;E.STCO=void 0;E.STSZ=void 0;E.VMHD=void 0;E.SMHD=void 0;E.STSD=void 0;E.FTYP=void 0;E.DINF=void 0;const Vn=9e4;function Kn(a,t,e=1,r=!1){const s=a*t*e;return r?Math.round(s):s}function Ct(a,t=!1){return Kn(a,1e3,1/Vn,t)}const Wn=10*1e3,gr=1024,Yn=1152,jn=1536;let It=null,ue=null;class fe{constructor(t,e,r,s=""){if(this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=t,this.config=e,this.typeSupported=r,this.ISGenerated=!1,It===null){const i=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);It=i?parseInt(i[1]):0}if(ue===null){const i=navigator.userAgent.match(/Safari\/(\d+)/i);ue=i?parseInt(i[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(t){S.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=t}resetNextTimestamp(){S.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){S.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(t){let e=!1;const r=t.reduce((s,i)=>{const n=i.pts-s;return n<-4294967296?(e=!0,lt(s,i.pts)):n>0?s:i.pts},t[0].pts);return e&&S.debug("PTS rollover detected"),r}remux(t,e,r,s,i,n,o,l){let h,d,c,u,f,g,m=i,p=i;const y=t.pid>-1,T=e.pid>-1,A=e.samples.length,R=t.samples.length>0,L=o&&A>0||A>1;if((!y||R)&&(!T||L)||this.ISGenerated||o){if(this.ISGenerated){var D,I,C,w;const _=this.videoTrackConfig;_&&(e.width!==_.width||e.height!==_.height||((D=e.pixelRatio)==null?void 0:D[0])!==((I=_.pixelRatio)==null?void 0:I[0])||((C=e.pixelRatio)==null?void 0:C[1])!==((w=_.pixelRatio)==null?void 0:w[1]))&&this.resetInitSegment()}else c=this.generateIS(t,e,i,n);const O=this.isVideoContiguous;let x=-1,W;if(L&&(x=qn(e.samples),!O&&this.config.forceKeyFrameOnDiscontinuity))if(g=!0,x>0){S.warn(`[mp4-remuxer]: Dropped ${x} out of ${A} video samples due to a missing keyframe`);const _=this.getVideoStartPts(e.samples);e.samples=e.samples.slice(x),e.dropped+=x,p+=(e.samples[0].pts-_)/e.inputTimeScale,W=p}else x===-1&&(S.warn(`[mp4-remuxer]: No keyframe found out of ${A} video samples`),g=!1);if(this.ISGenerated){if(R&&L){const _=this.getVideoStartPts(e.samples),H=(lt(t.samples[0].pts,_)-_)/e.inputTimeScale;m+=Math.max(0,H),p+=Math.max(0,-H)}if(R){if(t.samplerate||(S.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),c=this.generateIS(t,e,i,n)),d=this.remuxAudio(t,m,this.isAudioContiguous,n,T||L||l===j.AUDIO?p:void 0),L){const _=d?d.endPTS-d.startPTS:0;e.inputTimeScale||(S.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),c=this.generateIS(t,e,i,n)),h=this.remuxVideo(e,p,O,_)}}else L&&(h=this.remuxVideo(e,p,O,0));h&&(h.firstKeyFrame=x,h.independent=x!==-1,h.firstKeyFramePTS=W)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(r.samples.length&&(f=rs(r,i,this._initPTS,this._initDTS)),s.samples.length&&(u=ss(s,i,this._initPTS))),{audio:d,video:h,initSegment:c,independent:g,text:u,id3:f}}generateIS(t,e,r,s){const i=t.samples,n=e.samples,o=this.typeSupported,l={},h=this._initPTS;let d=!h||s,c="audio/mp4",u,f,g;if(d&&(u=f=1/0),t.config&&i.length){switch(t.timescale=t.samplerate,t.segmentCodec){case"mp3":o.mpeg?(c="audio/mpeg",t.codec=""):o.mp3&&(t.codec="mp3");break;case"ac3":t.codec="ac-3";break}l.audio={id:"audio",container:c,codec:t.codec,initSegment:t.segmentCodec==="mp3"&&o.mpeg?new Uint8Array(0):E.initSegment([t]),metadata:{channelCount:t.channelCount}},d&&(g=t.inputTimeScale,!h||g!==h.timescale?u=f=i[0].pts-Math.round(g*r):d=!1)}if(e.sps&&e.pps&&n.length){if(e.timescale=e.inputTimeScale,l.video={id:"main",container:"video/mp4",codec:e.codec,initSegment:E.initSegment([e]),metadata:{width:e.width,height:e.height}},d)if(g=e.inputTimeScale,!h||g!==h.timescale){const m=this.getVideoStartPts(n),p=Math.round(g*r);f=Math.min(f,lt(n[0].dts,m)-p),u=Math.min(u,m-p)}else d=!1;this.videoTrackConfig={width:e.width,height:e.height,pixelRatio:e.pixelRatio}}if(Object.keys(l).length)return this.ISGenerated=!0,d?(this._initPTS={baseTime:u,timescale:g},this._initDTS={baseTime:f,timescale:g}):u=g=void 0,{tracks:l,initPTS:u,timescale:g}}remuxVideo(t,e,r,s){const i=t.inputTimeScale,n=t.samples,o=[],l=n.length,h=this._initPTS;let d=this.nextAvcDts,c=8,u=this.videoSampleDuration,f,g,m=Number.POSITIVE_INFINITY,p=Number.NEGATIVE_INFINITY,y=!1;if(!r||d===null){const k=e*i,F=n[0].pts-lt(n[0].dts,n[0].pts);It&&d!==null&&Math.abs(k-F-d)<15e3?r=!0:d=k-F}const T=h.baseTime*i/h.timescale;for(let k=0;k<l;k++){const F=n[k];F.pts=lt(F.pts-T,d),F.dts=lt(F.dts-T,d),F.dts<n[k>0?k-1:k].dts&&(y=!0)}y&&n.sort(function(k,F){const q=k.dts-F.dts,U=k.pts-F.pts;return q||U}),f=n[0].dts,g=n[n.length-1].dts;const A=g-f,R=A?Math.round(A/(l-1)):u||t.inputTimeScale/30;if(r){const k=f-d,F=k>R,q=k<-1;if((F||q)&&(F?S.warn(`AVC: ${Ct(k,!0)} ms (${k}dts) hole between fragments detected at ${e.toFixed(3)}`):S.warn(`AVC: ${Ct(-k,!0)} ms (${k}dts) overlapping between fragments detected at ${e.toFixed(3)}`),!q||d>=n[0].pts||It)){f=d;const U=n[0].pts-k;if(F)n[0].dts=f,n[0].pts=U;else for(let K=0;K<n.length&&!(n[K].dts>U);K++)n[K].dts-=k,n[K].pts-=k;S.log(`Video: Initial PTS/DTS adjusted: ${Ct(U,!0)}/${Ct(f,!0)}, delta: ${Ct(k,!0)} ms`)}}f=Math.max(0,f);let L=0,D=0,I=f;for(let k=0;k<l;k++){const F=n[k],q=F.units,U=q.length;let K=0;for(let J=0;J<U;J++)K+=q[J].data.length;D+=K,L+=U,F.length=K,F.dts<I?(F.dts=I,I+=R/4|0||1):I=F.dts,m=Math.min(F.pts,m),p=Math.max(F.pts,p)}g=n[l-1].dts;const C=D+4*L+8;let w;try{w=new Uint8Array(C)}catch(k){this.observer.emit(v.ERROR,v.ERROR,{type:G.MUX_ERROR,details:b.REMUX_ALLOC_ERROR,fatal:!1,error:k,bytes:C,reason:`fail allocating video mdat ${C}`});return}const O=new DataView(w.buffer);O.setUint32(0,C),w.set(E.types.mdat,4);let x=!1,W=Number.POSITIVE_INFINITY,_=Number.POSITIVE_INFINITY,H=Number.NEGATIVE_INFINITY,N=Number.NEGATIVE_INFINITY;for(let k=0;k<l;k++){const F=n[k],q=F.units;let U=0;for(let rt=0,nt=q.length;rt<nt;rt++){const ct=q[rt],xt=ct.data,te=ct.data.byteLength;O.setUint32(c,te),c+=4,w.set(xt,c),c+=te,U+=4+te}let K;if(k<l-1)u=n[k+1].dts-F.dts,K=n[k+1].pts-F.pts;else{const rt=this.config,nt=k>0?F.dts-n[k-1].dts:R;if(K=k>0?F.pts-n[k-1].pts:R,rt.stretchShortVideoTrack&&this.nextAudioPts!==null){const ct=Math.floor(rt.maxBufferHole*i),xt=(s?m+s*i:this.nextAudioPts)-F.pts;xt>ct?(u=xt-nt,u<0?u=nt:x=!0,S.log(`[mp4-remuxer]: It is approximately ${xt/90} ms to the next segment; using duration ${u/90} ms for the last video frame.`)):u=nt}else u=nt}const J=Math.round(F.pts-F.dts);W=Math.min(W,u),H=Math.max(H,u),_=Math.min(_,K),N=Math.max(N,K),o.push(new mr(F.key,u,U,J))}if(o.length){if(It){if(It<70){const k=o[0].flags;k.dependsOn=2,k.isNonSync=0}}else if(ue&&N-_<H-W&&R/H<.025&&o[0].cts===0){S.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let k=f;for(let F=0,q=o.length;F<q;F++){const U=k+o[F].duration,K=k+o[F].cts;if(F<q-1){const J=U+o[F+1].cts;o[F].duration=J-K}else o[F].duration=F?o[F-1].duration:R;o[F].cts=0,k=U}}}u=x||!u?R:u,this.nextAvcDts=d=g+u,this.videoSampleDuration=u,this.isVideoContiguous=!0;const V={data1:E.moof(t.sequenceNumber++,f,it({},t,{samples:o})),data2:w,startPTS:m/i,endPTS:(p+u)/i,startDTS:f/i,endDTS:d/i,type:"video",hasAudio:!1,hasVideo:!0,nb:o.length,dropped:t.dropped};return t.samples=[],t.dropped=0,V}getSamplesPerFrame(t){switch(t.segmentCodec){case"mp3":return Yn;case"ac3":return jn;default:return gr}}remuxAudio(t,e,r,s,i){const n=t.inputTimeScale,o=t.samplerate?t.samplerate:n,l=n/o,h=this.getSamplesPerFrame(t),d=h*l,c=this._initPTS,u=t.segmentCodec==="mp3"&&this.typeSupported.mpeg,f=[],g=i!==void 0;let m=t.samples,p=u?0:8,y=this.nextAudioPts||-1;const T=e*n,A=c.baseTime*n/c.timescale;if(this.isAudioContiguous=r=r||m.length&&y>0&&(s&&Math.abs(T-y)<9e3||Math.abs(lt(m[0].pts-A,T)-y)<20*d),m.forEach(function(N){N.pts=lt(N.pts-A,T)}),!r||y<0){if(m=m.filter(N=>N.pts>=0),!m.length)return;i===0?y=0:s&&!g?y=Math.max(0,T):y=m[0].pts}if(t.segmentCodec==="aac"){const N=this.config.maxAudioFramesDrift;for(let V=0,k=y;V<m.length;V++){const F=m[V],q=F.pts,U=q-k,K=Math.abs(1e3*U/n);if(U<=-N*d&&g)V===0&&(S.warn(`Audio frame @ ${(q/n).toFixed(3)}s overlaps nextAudioPts by ${Math.round(1e3*U/n)} ms.`),this.nextAudioPts=y=k=q);else if(U>=N*d&&K<Wn&&g){let J=Math.round(U/d);k=q-J*d,k<0&&(J--,k+=d),V===0&&(this.nextAudioPts=y=k),S.warn(`[mp4-remuxer]: Injecting ${J} audio frame @ ${(k/n).toFixed(3)}s due to ${Math.round(1e3*U/n)} ms gap.`);for(let rt=0;rt<J;rt++){const nt=Math.max(k,0);let ct=fr.getSilentFrame(t.manifestCodec||t.codec,t.channelCount);ct||(S.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),ct=F.unit.subarray()),m.splice(V,0,{unit:ct,pts:nt}),k+=d,V++}}F.pts=k,k+=d}}let R=null,L=null,D,I=0,C=m.length;for(;C--;)I+=m[C].unit.byteLength;for(let N=0,V=m.length;N<V;N++){const k=m[N],F=k.unit;let q=k.pts;if(L!==null){const K=f[N-1];K.duration=Math.round((q-L)/l)}else if(r&&t.segmentCodec==="aac"&&(q=y),R=q,I>0){I+=p;try{D=new Uint8Array(I)}catch(K){this.observer.emit(v.ERROR,v.ERROR,{type:G.MUX_ERROR,details:b.REMUX_ALLOC_ERROR,fatal:!1,error:K,bytes:I,reason:`fail allocating audio mdat ${I}`});return}u||(new DataView(D.buffer).setUint32(0,I),D.set(E.types.mdat,4))}else return;D.set(F,p);const U=F.byteLength;p+=U,f.push(new mr(!0,h,U,0)),L=q}const w=f.length;if(!w)return;const O=f[f.length-1];this.nextAudioPts=y=L+l*O.duration;const x=u?new Uint8Array(0):E.moof(t.sequenceNumber++,R/l,it({},t,{samples:f}));t.samples=[];const W=R/n,_=y/n,H={data1:x,data2:D,startPTS:W,endPTS:_,startDTS:W,endDTS:_,type:"audio",hasAudio:!0,hasVideo:!1,nb:w};return this.isAudioContiguous=!0,H}remuxEmptyAudio(t,e,r,s){const i=t.inputTimeScale,n=t.samplerate?t.samplerate:i,o=i/n,l=this.nextAudioPts,h=this._initDTS,d=h.baseTime*9e4/h.timescale,c=(l!==null?l:s.startDTS*i)+d,u=s.endDTS*i+d,f=o*gr,g=Math.ceil((u-c)/f),m=fr.getSilentFrame(t.manifestCodec||t.codec,t.channelCount);if(S.warn("[mp4-remuxer]: remux empty Audio"),!m){S.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec");return}const p=[];for(let y=0;y<g;y++){const T=c+y*f;p.push({unit:m,pts:T,dts:T})}return t.samples=p,this.remuxAudio(t,e,r,!1)}}function lt(a,t){let e;if(t===null)return a;for(t<a?e=-8589934592:e=8589934592;Math.abs(a-t)>4294967296;)a+=e;return a}function qn(a){for(let t=0;t<a.length;t++)if(a[t].key)return t;return-1}function rs(a,t,e,r){const s=a.samples.length;if(!s)return;const i=a.inputTimeScale;for(let o=0;o<s;o++){const l=a.samples[o];l.pts=lt(l.pts-e.baseTime*i/e.timescale,t*i)/i,l.dts=lt(l.dts-r.baseTime*i/r.timescale,t*i)/i}const n=a.samples;return a.samples=[],{samples:n}}function ss(a,t,e){const r=a.samples.length;if(!r)return;const s=a.inputTimeScale;for(let n=0;n<r;n++){const o=a.samples[n];o.pts=lt(o.pts-e.baseTime*s/e.timescale,t*s)/s}a.samples.sort((n,o)=>n.pts-o.pts);const i=a.samples;return a.samples=[],{samples:i}}class mr{constructor(t,e,r,s){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=e,this.size=r,this.cts=s,this.flags={isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:t?2:1,isNonSync:t?0:1}}}class zn{constructor(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null}destroy(){}resetTimeStamp(t){this.initPTS=t,this.lastEndTime=null}resetNextTimestamp(){this.lastEndTime=null}resetInitSegment(t,e,r,s){this.audioCodec=e,this.videoCodec=r,this.generateInitSegment(_s(t,s)),this.emitInitSegment=!0}generateInitSegment(t){let{audioCodec:e,videoCodec:r}=this;if(!(t!=null&&t.byteLength)){this.initTracks=void 0,this.initData=void 0;return}const s=this.initData=xr(t);s.audio&&(e=pr(s.audio,z.AUDIO)),s.video&&(r=pr(s.video,z.VIDEO));const i={};s.audio&&s.video?i.audiovideo={container:"video/mp4",codec:e+","+r,initSegment:t,id:"main"}:s.audio?i.audio={container:"audio/mp4",codec:e,initSegment:t,id:"audio"}:s.video?i.video={container:"video/mp4",codec:r,initSegment:t,id:"main"}:S.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=i}remux(t,e,r,s,i,n){var o,l;let{initPTS:h,lastEndTime:d}=this;const c={audio:void 0,video:void 0,text:s,id3:r,initSegment:void 0};M(d)||(d=this.lastEndTime=i||0);const u=e.samples;if(!(u!=null&&u.length))return c;const f={initPTS:void 0,timescale:1};let g=this.initData;if((o=g)!=null&&o.length||(this.generateInitSegment(u),g=this.initData),!((l=g)!=null&&l.length))return S.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),c;this.emitInitSegment&&(f.tracks=this.initTracks,this.emitInitSegment=!1);const m=Ms(u,g),p=Os(g,u),y=p===null?i:p;(Xn(h,y,i,m)||f.timescale!==h.timescale&&n)&&(f.initPTS=y-i,h&&h.timescale===1&&S.warn(`Adjusting initPTS by ${f.initPTS-h.baseTime}`),this.initPTS=h={baseTime:f.initPTS,timescale:1});const T=t?y-h.baseTime/h.timescale:d,A=T+m;Bs(g,u,h.baseTime/h.timescale),m>0?this.lastEndTime=A:(S.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const R=!!g.audio,L=!!g.video;let D="";R&&(D+="audio"),L&&(D+="video");const I={data1:u,startPTS:T,startDTS:T,endPTS:A,endDTS:A,type:D,hasAudio:R,hasVideo:L,nb:1,dropped:0};return c.audio=I.type==="audio"?I:void 0,c.video=I.type!=="audio"?I:void 0,c.initSegment=f,c.id3=rs(r,i,h,h),s.samples.length&&(c.text=ss(s,i,h)),c}}function Xn(a,t,e,r){if(a===null)return!0;const s=Math.max(r,1),i=t-a.baseTime/a.timescale;return Math.abs(i-e)>s}function pr(a,t){const e=a==null?void 0:a.codec;if(e&&e.length>4)return e;if(t===z.AUDIO){if(e==="ec-3"||e==="ac-3"||e==="alac")return e;if(e==="fLaC"||e==="Opus")return Yt(e,!1);const r="mp4a.40.5";return S.info(`Parsed audio codec "${e}" or audio object type not handled. Using "${r}"`),r}return S.warn(`Unhandled video codec "${e}"`),e==="hvc1"||e==="hev1"?"hvc1.1.6.L120.90":e==="av01"?"av01.0.04M.08":"avc1.42e01e"}const ge=typeof self<"u"?self:void 0;let vt;try{vt=self.performance.now.bind(self.performance)}catch{S.debug("Unable to use Performance API on this environment"),vt=ge==null?void 0:ge.Date.now}const me=[{demux:On,remux:zn},{demux:Tt,remux:fe},{demux:_n,remux:fe},{demux:Hn,remux:fe}];class vr{constructor(t,e,r,s,i){this.async=!1,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=t,this.typeSupported=e,this.config=r,this.vendor=s,this.id=i}configure(t){this.transmuxConfig=t,this.decrypter&&this.decrypter.reset()}push(t,e,r,s){const i=r.transmuxing;i.executeStart=vt();let n=new Uint8Array(t);const{currentTransmuxState:o,transmuxConfig:l}=this;s&&(this.currentTransmuxState=s);const{contiguous:h,discontinuity:d,trackSwitch:c,accurateTimeOffset:u,timeOffset:f,initSegmentChange:g}=s||o,{audioCodec:m,videoCodec:p,defaultInitPts:y,duration:T,initSegmentData:A}=l,R=Qn(n,e);if(R&&R.method==="AES-128"){const C=this.getDecrypter();if(C.isSync()){let w=C.softwareDecrypt(n,R.key.buffer,R.iv.buffer);if(r.part>-1&&(w=C.flush()),!w)return i.executeEnd=vt(),pe(r);n=new Uint8Array(w)}else return this.decryptionPromise=C.webCryptoDecrypt(n,R.key.buffer,R.iv.buffer).then(w=>{const O=this.push(w,null,r);return this.decryptionPromise=null,O}),this.decryptionPromise}const L=this.needsProbing(d,c);if(L){const C=this.configureTransmuxer(n);if(C)return S.warn(`[transmuxer] ${C.message}`),this.observer.emit(v.ERROR,v.ERROR,{type:G.MEDIA_ERROR,details:b.FRAG_PARSING_ERROR,fatal:!1,error:C,reason:C.message}),i.executeEnd=vt(),pe(r)}(d||c||g||L)&&this.resetInitSegment(A,m,p,T,e),(d||g||L)&&this.resetInitialTimestamp(y),h||this.resetContiguity();const D=this.transmux(n,R,f,u,r),I=this.currentTransmuxState;return I.contiguous=!0,I.discontinuity=!1,I.trackSwitch=!1,i.executeEnd=vt(),D}flush(t){const e=t.transmuxing;e.executeStart=vt();const{decrypter:r,currentTransmuxState:s,decryptionPromise:i}=this;if(i)return i.then(()=>this.flush(t));const n=[],{timeOffset:o}=s;if(r){const c=r.flush();c&&n.push(this.push(c,null,t))}const{demuxer:l,remuxer:h}=this;if(!l||!h)return e.executeEnd=vt(),[pe(t)];const d=l.flush(o);return $t(d)?d.then(c=>(this.flushRemux(n,c,t),n)):(this.flushRemux(n,d,t),n)}flushRemux(t,e,r){const{audioTrack:s,videoTrack:i,id3Track:n,textTrack:o}=e,{accurateTimeOffset:l,timeOffset:h}=this.currentTransmuxState;S.log(`[transmuxer.ts]: Flushed fragment ${r.sn}${r.part>-1?" p: "+r.part:""} of level ${r.level}`);const d=this.remuxer.remux(s,i,n,o,h,l,!0,this.id);t.push({remuxResult:d,chunkMeta:r}),r.transmuxing.executeEnd=vt()}resetInitialTimestamp(t){const{demuxer:e,remuxer:r}=this;!e||!r||(e.resetTimeStamp(t),r.resetTimeStamp(t))}resetContiguity(){const{demuxer:t,remuxer:e}=this;!t||!e||(t.resetContiguity(),e.resetNextTimestamp())}resetInitSegment(t,e,r,s,i){const{demuxer:n,remuxer:o}=this;!n||!o||(n.resetInitSegment(t,e,r,s),o.resetInitSegment(t,e,r,i))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(t,e,r,s,i){let n;return e&&e.method==="SAMPLE-AES"?n=this.transmuxSampleAes(t,e,r,s,i):n=this.transmuxUnencrypted(t,r,s,i),n}transmuxUnencrypted(t,e,r,s){const{audioTrack:i,videoTrack:n,id3Track:o,textTrack:l}=this.demuxer.demux(t,e,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(i,n,o,l,e,r,!1,this.id),chunkMeta:s}}transmuxSampleAes(t,e,r,s,i){return this.demuxer.demuxSampleAes(t,e,r).then(n=>({remuxResult:this.remuxer.remux(n.audioTrack,n.videoTrack,n.id3Track,n.textTrack,r,s,!1,this.id),chunkMeta:i}))}configureTransmuxer(t){const{config:e,observer:r,typeSupported:s,vendor:i}=this;let n;for(let u=0,f=me.length;u<f;u++){var o;if((o=me[u].demux)!=null&&o.probe(t)){n=me[u];break}}if(!n)return new Error("Failed to find demuxer by probing fragment data");const l=this.demuxer,h=this.remuxer,d=n.remux,c=n.demux;(!h||!(h instanceof d))&&(this.remuxer=new d(r,e,s,i)),(!l||!(l instanceof c))&&(this.demuxer=new c(r,e,s),this.probe=c.probe)}needsProbing(t,e){return!this.demuxer||!this.remuxer||t||e}getDecrypter(){let t=this.decrypter;return t||(t=this.decrypter=new xe(this.config)),t}}function Qn(a,t){let e=null;return a.byteLength>0&&(t==null?void 0:t.key)!=null&&t.iv!==null&&t.method!=null&&(e=t),e}const pe=a=>({remuxResult:{},chunkMeta:a});function $t(a){return"then"in a&&a.then instanceof Function}class Jn{constructor(t,e,r,s,i){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=t,this.videoCodec=e,this.initSegmentData=r,this.duration=s,this.defaultInitPts=i||null}}class Zn{constructor(t,e,r,s,i,n){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=t,this.contiguous=e,this.accurateTimeOffset=r,this.trackSwitch=s,this.timeOffset=i,this.initSegmentChange=n}}var is={exports:{}};(function(a){var t=Object.prototype.hasOwnProperty,e="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(e=!1));function s(l,h,d){this.fn=l,this.context=h,this.once=d||!1}function i(l,h,d,c,u){if(typeof d!="function")throw new TypeError("The listener must be a function");var f=new s(d,c||l,u),g=e?e+h:h;return l._events[g]?l._events[g].fn?l._events[g]=[l._events[g],f]:l._events[g].push(f):(l._events[g]=f,l._eventsCount++),l}function n(l,h){--l._eventsCount===0?l._events=new r:delete l._events[h]}function o(){this._events=new r,this._eventsCount=0}o.prototype.eventNames=function(){var l=[],h,d;if(this._eventsCount===0)return l;for(d in h=this._events)t.call(h,d)&&l.push(e?d.slice(1):d);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(h)):l},o.prototype.listeners=function(l){var h=e?e+l:l,d=this._events[h];if(!d)return[];if(d.fn)return[d.fn];for(var c=0,u=d.length,f=new Array(u);c<u;c++)f[c]=d[c].fn;return f},o.prototype.listenerCount=function(l){var h=e?e+l:l,d=this._events[h];return d?d.fn?1:d.length:0},o.prototype.emit=function(l,h,d,c,u,f){var g=e?e+l:l;if(!this._events[g])return!1;var m=this._events[g],p=arguments.length,y,T;if(m.fn){switch(m.once&&this.removeListener(l,m.fn,void 0,!0),p){case 1:return m.fn.call(m.context),!0;case 2:return m.fn.call(m.context,h),!0;case 3:return m.fn.call(m.context,h,d),!0;case 4:return m.fn.call(m.context,h,d,c),!0;case 5:return m.fn.call(m.context,h,d,c,u),!0;case 6:return m.fn.call(m.context,h,d,c,u,f),!0}for(T=1,y=new Array(p-1);T<p;T++)y[T-1]=arguments[T];m.fn.apply(m.context,y)}else{var A=m.length,R;for(T=0;T<A;T++)switch(m[T].once&&this.removeListener(l,m[T].fn,void 0,!0),p){case 1:m[T].fn.call(m[T].context);break;case 2:m[T].fn.call(m[T].context,h);break;case 3:m[T].fn.call(m[T].context,h,d);break;case 4:m[T].fn.call(m[T].context,h,d,c);break;default:if(!y)for(R=1,y=new Array(p-1);R<p;R++)y[R-1]=arguments[R];m[T].fn.apply(m[T].context,y)}}return!0},o.prototype.on=function(l,h,d){return i(this,l,h,d,!1)},o.prototype.once=function(l,h,d){return i(this,l,h,d,!0)},o.prototype.removeListener=function(l,h,d,c){var u=e?e+l:l;if(!this._events[u])return this;if(!h)return n(this,u),this;var f=this._events[u];if(f.fn)f.fn===h&&(!c||f.once)&&(!d||f.context===d)&&n(this,u);else{for(var g=0,m=[],p=f.length;g<p;g++)(f[g].fn!==h||c&&!f[g].once||d&&f[g].context!==d)&&m.push(f[g]);m.length?this._events[u]=m.length===1?m[0]:m:n(this,u)}return this},o.prototype.removeAllListeners=function(l){var h;return l?(h=e?e+l:l,this._events[h]&&n(this,h)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=e,o.EventEmitter=o,a.exports=o})(is);var ta=is.exports,ns=yr(ta);class ea{constructor(t,e,r,s){this.error=null,this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0;const i=t.config;this.hls=t,this.id=e,this.useWorker=!!i.enableWorker,this.onTransmuxComplete=r,this.onFlush=s;const n=(h,d)=>{d=d||{},d.frag=this.frag,d.id=this.id,h===v.ERROR&&(this.error=d.error),this.hls.trigger(h,d)};this.observer=new ns,this.observer.on(v.FRAG_DECRYPTED,n),this.observer.on(v.ERROR,n);const o=At(i.preferManagedMediaSource)||{isTypeSupported:()=>!1},l={mpeg:o.isTypeSupported("audio/mpeg"),mp3:o.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:!1};if(this.useWorker&&typeof Worker<"u"&&(i.workerPath||Tn())){try{i.workerPath?(S.log(`loading Web Worker ${i.workerPath} for "${e}"`),this.workerContext=Ln(i.workerPath)):(S.log(`injecting Web Worker for "${e}"`),this.workerContext=En()),this.onwmsg=d=>this.onWorkerMessage(d);const{worker:h}=this.workerContext;h.addEventListener("message",this.onwmsg),h.onerror=d=>{const c=new Error(`${d.message}  (${d.filename}:${d.lineno})`);i.enableWorker=!1,S.warn(`Error in "${e}" Web Worker, fallback to inline`),this.hls.trigger(v.ERROR,{type:G.OTHER_ERROR,details:b.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:c})},h.postMessage({cmd:"init",typeSupported:l,vendor:"",id:e,config:JSON.stringify(i)})}catch(h){S.warn(`Error setting up "${e}" Web Worker, fallback to inline`,h),this.resetWorker(),this.error=null,this.transmuxer=new vr(this.observer,l,i,"",e)}return}this.transmuxer=new vr(this.observer,l,i,"",e)}resetWorker(){if(this.workerContext){const{worker:t,objectURL:e}=this.workerContext;e&&self.URL.revokeObjectURL(e),t.removeEventListener("message",this.onwmsg),t.onerror=null,t.terminate(),this.workerContext=null}}destroy(){if(this.workerContext)this.resetWorker(),this.onwmsg=void 0;else{const e=this.transmuxer;e&&(e.destroy(),this.transmuxer=null)}const t=this.observer;t&&t.removeAllListeners(),this.frag=null,this.observer=null,this.hls=null}push(t,e,r,s,i,n,o,l,h,d){var c,u;h.transmuxing.start=self.performance.now();const{transmuxer:f}=this,g=n?n.start:i.start,m=i.decryptdata,p=this.frag,y=!(p&&i.cc===p.cc),T=!(p&&h.level===p.level),A=p?h.sn-p.sn:-1,R=this.part?h.part-this.part.index:-1,L=A===0&&h.id>1&&h.id===(p==null?void 0:p.stats.chunkCount),D=!T&&(A===1||A===0&&(R===1||L&&R<=0)),I=self.performance.now();(T||A||i.stats.parsing.start===0)&&(i.stats.parsing.start=I),n&&(R||!D)&&(n.stats.parsing.start=I);const C=!(p&&((c=i.initSegment)==null?void 0:c.url)===((u=p.initSegment)==null?void 0:u.url)),w=new Zn(y,D,l,T,g,C);if(!D||y||C){S.log(`[transmuxer-interface, ${i.type}]: Starting new transmux session for sn: ${h.sn} p: ${h.part} level: ${h.level} id: ${h.id}
        discontinuity: ${y}
        trackSwitch: ${T}
        contiguous: ${D}
        accurateTimeOffset: ${l}
        timeOffset: ${g}
        initSegmentChange: ${C}`);const O=new Jn(r,s,e,o,d);this.configureTransmuxer(O)}if(this.frag=i,this.part=n,this.workerContext)this.workerContext.worker.postMessage({cmd:"demux",data:t,decryptdata:m,chunkMeta:h,state:w},t instanceof ArrayBuffer?[t]:[]);else if(f){const O=f.push(t,m,h,w);$t(O)?(f.async=!0,O.then(x=>{this.handleTransmuxComplete(x)}).catch(x=>{this.transmuxerError(x,h,"transmuxer-interface push error")})):(f.async=!1,this.handleTransmuxComplete(O))}}flush(t){t.transmuxing.start=self.performance.now();const{transmuxer:e}=this;if(this.workerContext)this.workerContext.worker.postMessage({cmd:"flush",chunkMeta:t});else if(e){let r=e.flush(t);$t(r)||e.async?($t(r)||(r=Promise.resolve(r)),r.then(s=>{this.handleFlushResult(s,t)}).catch(s=>{this.transmuxerError(s,t,"transmuxer-interface flush error")})):this.handleFlushResult(r,t)}}transmuxerError(t,e,r){this.hls&&(this.error=t,this.hls.trigger(v.ERROR,{type:G.MEDIA_ERROR,details:b.FRAG_PARSING_ERROR,chunkMeta:e,frag:this.frag||void 0,fatal:!1,error:t,err:t,reason:r}))}handleFlushResult(t,e){t.forEach(r=>{this.handleTransmuxComplete(r)}),this.onFlush(e)}onWorkerMessage(t){const e=t.data;if(!(e!=null&&e.event)){S.warn(`worker message received with no ${e?"event name":"data"}`);return}const r=this.hls;if(this.hls)switch(e.event){case"init":{var s;const i=(s=this.workerContext)==null?void 0:s.objectURL;i&&self.URL.revokeObjectURL(i);break}case"transmuxComplete":{this.handleTransmuxComplete(e.data);break}case"flush":{this.onFlush(e.data);break}case"workerLog":S[e.data.logType]&&S[e.data.logType](e.data.message);break;default:{e.data=e.data||{},e.data.frag=this.frag,e.data.id=this.id,r.trigger(e.event,e.data);break}}}configureTransmuxer(t){const{transmuxer:e}=this;this.workerContext?this.workerContext.worker.postMessage({cmd:"configure",config:t}):e&&e.configure(t)}handleTransmuxComplete(t){t.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(t)}}const ra=250,Gt=2,sa=.1,ia=.05;class na{constructor(t,e,r,s){this.config=void 0,this.media=null,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=t,this.media=e,this.fragmentTracker=r,this.hls=s}destroy(){this.media=null,this.hls=this.fragmentTracker=null}poll(t,e){const{config:r,media:s,stalled:i}=this;if(s===null)return;const{currentTime:n,seeking:o}=s,l=this.seeking&&!o,h=!this.seeking&&o;if(this.seeking=o,n!==t){if(this.moved=!0,o||(this.nudgeRetry=0),i!==null){if(this.stallReported){const p=self.performance.now()-i;S.warn(`playback not stuck anymore @${n}, after ${Math.round(p)}ms`),this.stallReported=!1}this.stalled=null}return}if(h||l){this.stalled=null;return}if(s.paused&&!o||s.ended||s.playbackRate===0||!X.getBuffered(s).length){this.nudgeRetry=0;return}const d=X.bufferInfo(s,n,0),c=d.nextStart||0;if(o){const p=d.len>Gt,y=!c||e&&e.start<=n||c-n>Gt&&!this.fragmentTracker.getPartialFragment(n);if(p||y)return;this.moved=!1}if(!this.moved&&this.stalled!==null){var u;if(!(d.len>0)&&!c)return;const p=Math.max(c,d.start||0)-n,y=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,T=!(y==null||(u=y.details)==null)&&u.live?y.details.targetduration*2:Gt,A=this.fragmentTracker.getPartialFragment(n);if(p>0&&(p<=T||A)){s.paused||this._trySkipBufferHole(A);return}}const f=self.performance.now();if(i===null){this.stalled=f;return}const g=f-i;if(!o&&g>=ra&&(this._reportStall(d),!this.media))return;const m=X.bufferInfo(s,n,r.maxBufferHole);this._tryFixBufferStall(m,g)}_tryFixBufferStall(t,e){const{config:r,fragmentTracker:s,media:i}=this;if(i===null)return;const n=i.currentTime,o=s.getPartialFragment(n);o&&(this._trySkipBufferHole(o)||!this.media)||(t.len>r.maxBufferHole||t.nextStart&&t.nextStart-n<r.maxBufferHole)&&e>r.highBufferWatchdogPeriod*1e3&&(S.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}_reportStall(t){const{hls:e,media:r,stallReported:s}=this;if(!s&&r){this.stallReported=!0;const i=new Error(`Playback stalling at @${r.currentTime} due to low buffer (${JSON.stringify(t)})`);S.warn(i.message),e.trigger(v.ERROR,{type:G.MEDIA_ERROR,details:b.BUFFER_STALLED_ERROR,fatal:!1,error:i,buffer:t.len})}}_trySkipBufferHole(t){const{config:e,hls:r,media:s}=this;if(s===null)return 0;const i=s.currentTime,n=X.bufferInfo(s,i,0),o=i<n.start?n.start:n.nextStart;if(o){const l=n.len<=e.maxBufferHole,h=n.len>0&&n.len<1&&s.readyState<3,d=o-i;if(d>0&&(l||h)){if(d>e.maxBufferHole){const{fragmentTracker:u}=this;let f=!1;if(i===0){const g=u.getAppendedFrag(0,j.MAIN);g&&o<g.end&&(f=!0)}if(!f){const g=t||u.getAppendedFrag(i,j.MAIN);if(g){let m=!1,p=g.end;for(;p<o;){const y=u.getPartialFragment(p);if(y)p+=y.duration;else{m=!0;break}}if(m)return 0}}}const c=Math.max(o+ia,i+sa);if(S.warn(`skipping hole, adjusting currentTime from ${i} to ${c}`),this.moved=!0,this.stalled=null,s.currentTime=c,t&&!t.gap){const u=new Error(`fragment loaded with buffer holes, seeking from ${i} to ${c}`);r.trigger(v.ERROR,{type:G.MEDIA_ERROR,details:b.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:u,reason:u.message,frag:t})}return c}}return 0}_tryNudgeBuffer(){const{config:t,hls:e,media:r,nudgeRetry:s}=this;if(r===null)return;const i=r.currentTime;if(this.nudgeRetry++,s<t.nudgeMaxRetry){const n=i+(s+1)*t.nudgeOffset,o=new Error(`Nudging 'currentTime' from ${i} to ${n}`);S.warn(o.message),r.currentTime=n,e.trigger(v.ERROR,{type:G.MEDIA_ERROR,details:b.BUFFER_NUDGE_ON_STALL,error:o,fatal:!1})}else{const n=new Error(`Playhead still not moving while enough data buffered @${i} after ${t.nudgeMaxRetry} nudges`);S.error(n.message),e.trigger(v.ERROR,{type:G.MEDIA_ERROR,details:b.BUFFER_STALLED_ERROR,error:n,fatal:!0})}}}const aa=100;class oa extends pn{constructor(t,e,r){super(t,e,r,"[stream-controller]",j.MAIN),this.audioCodecSwap=!1,this.gapController=null,this.level=-1,this._forceStartLoad=!1,this.altAudio=!1,this.audioOnly=!1,this.fragPlaying=null,this.onvplaying=null,this.onvseeked=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this._registerListeners()}_registerListeners(){const{hls:t}=this;t.on(v.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(v.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(v.MANIFEST_LOADING,this.onManifestLoading,this),t.on(v.MANIFEST_PARSED,this.onManifestParsed,this),t.on(v.LEVEL_LOADING,this.onLevelLoading,this),t.on(v.LEVEL_LOADED,this.onLevelLoaded,this),t.on(v.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),t.on(v.ERROR,this.onError,this),t.on(v.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.on(v.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),t.on(v.BUFFER_CREATED,this.onBufferCreated,this),t.on(v.BUFFER_FLUSHED,this.onBufferFlushed,this),t.on(v.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(v.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:t}=this;t.off(v.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(v.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(v.MANIFEST_LOADING,this.onManifestLoading,this),t.off(v.MANIFEST_PARSED,this.onManifestParsed,this),t.off(v.LEVEL_LOADED,this.onLevelLoaded,this),t.off(v.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),t.off(v.ERROR,this.onError,this),t.off(v.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.off(v.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),t.off(v.BUFFER_CREATED,this.onBufferCreated,this),t.off(v.BUFFER_FLUSHED,this.onBufferFlushed,this),t.off(v.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(v.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying()}startLoad(t){if(this.levels){const{lastCurrentTime:e,hls:r}=this;if(this.stopLoad(),this.setInterval(aa),this.level=-1,!this.startFragRequested){let s=r.startLevel;s===-1&&(r.config.testBandwidth&&this.levels.length>1?(s=0,this.bitrateTest=!0):s=r.firstAutoLevel),r.nextLoadLevel=s,this.level=r.loadLevel,this.loadedmetadata=!1}e>0&&t===-1&&(this.log(`Override startPosition with lastCurrentTime @${e.toFixed(3)}`),t=e),this.state=P.IDLE,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=t,this.tick()}else this._forceStartLoad=!0,this.state=P.STOPPED}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case P.WAITING_LEVEL:{const{levels:e,level:r}=this,s=e==null?void 0:e[r],i=s==null?void 0:s.details;if(i&&(!i.live||this.levelLastLoaded===s)){if(this.waitForCdnTuneIn(i))break;this.state=P.IDLE;break}else if(this.hls.nextLoadLevel!==this.level){this.state=P.IDLE;break}break}case P.FRAG_LOADING_WAITING_RETRY:{var t;const e=self.performance.now(),r=this.retryDate;if(!r||e>=r||(t=this.media)!=null&&t.seeking){const{levels:s,level:i}=this,n=s==null?void 0:s[i];this.resetStartWhenNotLoaded(n||null),this.state=P.IDLE}}break}this.state===P.IDLE&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){super.onTickEnd(),this.checkBuffer(),this.checkFragmentChanged()}doTickIdle(){const{hls:t,levelLastLoaded:e,levels:r,media:s}=this;if(e===null||!s&&(this.startFragRequested||!t.config.startFragPrefetch)||this.altAudio&&this.audioOnly)return;const i=t.nextLoadLevel;if(!(r!=null&&r[i]))return;const n=r[i],o=this.getMainFwdBufferInfo();if(o===null)return;const l=this.getLevelDetails();if(l&&this._streamEnded(o,l)){const m={};this.altAudio&&(m.type="video"),this.hls.trigger(v.BUFFER_EOS,m),this.state=P.ENDED;return}t.loadLevel!==i&&t.manualLevel===-1&&this.log(`Adapting to level ${i} from level ${this.level}`),this.level=t.nextLoadLevel=i;const h=n.details;if(!h||this.state===P.WAITING_LEVEL||h.live&&this.levelLastLoaded!==n){this.level=i,this.state=P.WAITING_LEVEL;return}const d=o.len,c=this.getMaxBufferLength(n.maxBitrate);if(d>=c)return;this.backtrackFragment&&this.backtrackFragment.start>o.end&&(this.backtrackFragment=null);const u=this.backtrackFragment?this.backtrackFragment.start:o.end;let f=this.getNextFragment(u,h);if(this.couldBacktrack&&!this.fragPrevious&&f&&f.sn!=="initSegment"&&this.fragmentTracker.getState(f)!==st.OK){var g;const m=((g=this.backtrackFragment)!=null?g:f).sn-h.startSN,p=h.fragments[m-1];p&&f.cc===p.cc&&(f=p,this.fragmentTracker.removeFragment(p))}else this.backtrackFragment&&o.len&&(this.backtrackFragment=null);if(f&&this.isLoopLoading(f,u)){if(!f.gap){const m=this.audioOnly&&!this.altAudio?z.AUDIO:z.VIDEO,p=(m===z.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;p&&this.afterBufferFlushed(p,m,j.MAIN)}f=this.getNextFragmentLoopLoading(f,h,o,j.MAIN,c)}f&&(f.initSegment&&!f.initSegment.data&&!this.bitrateTest&&(f=f.initSegment),this.loadFragment(f,n,u))}loadFragment(t,e,r){const s=this.fragmentTracker.getState(t);this.fragCurrent=t,s===st.NOT_LOADED||s===st.PARTIAL?t.sn==="initSegment"?this._loadInitSegment(t,e):this.bitrateTest?(this.log(`Fragment ${t.sn} of level ${t.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(t,e)):(this.startFragRequested=!0,super.loadFragment(t,e,r)):this.clearTrackerIfNeeded(t)}getBufferedFrag(t){return this.fragmentTracker.getBufferedFrag(t,j.MAIN)}followingBufferedFrag(t){return t?this.getBufferedFrag(t.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels:t,media:e}=this;if(e!=null&&e.readyState){let r;const s=this.getAppendedFrag(e.currentTime);s&&s.start>1&&this.flushMainBuffer(0,s.start-1);const i=this.getLevelDetails();if(i!=null&&i.live){const o=this.getMainFwdBufferInfo();if(!o||o.len<i.targetduration*2)return}if(!e.paused&&t){const o=this.hls.nextLoadLevel,l=t[o],h=this.fragLastKbps;h&&this.fragCurrent?r=this.fragCurrent.duration*l.maxBitrate/(1e3*h)+1:r=0}else r=0;const n=this.getBufferedFrag(e.currentTime+r);if(n){const o=this.followingBufferedFrag(n);if(o){this.abortCurrentFrag();const l=o.maxStartPTS?o.maxStartPTS:o.start,h=o.duration,d=Math.max(n.end,l+Math.min(Math.max(h-this.config.maxFragLookUpTolerance,h*(this.couldBacktrack?.5:.125)),h*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(d,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const t=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,t&&(t.abortRequests(),this.fragmentTracker.removeFragment(t)),this.state){case P.KEY_LOADING:case P.FRAG_LOADING:case P.FRAG_LOADING_WAITING_RETRY:case P.PARSING:case P.PARSED:this.state=P.IDLE;break}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(t,e){super.flushMainBuffer(t,e,this.altAudio?"video":null)}onMediaAttached(t,e){super.onMediaAttached(t,e);const r=e.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),r.addEventListener("playing",this.onvplaying),r.addEventListener("seeked",this.onvseeked),this.gapController=new na(this.config,r,this.fragmentTracker,this.hls)}onMediaDetaching(){const{media:t}=this;t&&this.onvplaying&&this.onvseeked&&(t.removeEventListener("playing",this.onvplaying),t.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),super.onMediaDetaching()}onMediaPlaying(){this.tick()}onMediaSeeked(){const t=this.media,e=t?t.currentTime:null;M(e)&&this.log(`Media seeked to ${e.toFixed(3)}`);const r=this.getMainFwdBufferInfo();if(r===null||r.len===0){this.warn(`Main forward buffer length on "seeked" event ${r?r.len:"empty"})`);return}this.tick()}onManifestLoading(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(v.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=!1,this.startPosition=this.lastCurrentTime=this.fragLastKbps=0,this.levels=this.fragPlaying=this.backtrackFragment=this.levelLastLoaded=null,this.altAudio=this.audioOnly=this.startFragRequested=!1}onManifestParsed(t,e){let r=!1,s=!1;e.levels.forEach(i=>{const n=i.audioCodec;n&&(r=r||n.indexOf("mp4a.40.2")!==-1,s=s||n.indexOf("mp4a.40.5")!==-1)}),this.audioCodecSwitch=r&&s&&!yn(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=e.levels,this.startFragRequested=!1}onLevelLoading(t,e){const{levels:r}=this;if(!r||this.state!==P.IDLE)return;const s=r[e.level];(!s.details||s.details.live&&this.levelLastLoaded!==s||this.waitForCdnTuneIn(s.details))&&(this.state=P.WAITING_LEVEL)}onLevelLoaded(t,e){var r;const{levels:s}=this,i=e.level,n=e.details,o=n.totalduration;if(!s){this.warn(`Levels were reset while loading level ${i}`);return}this.log(`Level ${i} loaded [${n.startSN},${n.endSN}]${n.lastPartSn?`[part-${n.lastPartSn}-${n.lastPartIndex}]`:""}, cc [${n.startCC}, ${n.endCC}] duration:${o}`);const l=s[i],h=this.fragCurrent;h&&(this.state===P.FRAG_LOADING||this.state===P.FRAG_LOADING_WAITING_RETRY)&&h.level!==e.level&&h.loader&&this.abortCurrentFrag();let d=0;if(n.live||(r=l.details)!=null&&r.live){var c;if(this.checkLiveUpdate(n),n.deltaUpdateFailed)return;d=this.alignPlaylists(n,l.details,(c=this.levelLastLoaded)==null?void 0:c.details)}if(l.details=n,this.levelLastLoaded=l,this.hls.trigger(v.LEVEL_UPDATED,{details:n,level:i}),this.state===P.WAITING_LEVEL){if(this.waitForCdnTuneIn(n))return;this.state=P.IDLE}this.startFragRequested?n.live&&this.synchronizeToLiveEdge(n):this.setStartPosition(n,d),this.tick()}_handleFragmentLoadProgress(t){var e;const{frag:r,part:s,payload:i}=t,{levels:n}=this;if(!n){this.warn(`Levels were reset while fragment load was in progress. Fragment ${r.sn} of level ${r.level} will not be buffered`);return}const o=n[r.level],l=o.details;if(!l){this.warn(`Dropping fragment ${r.sn} of level ${r.level} after level details were reset`),this.fragmentTracker.removeFragment(r);return}const h=o.videoCodec,d=l.PTSKnown||!l.live,c=(e=r.initSegment)==null?void 0:e.data,u=this._getAudioCodec(o),f=this.transmuxer=this.transmuxer||new ea(this.hls,j.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),g=s?s.index:-1,m=g!==-1,p=new Hr(r.level,r.sn,r.stats.chunkCount,i.byteLength,g,m),y=this.initPTS[r.cc];f.push(i,c,u,h,r,s,l.totalduration,d,p,y)}onAudioTrackSwitching(t,e){const r=this.altAudio;if(!e.url){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const i=this.fragCurrent;i&&(this.log("Switching to main audio track, cancel main fragment load"),i.abortRequests(),this.fragmentTracker.removeFragment(i)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();const s=this.hls;r&&(s.trigger(v.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null}),this.fragmentTracker.removeAllFragments()),s.trigger(v.AUDIO_TRACK_SWITCHED,e)}}onAudioTrackSwitched(t,e){const r=e.id,s=!!this.hls.audioTracks[r].url;if(s){const i=this.videoBuffer;i&&this.mediaBuffer!==i&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=i)}this.altAudio=s,this.tick()}onBufferCreated(t,e){const r=e.tracks;let s,i,n=!1;for(const o in r){const l=r[o];if(l.id==="main"){if(i=o,s=l,o==="video"){const h=r[o];h&&(this.videoBuffer=h.buffer)}}else n=!0}n&&s?(this.log(`Alternate track found, use ${i}.buffered to schedule main fragment loading`),this.mediaBuffer=s.buffer):this.mediaBuffer=this.media}onFragBuffered(t,e){const{frag:r,part:s}=e;if(r&&r.type!==j.MAIN)return;if(this.fragContextChanged(r)){this.warn(`Fragment ${r.sn}${s?" p: "+s.index:""} of level ${r.level} finished buffering, but was aborted. state: ${this.state}`),this.state===P.PARSED&&(this.state=P.IDLE);return}const i=s?s.stats:r.stats;this.fragLastKbps=Math.round(8*i.total/(i.buffering.end-i.loading.first)),r.sn!=="initSegment"&&(this.fragPrevious=r),this.fragBufferedComplete(r,s)}onError(t,e){var r;if(e.fatal){this.state=P.ERROR;return}switch(e.details){case b.FRAG_GAP:case b.FRAG_PARSING_ERROR:case b.FRAG_DECRYPT_ERROR:case b.FRAG_LOAD_ERROR:case b.FRAG_LOAD_TIMEOUT:case b.KEY_LOAD_ERROR:case b.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(j.MAIN,e);break;case b.LEVEL_LOAD_ERROR:case b.LEVEL_LOAD_TIMEOUT:case b.LEVEL_PARSING_ERROR:!e.levelRetry&&this.state===P.WAITING_LEVEL&&((r=e.context)==null?void 0:r.type)===Y.LEVEL&&(this.state=P.IDLE);break;case b.BUFFER_APPEND_ERROR:case b.BUFFER_FULL_ERROR:if(!e.parent||e.parent!=="main")return;if(e.details===b.BUFFER_APPEND_ERROR){this.resetLoadingState();return}this.reduceLengthAndFlushBuffer(e)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case b.INTERNAL_EXCEPTION:this.recoverWorkerError(e);break}}checkBuffer(){const{media:t,gapController:e}=this;if(!(!t||!e||!t.readyState)){if(this.loadedmetadata||!X.getBuffered(t).length){const r=this.state!==P.IDLE?this.fragCurrent:null;e.poll(this.lastCurrentTime,r)}this.lastCurrentTime=t.currentTime}}onFragLoadEmergencyAborted(){this.state=P.IDLE,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()}onBufferFlushed(t,{type:e}){if(e!==z.AUDIO||this.audioOnly&&!this.altAudio){const r=(e===z.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(r,e,j.MAIN),this.tick()}}onLevelsUpdated(t,e){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level),this.levels=e.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media:t}=this;if(!t)return;const e=t.currentTime;let r=this.startPosition;if(r>=0&&e<r){if(t.seeking){this.log(`could not seek to ${r}, already seeking at ${e}`);return}const s=X.getBuffered(t),i=(s.length?s.start(0):0)-r;i>0&&(i<this.config.maxBufferHole||i<this.config.maxFragLookUpTolerance)&&(this.log(`adjusting start position by ${i} to match buffer start`),r+=i,this.startPosition=r),this.log(`seek to target start position ${r} from current time ${e}`),t.currentTime=r}}_getAudioCodec(t){let e=this.config.defaultAudioCodec||t.audioCodec;return this.audioCodecSwap&&e&&(this.log("Swapping audio codec"),e.indexOf("mp4a.40.5")!==-1?e="mp4a.40.2":e="mp4a.40.5"),e}_loadBitrateTestFrag(t,e){t.bitrateTest=!0,this._doFragLoad(t,e).then(r=>{const{hls:s}=this;if(!r||this.fragContextChanged(t))return;e.fragmentError=0,this.state=P.IDLE,this.startFragRequested=!1,this.bitrateTest=!1;const i=t.stats;i.parsing.start=i.parsing.end=i.buffering.start=i.buffering.end=self.performance.now(),s.trigger(v.FRAG_LOADED,r),t.bitrateTest=!1})}_handleTransmuxComplete(t){var e;const r="main",{hls:s}=this,{remuxResult:i,chunkMeta:n}=t,o=this.getCurrentContext(n);if(!o){this.resetWhenMissingContext(n);return}const{frag:l,part:h,level:d}=o,{video:c,text:u,id3:f,initSegment:g}=i,{details:m}=d,p=this.altAudio?void 0:i.audio;if(this.fragContextChanged(l)){this.fragmentTracker.removeFragment(l);return}if(this.state=P.PARSING,g){if(g!=null&&g.tracks){const A=l.initSegment||l;this._bufferInitSegment(d,g.tracks,A,n),s.trigger(v.FRAG_PARSING_INIT_SEGMENT,{frag:A,id:r,tracks:g.tracks})}const y=g.initPTS,T=g.timescale;M(y)&&(this.initPTS[l.cc]={baseTime:y,timescale:T},s.trigger(v.INIT_PTS_FOUND,{frag:l,id:r,initPTS:y,timescale:T}))}if(c&&m&&l.sn!=="initSegment"){const y=m.fragments[l.sn-1-m.startSN],T=l.sn===m.startSN,A=!y||l.cc>y.cc;if(i.independent!==!1){const{startPTS:R,endPTS:L,startDTS:D,endDTS:I}=c;if(h)h.elementaryStreams[c.type]={startPTS:R,endPTS:L,startDTS:D,endDTS:I};else if(c.firstKeyFrame&&c.independent&&n.id===1&&!A&&(this.couldBacktrack=!0),c.dropped&&c.independent){const C=this.getMainFwdBufferInfo(),w=(C?C.end:this.getLoadPosition())+this.config.maxBufferHole,O=c.firstKeyFramePTS?c.firstKeyFramePTS:R;if(!T&&w<O-this.config.maxBufferHole&&!A){this.backtrack(l);return}else A&&(l.gap=!0);l.setElementaryStreamInfo(c.type,l.start,L,l.start,I,!0)}else T&&R>Gt&&(l.gap=!0);l.setElementaryStreamInfo(c.type,R,L,D,I),this.backtrackFragment&&(this.backtrackFragment=l),this.bufferFragmentData(c,l,h,n,T||A)}else if(T||A)l.gap=!0;else{this.backtrack(l);return}}if(p){const{startPTS:y,endPTS:T,startDTS:A,endDTS:R}=p;h&&(h.elementaryStreams[z.AUDIO]={startPTS:y,endPTS:T,startDTS:A,endDTS:R}),l.setElementaryStreamInfo(z.AUDIO,y,T,A,R),this.bufferFragmentData(p,l,h,n)}if(m&&f!=null&&(e=f.samples)!=null&&e.length){const y={id:r,frag:l,details:m,samples:f.samples};s.trigger(v.FRAG_PARSING_METADATA,y)}if(m&&u){const y={id:r,frag:l,details:m,samples:u.samples};s.trigger(v.FRAG_PARSING_USERDATA,y)}}_bufferInitSegment(t,e,r,s){if(this.state!==P.PARSING)return;this.audioOnly=!!e.audio&&!e.video,this.altAudio&&!this.audioOnly&&delete e.audio;const{audio:i,video:n,audiovideo:o}=e;if(i){let l=t.audioCodec;const h=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){l&&(l.indexOf("mp4a.40.5")!==-1?l="mp4a.40.2":l="mp4a.40.5");const d=i.metadata;d&&"channelCount"in d&&(d.channelCount||1)!==1&&h.indexOf("firefox")===-1&&(l="mp4a.40.5")}l&&l.indexOf("mp4a.40.5")!==-1&&h.indexOf("android")!==-1&&i.container!=="audio/mpeg"&&(l="mp4a.40.2",this.log(`Android: force audio codec to ${l}`)),t.audioCodec&&t.audioCodec!==l&&this.log(`Swapping manifest audio codec "${t.audioCodec}" for "${l}"`),i.levelCodec=l,i.id="main",this.log(`Init audio buffer, container:${i.container}, codecs[selected/level/parsed]=[${l||""}/${t.audioCodec||""}/${i.codec}]`)}n&&(n.levelCodec=t.videoCodec,n.id="main",this.log(`Init video buffer, container:${n.container}, codecs[level/parsed]=[${t.videoCodec||""}/${n.codec}]`)),o&&this.log(`Init audiovideo buffer, container:${o.container}, codecs[level/parsed]=[${t.codecs}/${o.codec}]`),this.hls.trigger(v.BUFFER_CODECS,e),Object.keys(e).forEach(l=>{const h=e[l].initSegment;h!=null&&h.byteLength&&this.hls.trigger(v.BUFFER_APPENDING,{type:l,data:h,frag:r,part:null,chunkMeta:s,parent:r.type})}),this.tickImmediate()}getMainFwdBufferInfo(){return this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,j.MAIN)}backtrack(t){this.couldBacktrack=!0,this.backtrackFragment=t,this.resetTransmuxer(),this.flushBufferGap(t),this.fragmentTracker.removeFragment(t),this.fragPrevious=null,this.nextLoadPosition=t.start,this.state=P.IDLE}checkFragmentChanged(){const t=this.media;let e=null;if(t&&t.readyState>1&&t.seeking===!1){const r=t.currentTime;if(X.isBuffered(t,r)?e=this.getAppendedFrag(r):X.isBuffered(t,r+.1)&&(e=this.getAppendedFrag(r+.1)),e){this.backtrackFragment=null;const s=this.fragPlaying,i=e.level;(!s||e.sn!==s.sn||s.level!==i)&&(this.fragPlaying=e,this.hls.trigger(v.FRAG_CHANGED,{frag:e}),(!s||s.level!==i)&&this.hls.trigger(v.LEVEL_SWITCHED,{level:i}))}}}get nextLevel(){const t=this.nextBufferedFrag;return t?t.level:-1}get currentFrag(){const t=this.media;return t?this.fragPlaying||this.getAppendedFrag(t.currentTime):null}get currentProgramDateTime(){const t=this.media;if(t){const e=t.currentTime,r=this.currentFrag;if(r&&M(e)&&M(r.programDateTime)){const s=r.programDateTime+(e-r.start)*1e3;return new Date(s)}}return null}get currentLevel(){const t=this.currentFrag;return t?t.level:-1}get nextBufferedFrag(){const t=this.currentFrag;return t?this.followingBufferedFrag(t):null}get forceStartLoad(){return this._forceStartLoad}}class kt{static get version(){return"1.5.11"}static isMSESupported(){return Wr()}static isSupported(){return vn()}static getMediaSource(){return At()}static get Events(){return v}static get ErrorTypes(){return G}static get ErrorDetails(){return b}static get DefaultConfig(){return kt.defaultConfig?kt.defaultConfig:Gr}static set DefaultConfig(t){kt.defaultConfig=t}constructor(t={}){this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this.started=!1,this._emitter=new ns,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null,this.triggeringException=void 0,fs(t.debug||!1,"Hls instance");const e=this.config=Qi(kt.DefaultConfig,t);this.userConfig=t,e.progressive&&Ji(e);const{abrController:r,bufferController:s,capLevelController:i,errorController:n,fpsController:o}=e,l=new n(this),h=this.abrController=new r(this),d=this.bufferController=new s(this),c=this.capLevelController=new i(this),u=new o(this),f=new Zs(this),g=new oi(this),m=e.contentSteeringController,p=m?new m(this):null,y=this.levelController=new Zi(this,p),T=new tn(this),A=new rn(this.config),R=this.streamController=new oa(this,T,A);c.setStreamController(R),u.setStreamController(R);const L=[f,y,R];p&&L.splice(1,0,p),this.networkControllers=L;const D=[h,d,c,u,g,T];this.audioTrackController=this.createController(e.audioTrackController,L);const I=e.audioStreamController;I&&L.push(new I(this,T,A)),this.subtitleTrackController=this.createController(e.subtitleTrackController,L);const C=e.subtitleStreamController;C&&L.push(new C(this,T,A)),this.createController(e.timelineController,D),A.emeController=this.emeController=this.createController(e.emeController,D),this.cmcdController=this.createController(e.cmcdController,D),this.latencyController=this.createController(li,D),this.coreComponents=D,L.push(l);const w=l.onErrorOut;typeof w=="function"&&this.on(v.ERROR,w,l)}createController(t,e){if(t){const r=new t(this);return e&&e.push(r),r}return null}on(t,e,r=this){this._emitter.on(t,e,r)}once(t,e,r=this){this._emitter.once(t,e,r)}removeAllListeners(t){this._emitter.removeAllListeners(t)}off(t,e,r=this,s){this._emitter.off(t,e,r,s)}listeners(t){return this._emitter.listeners(t)}emit(t,e,r){return this._emitter.emit(t,e,r)}trigger(t,e){if(this.config.debug)return this.emit(t,t,e);try{return this.emit(t,t,e)}catch(r){if(S.error("An internal error happened while handling event "+t+'. Error message: "'+r.message+'". Here is a stacktrace:',r),!this.triggeringException){this.triggeringException=!0;const s=t===v.ERROR;this.trigger(v.ERROR,{type:G.OTHER_ERROR,details:b.INTERNAL_EXCEPTION,fatal:s,event:t,error:r}),this.triggeringException=!1}}return!1}listenerCount(t){return this._emitter.listenerCount(t)}destroy(){S.log("destroy"),this.trigger(v.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach(e=>e.destroy()),this.networkControllers.length=0,this.coreComponents.forEach(e=>e.destroy()),this.coreComponents.length=0;const t=this.config;t.xhrSetup=t.fetchSetup=void 0,this.userConfig=null}attachMedia(t){S.log("attachMedia"),this._media=t,this.trigger(v.MEDIA_ATTACHING,{media:t})}detachMedia(){S.log("detachMedia"),this.trigger(v.MEDIA_DETACHING,void 0),this._media=null}loadSource(t){this.stopLoad();const e=this.media,r=this.url,s=this.url=Re.buildAbsoluteURL(self.location.href,t,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,S.log(`loadSource:${s}`),e&&r&&(r!==s||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(e)),this.trigger(v.MANIFEST_LOADING,{url:t})}startLoad(t=-1){S.log(`startLoad(${t})`),this.started=!0,this.networkControllers.forEach(e=>{e.startLoad(t)})}stopLoad(){S.log("stopLoad"),this.started=!1,this.networkControllers.forEach(t=>{t.stopLoad()})}resumeBuffering(){this.started&&this.networkControllers.forEach(t=>{"fragmentLoader"in t&&t.startLoad(-1)})}pauseBuffering(){this.networkControllers.forEach(t=>{"fragmentLoader"in t&&t.stopLoad()})}swapAudioCodec(){S.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){S.log("recoverMediaError");const t=this._media;this.detachMedia(),t&&this.attachMedia(t)}removeLevel(t){this.levelController.removeLevel(t)}get levels(){return this.levelController.levels||[]}get currentLevel(){return this.streamController.currentLevel}set currentLevel(t){S.log(`set currentLevel:${t}`),this.levelController.manualLevel=t,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(t){S.log(`set nextLevel:${t}`),this.levelController.manualLevel=t,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(t){S.log(`set loadLevel:${t}`),this.levelController.manualLevel=t}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(t){this.levelController.nextLoadLevel=t}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(t){S.log(`set firstLevel:${t}`),this.levelController.firstLevel=t}get startLevel(){const t=this.levelController.startLevel;return t===-1&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:t}set startLevel(t){S.log(`set startLevel:${t}`),t!==-1&&(t=Math.max(t,this.minAutoLevel)),this.levelController.startLevel=t}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(t){const e=!!t;e!==this.config.capLevelToPlayerSize&&(e?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=e)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator:t}=this.abrController;return t?t.getEstimate():NaN}set bandwidthEstimate(t){this.abrController.resetEstimator(t)}get ttfbEstimate(){const{bwEstimator:t}=this.abrController;return t?t.getEstimateTTFB():NaN}set autoLevelCapping(t){this._autoLevelCapping!==t&&(S.log(`set autoLevelCapping:${t}`),this._autoLevelCapping=t,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(t){hi(t)&&this._maxHdcpLevel!==t&&(this._maxHdcpLevel=t,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return this.levelController.manualLevel===-1}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels:t,config:{minAutoBitrate:e}}=this;if(!t)return 0;const r=t.length;for(let s=0;s<r;s++)if(t[s].maxBitrate>=e)return s;return 0}get maxAutoLevel(){const{levels:t,autoLevelCapping:e,maxHdcpLevel:r}=this;let s;if(e===-1&&t!=null&&t.length?s=t.length-1:s=e,r)for(let i=s;i--;){const n=t[i].attrs["HDCP-LEVEL"];if(n&&n<=r)return i}return s}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(t){this.abrController.nextAutoLevel=t}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}setAudioOption(t){var e;return(e=this.audioTrackController)==null?void 0:e.setAudioOption(t)}setSubtitleOption(t){var e;return(e=this.subtitleTrackController)==null||e.setSubtitleOption(t),null}get allAudioTracks(){const t=this.audioTrackController;return t?t.allAudioTracks:[]}get audioTracks(){const t=this.audioTrackController;return t?t.audioTracks:[]}get audioTrack(){const t=this.audioTrackController;return t?t.audioTrack:-1}set audioTrack(t){const e=this.audioTrackController;e&&(e.audioTrack=t)}get allSubtitleTracks(){const t=this.subtitleTrackController;return t?t.allSubtitleTracks:[]}get subtitleTracks(){const t=this.subtitleTrackController;return t?t.subtitleTracks:[]}get subtitleTrack(){const t=this.subtitleTrackController;return t?t.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(t){const e=this.subtitleTrackController;e&&(e.subtitleTrack=t)}get subtitleDisplay(){const t=this.subtitleTrackController;return t?t.subtitleDisplay:!1}set subtitleDisplay(t){const e=this.subtitleTrackController;e&&(e.subtitleDisplay=t)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(t){this.config.lowLatencyMode=t}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}}kt.defaultConfig=void 0;Pt.KeySystemFormats;Pt.KeySystems;Pt.SubtitleStreamController;Pt.TimelineController;export{wi as AbrController,Q as AttrList,Es as AudioStreamController,Es as AudioTrackController,Ri as BasePlaylistController,Lr as BaseSegment,pn as BaseStreamController,Fi as BufferController,Es as CMCDController,ke as CapLevelController,Hr as ChunkMetadata,Bi as ContentSteeringController,Er as DateRange,Es as EMEController,ot as ErrorActionFlags,Ai as ErrorController,b as ErrorDetails,G as ErrorTypes,v as Events,Mi as FPSController,ee as Fragment,kt as Hls,Bt as HlsSkip,Qe as HlsUrlParameters,Le as Level,Ts as LevelDetails,De as LevelKey,Jt as LoadStats,ht as MetadataSchema,et as NetworkErrorAction,vs as Part,j as PlaylistLevelType,Es as SubtitleTrackController,kt as default,At as getMediaSource,Wr as isMSESupported,vn as isSupported};
